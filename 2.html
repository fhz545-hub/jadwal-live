<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
<title>الجدول اللحظي — V3 (عصري + توقيت + تصدير)</title>

<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800;900&family=Cairo:wght@700;800;900&display=swap" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
/* =========================
   TOKENS (LIGHT default)
   ========================= */
:root{
  --bg0:#f2fbff;
  --bg1:#ffffff;

  --glass: rgba(255,255,255,.72);
  --glass2: rgba(255,255,255,.88);
  --line: rgba(14,45,60,.12);

  --text: rgba(12,35,48,.92);
  --muted: rgba(12,35,48,.70);
  --muted2: rgba(12,35,48,.55);

  --shadow: 0 18px 60px rgba(12,35,48,.12);
  --shadow2: 0 10px 30px rgba(12,35,48,.10);

  --moe:#19c59b;
  --moe2:#29a6ff;

  --first:#00d1c1;
  --second:#8df25a;
  --third:#58a6ff;

  --danger:#ff5b5b;
  --warn:#ffd24a;
  --ok:#53ffb0;

  --radius: 22px;
  --tileMin: 260px;
  --tileH: 175px;
  --gap: 14px;

  --topH: 86px;
  --toolsH: 74px;
}

/* =========================
   DARK
   ========================= */
:root[data-theme="dark"]{
  --bg0:#070b12;
  --bg1:#0a1220;

  --glass: rgba(255,255,255,.08);
  --glass2: rgba(255,255,255,.10);
  --line: rgba(255,255,255,.12);

  --text: rgba(255,255,255,.92);
  --muted: rgba(255,255,255,.70);
  --muted2: rgba(255,255,255,.55);

  --shadow: 0 18px 60px rgba(0,0,0,.45);
  --shadow2: 0 10px 30px rgba(0,0,0,.35);
}

*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:"Tajawal",system-ui,sans-serif;
  color:var(--text);
  background:
    radial-gradient(1000px 560px at 10% 0%, rgba(41,166,255,.18) 0%, rgba(41,166,255,0) 62%),
    radial-gradient(900px 520px at 85% 15%, rgba(25,197,155,.16) 0%, rgba(25,197,155,0) 60%),
    radial-gradient(900px 560px at 50% 100%, rgba(255,210,74,.14) 0%, rgba(255,210,74,0) 55%),
    linear-gradient(180deg, var(--bg0), var(--bg1));
  overflow-x:hidden;
}

/* ===== TOP ===== */
.top{
  position:sticky; top:0; z-index:90;
  height:var(--topH);
  display:flex; align-items:center;
  backdrop-filter: blur(14px);
  background: linear-gradient(180deg, var(--glass2), var(--glass));
  border-bottom:1px solid var(--line);
}
.top .wrap{
  width:min(1780px, 100%);
  margin:0 auto;
  padding:10px 14px;
  display:flex; gap:14px; align-items:center; justify-content:space-between;
}
.brand{display:flex; align-items:center; gap:12px; min-width: 280px;}
.logoDot{
  width:16px;height:16px;border-radius:999px;
  background: linear-gradient(180deg, var(--moe), var(--moe2));
  box-shadow: 0 0 0 7px rgba(25,197,155,.12), 0 0 30px rgba(41,166,255,.22);
}
.brand h1{margin:0;font-family:"Cairo";font-size:18px;font-weight:900;}
.brand .sub{margin-top:3px;font-size:12px;color:var(--muted2);font-weight:900}

.pills{display:flex; gap:10px; flex-wrap:wrap; justify-content:center; align-items:center}
.pill{
  display:inline-flex; align-items:center; gap:8px;
  padding:9px 12px;
  border-radius:999px;
  border:1px solid var(--line);
  background: var(--glass);
  box-shadow: var(--shadow2);
  font-weight:900;
  color:var(--text);
  white-space:nowrap;
  font-size:12px;
}
.pill b{font-family:"Cairo"; font-size:13px}

.clock{display:flex; align-items:center; gap:10px; min-width: 260px; justify-content:flex-end;}
.time{
  font-family:"Cairo"; font-weight:900; font-size:26px; letter-spacing:.6px;
  padding:9px 14px; border-radius:18px;
  background: linear-gradient(180deg, var(--glass2), var(--glass));
  border:1px solid var(--line);
  box-shadow: var(--shadow2);
}

/* TOP PROGRESS */
.pProgress{display:flex; align-items:center; gap:10px}
.bar{
  width:180px; height:10px; border-radius:999px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.05);
  overflow:hidden;
}
:root[data-theme="dark"] .bar{background: rgba(255,255,255,.06)}
.bar > i{
  display:block; height:100%; width:0%;
  background: linear-gradient(90deg, var(--moe2), var(--moe));
  border-radius:999px;
}
.pProgress .txt{
  font-family:"Cairo"; font-weight:900; font-size:12px; color:var(--muted);
  white-space:nowrap;
}

/* ===== TOOLS (always visible unless projector) ===== */
.tools{
  position:sticky; top:var(--topH); z-index:85;
  background: var(--glass);
  border-bottom:1px solid var(--line);
  backdrop-filter: blur(14px);
}
.tools .wrap{
  width:min(1780px, 100%);
  margin:0 auto;
  padding:10px 14px;
  display:flex; gap:10px; align-items:center; justify-content:space-between;
  flex-wrap:wrap;
}
.group{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

/* Nice buttons */
.btn{
  display:inline-flex; align-items:center; justify-content:center; gap:8px;
  padding:11px 13px;
  border-radius:999px;
  border:1px solid var(--line);
  background: var(--glass);
  color:var(--text);
  font-weight:1000;
  cursor:pointer;
  transition:.15s;
  user-select:none;
}
.btn:hover{transform: translateY(-1px); background: var(--glass2)}
.btn:active{transform: translateY(0)}
.btn.primary{
  border-color: rgba(25,197,155,.38);
  background: linear-gradient(180deg, rgba(25,197,155,.22), rgba(255,255,255,.06));
}
.btn.danger{
  border-color: rgba(255,91,91,.45);
  background: linear-gradient(180deg, rgba(255,91,91,.18), rgba(255,255,255,.06));
}
.btn.ghost{background: rgba(0,0,0,.03)}
:root[data-theme="dark"] .btn.ghost{background: rgba(255,255,255,.06)}

.field{
  display:flex; align-items:center; gap:8px;
  padding:8px 10px;
  border-radius:16px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.58);
}
:root[data-theme="dark"] .field{background: rgba(0,0,0,.18)}
.field label{font-size:12px; font-weight:1000; color:var(--muted)}
.field input[type="range"]{width:170px}
.field input[type="text"], .field select{
  border:1px solid var(--line);
  background: var(--glass2);
  color:var(--text);
  border-radius:14px;
  padding:10px 12px;
  font-family:"Tajawal";
  font-weight:900;
  outline:none;
  min-width:220px;
}
.field select{min-width:170px}
.smallhint{font-size:12px; font-weight:900; color:var(--muted2)}

/* ===== content ===== */
main{
  width:min(1780px, 100%);
  margin:0 auto;
  padding:14px 14px 118px;
}

/* stage cards */
.stageCard{
  border-radius: var(--radius);
  border:1px solid var(--line);
  background: linear-gradient(180deg, var(--glass2), var(--glass));
  box-shadow: var(--shadow);
  overflow:hidden;
  margin-bottom:14px;
}
:root[data-theme="dark"] .stageCard{
  background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
  border-color: rgba(255,255,255,.12);
}
.stageHead{
  padding:12px 12px;
  display:flex; align-items:center; justify-content:space-between; gap:12px;
  border-bottom:1px solid var(--line);
}
:root[data-theme="dark"] .stageHead{border-bottom:1px solid rgba(255,255,255,.08)}
.stageHead .left{display:flex; align-items:center; gap:10px}
.dot{width:12px;height:12px;border-radius:999px; box-shadow:0 0 0 6px rgba(255,255,255,.06);}
.stageHead h2{margin:0;font-size:15px;font-weight:1000;}
.meta{
  display:inline-flex; gap:8px; align-items:center;
  padding:7px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.03);
  font-weight:900; color:var(--muted); font-size:12px; white-space:nowrap;
}
:root[data-theme="dark"] .meta{background: rgba(0,0,0,.16);border-color: rgba(255,255,255,.12);}

/* grid */
.grid{display:grid; gap:var(--gap); padding:12px; grid-template-columns: repeat(auto-fit, minmax(var(--tileMin), 1fr));}

/* tile */
.tile{
  position:relative;
  min-height: var(--tileH);
  border-radius: 20px;
  border:1px solid var(--line);
  background:
    radial-gradient(320px 210px at 25% 20%, rgba(255,255,255,.22) 0%, rgba(255,255,255,0) 65%),
    linear-gradient(180deg, var(--glass2), var(--glass));
  box-shadow: var(--shadow2);
  overflow:hidden;
  padding:12px;
  transition:.15s;
}
:root[data-theme="dark"] .tile{
  border-color: rgba(255,255,255,.14);
  background:
    radial-gradient(300px 200px at 25% 20%, rgba(255,255,255,.10) 0%, rgba(255,255,255,0) 65%),
    linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
}
.tile:hover{transform: translateY(-2px)}
.tile.now{outline:2px solid rgba(25,197,155,.55)}
.tile.absent{outline:2px solid rgba(255,91,91,.55)}
.bandFirst .tile{border-top:5px solid rgba(0,209,193,.9)}
.bandSecond .tile{border-top:5px solid rgba(141,242,90,.85)}
.bandThird .tile{border-top:5px solid rgba(88,166,255,.85)}

.badge{
  position:absolute; top:10px; left:10px;
  padding:5px 10px;
  border-radius:999px;
  border:1px solid var(--line);
  background: rgba(255,255,255,.62);
  font-weight:1000;
  font-size:11px;
  color:var(--muted);
}
:root[data-theme="dark"] .badge{background: rgba(0,0,0,.18);border-color: rgba(255,255,255,.14);}
.actions{position:absolute; top:10px; right:10px; display:flex; gap:8px;}
.miniBtn{
  border:1px solid var(--line);
  background: rgba(255,255,255,.62);
  color:var(--text);
  border-radius:999px;
  padding:6px 10px;
  font-size:11px;
  font-weight:1000;
  cursor:pointer;
}
:root[data-theme="dark"] .miniBtn{border-color: rgba(255,255,255,.14);background: rgba(255,255,255,.06);}
.miniBtn:hover{background: var(--glass2)}

.content{
  height:100%;
  display:flex; flex-direction:column; justify-content:center; align-items:center;
  gap:8px; text-align:center; padding-top:14px;
}
.className{font-weight:1000;color:var(--text);font-size:14px;}
.subject{font-family:"Cairo";font-weight:900;font-size:20px;line-height:1.2;}
.teacher{font-weight:900;color:var(--muted);font-size:13px;}
.state{position:absolute;bottom:10px;left:10px;font-weight:900;color:var(--muted2);font-size:11px;}
.empty{color:var(--muted)}

/* duty */
.duty{
  margin-top:14px;
  border-radius: var(--radius);
  border:1px solid var(--line);
  background: linear-gradient(180deg, var(--glass2), var(--glass));
  box-shadow: var(--shadow);
  overflow:hidden;
}
:root[data-theme="dark"] .duty{
  border-color: rgba(255,255,255,.12);
  background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
}
.dutyHead{
  padding:12px;
  display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
  border-bottom:1px solid var(--line);
}
:root[data-theme="dark"] .dutyHead{border-bottom:1px solid rgba(255,255,255,.08)}
.dutyHead h3{margin:0;font-size:14px;font-weight:1000}
.dutyList{padding:12px; display:grid; gap:10px; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));}
.dutyRow{
  border:1px solid var(--line);
  background: rgba(255,255,255,.62);
  border-radius:18px;
  padding:10px;
  display:flex; align-items:center; gap:10px;
}
:root[data-theme="dark"] .dutyRow{border-color: rgba(255,255,255,.12);background: rgba(0,0,0,.16);}
.dutyRow input{
  flex:1;
  border:1px solid var(--line);
  background: var(--glass2);
  color:var(--text);
  border-radius:14px;
  padding:10px 12px;
  outline:none;
  font-weight:900;
  font-family:"Tajawal";
}
.dutyRow .x{padding:8px 10px;border-radius:999px;border:1px solid rgba(255,91,91,.45);background:rgba(255,91,91,.12);cursor:pointer;font-weight:1000}

/* modal */
.modalBack{
  position:fixed; inset:0; z-index:200;
  background: rgba(12,35,48,.25);
  backdrop-filter: blur(10px);
  display:none; align-items:center; justify-content:center;
  padding:14px;
}
:root[data-theme="dark"] .modalBack{background: rgba(0,0,0,.55)}
.modalBack.open{display:flex}
.modal{
  width:min(900px, 96vw);
  border-radius: 26px;
  border:1px solid var(--line);
  background: linear-gradient(180deg, rgba(255,255,255,.95), rgba(242,251,255,.92));
  box-shadow: 0 30px 100px rgba(12,35,48,.18);
  overflow:hidden;
}
:root[data-theme="dark"] .modal{
  border-color: rgba(255,255,255,.14);
  background: linear-gradient(180deg, rgba(20,28,45,.92), rgba(10,18,32,.86));
  box-shadow: 0 30px 100px rgba(0,0,0,.55);
}
.modalHead{
  padding:14px;
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  border-bottom:1px solid var(--line);
}
:root[data-theme="dark"] .modalHead{border-bottom:1px solid rgba(255,255,255,.10)}
.modalHead b{font-size:14px;font-weight:1000}
.modalBody{padding:14px}
.modalGrid{
  display:grid; gap:10px;
  grid-template-columns: 1fr 1fr;
}
.modalGrid input, .modalGrid select{
  border:1px solid var(--line);
  background: var(--glass2);
  color:var(--text);
  border-radius:16px;
  padding:12px;
  outline:none;
  font-family:"Tajawal";
  font-weight:900;
}
.modalFoot{
  padding:14px;
  display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
  border-top:1px solid var(--line);
}
:root[data-theme="dark"] .modalFoot{border-top:1px solid rgba(255,255,255,.10)}

/* Projector */
body.projector .tools{display:none}
body.projector .top{position:fixed; left:0; right:0; top:0}
body.projector main{padding-top: calc(var(--topH) + 12px)}
body.projector{--tileMin: 320px; --tileH: 200px; --gap: 16px}
body.projector .badge, body.projector .actions{display:none}
body.projector .subject{font-size:22px}

/* footer */
.footer{
  position:fixed; left:0; right:0; bottom:0; z-index:95;
  border-top:1px solid var(--line);
  background: rgba(255,255,255,.75);
  backdrop-filter: blur(10px);
}
:root[data-theme="dark"] .footer{background: rgba(0,0,0,.22);border-top:1px solid rgba(255,255,255,.10)}
.footer .wrap{
  width:min(1780px, 100%);
  margin:0 auto;
  padding:10px 14px;
  display:flex; justify-content:center;
  color:var(--muted2);
  font-weight:900;
  font-size:12px;
}

/* Floating progress */
.floatProg{
  position:fixed; left:18px; bottom:86px;
  z-index:120;
  width: min(420px, calc(100vw - 36px));
  border-radius: 22px;
  border:1px solid var(--line);
  background: linear-gradient(180deg, var(--glass2), var(--glass));
  box-shadow: var(--shadow);
  overflow:hidden;
  user-select:none;
  touch-action:none;
}
:root[data-theme="dark"] .floatProg{
  border-color: rgba(255,255,255,.14);
  background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
}
.floatProg .head{
  display:flex; align-items:center; justify-content:space-between; gap:10px;
  padding:10px 12px;
  border-bottom:1px solid var(--line);
}
:root[data-theme="dark"] .floatProg .head{border-bottom:1px solid rgba(255,255,255,.10)}
.floatProg .head b{font-size:13px; font-weight:1000}
.fpBtn{
  border:1px solid var(--line);
  background: rgba(255,255,255,.75);
  border-radius:999px;
  padding:6px 10px;
  font-size:11px;
  font-weight:1000;
  cursor:pointer;
}
:root[data-theme="dark"] .fpBtn{border-color: rgba(255,255,255,.14);background: rgba(255,255,255,.08)}
.fpBtn:hover{background: var(--glass2)}
.floatProg .body{padding:10px 12px 12px; display:grid; gap:10px}
.fpRow{display:flex; align-items:center; justify-content:space-between; gap:10px; color:var(--muted); font-weight:900; font-size:12px}
.fpBig{font-family:"Cairo"; font-weight:900; color:var(--text)}
.fpBar{
  height:12px; border-radius:999px;
  border:1px solid var(--line);
  background: rgba(0,0,0,.05);
  overflow:hidden;
}
:root[data-theme="dark"] .fpBar{background: rgba(255,255,255,.06)}
.fpBar i{
  display:block; height:100%; width:0%;
  background: linear-gradient(90deg, var(--moe2), var(--moe));
  border-radius:999px;
}
.floatProg.locked{cursor:default}
.floatProg .hint{color:var(--muted2); font-size:11px; font-weight:900}
body.projector .floatProg{display:none}

@media (max-width:980px){
  .clock{min-width:auto}
  .time{font-size:22px}
  .bar{width:140px}
}
</style>
</head>

<body>

<!-- inputs -->
<input type="file" id="fileTable" accept=".xlsx,.xls,.xlsb,.csv" hidden>
<input type="file" id="filePhonebook" accept=".xlsx,.xls,.xlsb,.csv" hidden>
<input type="file" id="snapshotIn" accept=".json" hidden>

<header class="top">
  <div class="wrap">
    <div class="brand">
      <span class="logoDot"></span>
      <div>
        <h1>الجدول اللحظي — V3</h1>
        <div class="sub">تصميم عصري • توقيت قابل للتعديل • استيراد/تصدير • 17 شعبة</div>
      </div>
    </div>

    <div class="pills">
      <div class="pill" id="pDay">اليوم: <b>—</b></div>
      <div class="pill" id="pSlot">الحصة: <b>—</b></div>
      <div class="pill" id="pRange">الوقت: <b>—</b></div>

      <div class="pill pProgress">
        <div class="bar"><i id="topProgFill"></i></div>
        <div class="txt" id="topProgTxt">—</div>
      </div>
    </div>

    <div class="clock">
      <div class="time" id="clock">--:--:--</div>
    </div>
  </div>
</header>

<section class="tools" id="toolsBar">
  <div class="wrap">
    <div class="group">
      <button class="btn primary" id="btnImport">استيراد الجدول</button>
      <button class="btn ghost" id="btnTimesPreset">صيفي/شتوي</button>
      <button class="btn ghost" id="btnTimesEdit">تحرير التوقيت</button>

      <button class="btn ghost" id="btnPhone">دفتر المعلمين</button>
      <button class="btn ghost" id="btnSnapSave">حفظ JSON</button>
      <button class="btn ghost" id="btnSnapLoad">استعادة JSON</button>

      <button class="btn" id="btnTheme">المظهر: مشرق</button>
      <button class="btn" id="btnProjector">Projector</button>
      <button class="btn" id="btnFull">ملء الشاشة</button>

      <button class="btn" id="btnRefreshNow">تحديث الآن</button>
      <button class="btn ghost" id="btnExportPNG">تصدير PNG</button>
      <button class="btn ghost" id="btnExportPDF">تصدير PDF</button>
      <button class="btn danger" id="btnResetSafe">إعادة ضبط</button>
    </div>

    <div class="group">
      <div class="field">
        <label>حجم</label>
        <input id="zoomTiles" type="range" min="220" max="420" step="10" value="260">
        <span class="smallhint" id="zoomVal">260px</span>
      </div>

      <button class="btn" id="btnCompact">مضغوط</button>

      <div class="field">
        <label>بحث</label>
        <input id="q" type="text" placeholder="مادة / معلم / (أول-3) ...">
      </div>

      <div class="field">
        <label>عرض يدوي</label>
        <select id="manualDay">
          <option value="">تلقائي</option>
          <option>الأحد</option><option>الاثنين</option><option>الثلاثاء</option><option>الأربعاء</option><option>الخميس</option>
        </select>
        <select id="manualPeriod">
          <option value="">تلقائي</option>
          <option value="1">1</option><option value="2">2</option><option value="3">3</option>
          <option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option>
        </select>
      </div>

      <button class="btn danger" id="btnClearSearch">مسح</button>
    </div>
  </div>
</section>

<main id="captureRoot">
  <section class="stageCard bandFirst">
    <div class="stageHead">
      <div class="left">
        <span class="dot" style="background:var(--first)"></span>
        <h2>أول ثانوي</h2>
      </div>
      <div class="meta" id="m1">٧ شعب</div>
    </div>
    <div class="grid" id="g1"></div>
  </section>

  <section class="stageCard bandSecond">
    <div class="stageHead">
      <div class="left">
        <span class="dot" style="background:var(--second)"></span>
        <h2>ثاني ثانوي</h2>
      </div>
      <div class="meta" id="m2">٥ شعب</div>
    </div>
    <div class="grid" id="g2"></div>
  </section>

  <section class="stageCard bandThird">
    <div class="stageHead">
      <div class="left">
        <span class="dot" style="background:var(--third)"></span>
        <h2>ثالث ثانوي</h2>
      </div>
      <div class="meta" id="m3">٥ شعب</div>
    </div>
    <div class="grid" id="g3"></div>
  </section>

  <section class="duty">
    <div class="dutyHead">
      <h3>المناوبة / الإشراف لليوم</h3>
      <div class="group">
        <button class="btn primary" id="dutySuggest">اقتراح 7</button>
        <button class="btn" id="dutySave">حفظ</button>
        <button class="btn danger" id="dutyClear">مسح</button>
      </div>
    </div>
    <div class="dutyList" id="dutyList"></div>
  </section>
</main>

<footer class="footer">
  <div class="wrap">مبادرة اليعقوبي الثانوية — تنفيذ فهد حامد الزهراني</div>
</footer>

<!-- FLOATING PROGRESS -->
<div class="floatProg" id="floatProg">
  <div class="head" id="fpHandle">
    <b id="fpTitle">مؤشر الحصة</b>
    <div style="display:flex;gap:8px;align-items:center">
      <button class="fpBtn" id="fpLock">قفل</button>
      <button class="fpBtn" id="fpHide">إخفاء</button>
    </div>
  </div>
  <div class="body">
    <div class="fpRow"><div>الحصة/الوقت</div><div class="fpBig" id="fpSlot">—</div></div>
    <div class="fpBar"><i id="fpFill"></i></div>
    <div class="fpRow"><div>مضى</div><div class="fpBig" id="fpElapsed">—</div></div>
    <div class="fpRow"><div>المتبقي</div><div class="fpBig" id="fpRemain">—</div></div>
    <div class="hint" id="fpHint">اسحب المؤشر لمكان مناسب ثم اضغط "قفل" للتثبيت.</div>
  </div>
</div>

<!-- Modal -->
<div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
  <div class="modal">
    <div class="modalHead">
      <b id="modalTitle">—</b>
      <button class="btn danger" id="modalClose">إغلاق</button>
    </div>
    <div class="modalBody" id="modalBody"></div>
    <div class="modalFoot" id="modalFoot"></div>
  </div>
</div>

<datalist id="teachersList"></datalist>
<datalist id="subjectsList"></datalist>

<script>
/* ========= Helpers ========= */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const ls={
  get(k,d=null){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}},
  set(k,v){localStorage.setItem(k,JSON.stringify(v))},
  del(k){localStorage.removeItem(k)}
};
const toArabicDigits=s=>String(s).replace(/[0-9]/g,d=>'٠١٢٣٤٥٦٧٨٩'[d]);
const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));
const hijri=(d)=>{try{return new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{day:'2-digit',month:'long',year:'numeric'}).format(d)}catch{return ''}};
const fmtDate=(d)=>`${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()}`;
const dayName=(d)=>['الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'][d.getDay()];
const pad2=n=>String(n).padStart(2,'0');
const fmtMMSS=(sec)=>{
  sec=Math.max(0,sec|0);
  const m=(sec/60)|0, s=sec%60;
  return `${toArabicDigits(m)}د ${toArabicDigits(pad2(s))}ث`;
};

/* ========= Theme ========= */
function getTheme(){
  const t = ls.get('v3_theme','light');
  return (t==='dark' || t==='light') ? t : 'light';
}
function applyTheme(t){
  document.documentElement.dataset.theme = t;
  ls.set('v3_theme', t);
  $('#btnTheme').textContent = (t==='dark') ? 'المظهر: داكن' : 'المظهر: مشرق';
}
function toggleTheme(){ applyTheme(getTheme()==='dark'?'light':'dark'); }

/* ========= Data ========= */
const CLASSES={
  first:Array.from({length:7},(_,i)=>({grade:'أول',section:i+1,classId:`أول-${i+1}`})),
  second:Array.from({length:5},(_,i)=>({grade:'ثاني',section:i+1,classId:`ثاني-${i+1}`})),
  third:Array.from({length:5},(_,i)=>({grade:'ثالث',section:i+1,classId:`ثالث-${i+1}`}))
};

const PRESET_SUMMER={p1_s:'07:00',p1_e:'07:50',p2_s:'07:50',p2_e:'08:40',p3_s:'08:40',p3_e:'09:30',break_s:'09:30',break_e:'09:55',p4_s:'09:55',p4_e:'10:45',p5_s:'10:45',p5_e:'11:35',p6_s:'11:35',p6_e:'12:25',p7_s:'12:40',p7_e:'13:30',pr_s:'12:25',pr_e:'12:40'};
const PRESET_WINTER={p1_s:'07:15',p1_e:'08:05',p2_s:'08:05',p2_e:'08:55',p3_s:'08:55',p3_e:'09:45',break_s:'09:45',break_e:'10:10',p4_s:'10:10',p4_e:'11:00',p5_s:'11:00',p5_e:'11:50',p6_s:'11:50',p6_e:'12:40',p7_s:'12:55',p7_e:'13:45',pr_s:'12:40',pr_e:'12:55'};

let TIMES = ls.get('v3_times', PRESET_WINTER);
let TIMETABLE = ls.get('v3_table', []);
let TEACHERS = ls.get('v3_teachers', []);
let SUBJECTS = ls.get('v3_subjects', []);
let PHONEBOOK = ls.get('v3_phonebook', {});
let ABSENCES = ls.get('v3_abs', {});
let DUTY = ls.get('v3_duty', {});

let COMPACT = ls.get('v3_compact', false);
let PROJECTOR = ls.get('v3_projector', false);
let FILTER = '';

/* ========= Modal ========= */
function openModal(title, bodyHTML, footButtons=[]){
  $('#modalTitle').textContent=title;
  $('#modalBody').innerHTML=bodyHTML;
  const foot=$('#modalFoot'); foot.innerHTML='';
  footButtons.forEach(b=>foot.appendChild(b));
  $('#modalBack').classList.add('open');
}
function closeModal(){ $('#modalBack').classList.remove('open'); }
$('#modalClose').onclick=closeModal;
$('#modalBack').addEventListener('click',e=>{ if(e.target.id==='modalBack') closeModal(); });

/* ========= UI Settings ========= */
function setTileMin(px){
  px=clamp(px,220,420);
  document.documentElement.style.setProperty('--tileMin', px+'px');
  $('#zoomVal').textContent=px+'px';
  ls.set('v3_tileMin', px);
}
function applyCompact(){
  document.documentElement.style.setProperty('--tileH', COMPACT ? '150px' : '175px');
  document.documentElement.style.setProperty('--gap', COMPACT ? '12px' : '14px');
  $('#btnCompact').textContent = COMPACT ? 'عادي' : 'مضغوط';
  ls.set('v3_compact', COMPACT);
}
function applyProjector(){
  document.body.classList.toggle('projector', PROJECTOR);
  $('#btnProjector').textContent = PROJECTOR ? 'خروج Projector' : 'Projector';
  ls.set('v3_projector', PROJECTOR);
}
async function toggleFullscreen(){
  try{
    if(!document.fullscreenElement) await document.documentElement.requestFullscreen();
    else await document.exitFullscreen();
  }catch{ alert('تعذر ملء الشاشة في هذا المتصفح.'); }
}

/* ========= Datalists ========= */
function refreshLists(){
  $('#teachersList').innerHTML=[...new Set([...(TEACHERS||[]), ...Object.keys(PHONEBOOK||{})])]
    .sort((a,b)=>a.localeCompare(b,'ar')).map(n=>`<option value="${n}">`).join('');
  $('#subjectsList').innerHTML=(SUBJECTS||[])
    .sort((a,b)=>a.localeCompare(b,'ar')).map(n=>`<option value="${n}">`).join('');
}

/* ========= Time helpers ========= */
function hmToMin(s){const [H,M]=String(s||'0:0').split(':').map(Number);return (H||0)*60+(M||0);}
function hmToSec(s){const [H,M]=String(s||'0:0').split(':').map(Number);return ((H||0)*60+(M||0))*60;}
function inMinRange(now,s,e){const x=now.getHours()*60+now.getMinutes(); return x>=hmToMin(s)&&x<hmToMin(e); }
function timeRangeOfPeriod(p){return `${TIMES[`p${p}_s`]}–${TIMES[`p${p}_e`]}`;}
function currentPeriodAuto(day, now){
  for(let p=1;p<=7;p++){
    const s=TIMES[`p${p}_s`], e=TIMES[`p${p}_e`];
    if(s && e && inMinRange(now,s,e)) return p;
  }
  if(inMinRange(now,TIMES.break_s,TIMES.break_e)) return 'break';
  if(inMinRange(now,TIMES.pr_s,TIMES.pr_e)) return 'pr';
  return null;
}
function slotLabel(p){
  if(p==='break') return 'الفسحة';
  if(p==='pr') return 'الصلاة';
  if(!p) return '—';
  return `الحصة ${toArabicDigits(p)}`;
}
function periodProgress(period, now){
  if(typeof period!=='number') return null;
  const s=TIMES[`p${period}_s`], e=TIMES[`p${period}_e`];
  if(!s||!e) return null;

  const nowSec = now.getHours()*3600 + now.getMinutes()*60 + now.getSeconds();
  const startSec = hmToSec(s);
  const endSec   = hmToSec(e);
  const dur = Math.max(1, endSec-startSec);

  const elapsed = clamp(nowSec-startSec, 0, dur);
  const remain  = clamp(endSec-nowSec, 0, dur);
  const pct = clamp((elapsed/dur)*100, 0, 100);
  return {s,e,dur,elapsed,remain,pct};
}

/* ========= Render ========= */
function mkTile(cls){
  return `
  <div class="tile" data-class="${cls.classId}">
    <div class="badge">${cls.grade} — شعبة ${toArabicDigits(cls.section)}</div>
    <div class="actions">
      <button class="miniBtn" data-act="abs" data-class="${cls.classId}">غياب</button>
      <button class="miniBtn" data-act="edit" data-class="${cls.classId}">تحرير</button>
    </div>
    <div class="content">
      <div class="className">${cls.classId}</div>
      <div class="subject empty">—</div>
      <div class="teacher"></div>
    </div>
    <div class="state"></div>
  </div>`;
}
function renderAllTiles(){
  $('#m1').textContent=`${toArabicDigits(CLASSES.first.length)} شعب`;
  $('#m2').textContent=`${toArabicDigits(CLASSES.second.length)} شعب`;
  $('#m3').textContent=`${toArabicDigits(CLASSES.third.length)} شعب`;
  $('#g1').innerHTML = CLASSES.first.map(mkTile).join('');
  $('#g2').innerHTML = CLASSES.second.map(mkTile).join('');
  $('#g3').innerHTML = CLASSES.third.map(mkTile).join('');
  bindTileActions();
}

function findEntry(day, period, classId){
  return TIMETABLE.find(r=>r.day===day && Number(r.period)===Number(period) && r.classId===classId);
}
function absKey(day,period,classId){return `${day}|${period}|${classId}`;}

function applyFilter(){
  const q=(FILTER||'').trim().toLowerCase();
  $$('.tile').forEach(t=>{
    if(!q){t.style.display=''; return;}
    const id=t.dataset.class||'';
    const subj=t.querySelector('.subject')?.textContent||'';
    const tch=t.querySelector('.teacher')?.textContent||'';
    const hay=(id+' '+subj+' '+tch).toLowerCase();
    t.style.display = hay.includes(q)?'':'none';
  });
}

/* ========= Progress UI ========= */
function setFPHidden(hidden){
  ls.set('v3_fp_hidden', !!hidden);
  $('#fpHide').textContent = hidden ? 'إظهار' : 'إخفاء';
  $('#floatProg').style.display = hidden ? 'none' : '';
}
function setFPLocked(locked){
  ls.set('v3_fp_locked', !!locked);
  $('#floatProg').classList.toggle('locked', !!locked);
  $('#fpLock').textContent = locked ? 'فك' : 'قفل';
  $('#fpHint').textContent = locked ? 'المؤشر مثبت. اضغط "فك" لتحريكه.' : 'اسحب المؤشر لمكان مناسب ثم اضغط "قفل" للتثبيت.';
}
function applyFPPosition(){
  const pos=ls.get('v3_fp_pos', {left:18,bottom:86});
  const fp=$('#floatProg');
  fp.style.left=(pos.left|0)+'px';
  fp.style.bottom=(pos.bottom|0)+'px';
}
function updateProgress(period, day, now){
  const prog = periodProgress(period, now);

  if(!prog){
    $('#topProgFill').style.width='0%';
    $('#topProgTxt').textContent='لا يوجد مؤشر الآن';
  }else{
    $('#topProgFill').style.width = prog.pct.toFixed(1)+'%';
    $('#topProgTxt').textContent = `مضى ${fmtMMSS(prog.elapsed)} • تبقى ${fmtMMSS(prog.remain)} • ${toArabicDigits(prog.pct.toFixed(0))}%`;
  }

  if(ls.get('v3_fp_hidden', false)){
    $('#floatProg').style.display='none';
  }else{
    $('#floatProg').style.display='';
  }

  if(!prog){
    $('#fpTitle').textContent='مؤشر الحصة';
    $('#fpSlot').textContent='—';
    $('#fpFill').style.width='0%';
    $('#fpElapsed').textContent='—';
    $('#fpRemain').textContent='—';
  }else{
    $('#fpTitle').textContent = `${day} • ${slotLabel(period)}`;
    $('#fpSlot').textContent = `${prog.s} — ${prog.e}`;
    $('#fpFill').style.width = prog.pct.toFixed(1)+'%';
    $('#fpElapsed').textContent = fmtMMSS(prog.elapsed);
    $('#fpRemain').textContent = fmtMMSS(prog.remain);
  }
}

/* ========= Update Tiles ========= */
function updateTiles(){
  const now=new Date();
  const autoDay = dayName(now);
  const day = $('#manualDay').value || autoDay;

  const autoP = currentPeriodAuto(day, now);
  const manualP = $('#manualPeriod').value ? Number($('#manualPeriod').value) : '';
  const period = manualP || autoP;

  $('#pDay').innerHTML = `اليوم: <b>${day}</b> • <span style="color:var(--muted2);font-weight:900">${hijri(now)} • ${fmtDate(now)}</span>`;
  $('#pSlot').innerHTML = `الحصة: <b>${slotLabel(period)}</b>`;
  $('#pRange').innerHTML = `الوقت: <b>${(typeof period==='number') ? timeRangeOfPeriod(period) : '—'}</b>`;

  updateProgress(period, day, now);

  $$('.tile').forEach(tile=>{
    const classId = tile.dataset.class;
    tile.classList.remove('now','absent');
    const subjEl=tile.querySelector('.subject');
    const tchEl=tile.querySelector('.teacher');
    const stEl=tile.querySelector('.state');
    subjEl.classList.remove('empty');
    tchEl.textContent='';
    stEl.textContent='';

    if(typeof period==='number'){
      tile.classList.add('now');
      const ent = findEntry(day, period, classId);
      const ab = ABSENCES[absKey(day,period,classId)];

      if(ent){
        subjEl.textContent = ent.subject || '—';
        tchEl.textContent  = ent.teacher ? `المعلم: ${ent.teacher}` : '';
      }else{
        subjEl.textContent='— لا حصة —';
        subjEl.classList.add('empty');
      }
      stEl.textContent = `الحصة ${toArabicDigits(period)} • ${timeRangeOfPeriod(period)}`;

      if(ab){
        tile.classList.add('absent');
        subjEl.textContent = (ent?.subject || '—') + ' (تغطية)';
        tchEl.textContent = `غائب: ${ab.absent||'—'} • بديل: ${ab.cover||'—'}`;
      }
    }else if(period==='break'){
      subjEl.textContent='الفسحة';
      subjEl.classList.add('empty');
    }else if(period==='pr'){
      subjEl.textContent='الصلاة';
      subjEl.classList.add('empty');
    }else{
      subjEl.textContent='خارج وقت الحصص';
      subjEl.classList.add('empty');
    }
  });

  applyFilter();
}

/* ========= Actions: Abs/Edit ========= */
function bindTileActions(){
  $$('[data-act="abs"]').forEach(b=>b.onclick=()=>openAbs(b.dataset.class));
  $$('[data-act="edit"]').forEach(b=>b.onclick=()=>openEdit(b.dataset.class));
}

function openAbs(classId){
  const now=new Date();
  const day = $('#manualDay').value || dayName(now);
  const p = $('#manualPeriod').value ? Number($('#manualPeriod').value) : currentPeriodAuto(day,now);
  if(typeof p!=='number'){ return alert('حدد حصة من "عرض يدوي" أو انتظر وقت الحصص.'); }

  const ent = findEntry(day,p,classId) || {};
  const old = ABSENCES[absKey(day,p,classId)] || {absent:(ent.teacher||''), cover:''};

  const body = `
  <div class="modalGrid">
    <div>
      <div style="font-weight:1000;margin-bottom:6px;color:var(--muted)">المعلم الغائب</div>
      <input id="absA" list="teachersList" value="${old.absent||''}" placeholder="اسم المعلم">
    </div>
    <div>
      <div style="font-weight:1000;margin-bottom:6px;color:var(--muted)">المكلف بالتغطية</div>
      <input id="absC" list="teachersList" value="${old.cover||''}" placeholder="اسم المكلّف">
    </div>
  </div>
  <div style="margin-top:10px;color:var(--muted2);font-weight:900">
    ${day} • الحصة ${toArabicDigits(p)} • ${classId}
  </div>`;

  const saveBtn=document.createElement('button');
  saveBtn.className='btn primary'; saveBtn.textContent='حفظ';
  saveBtn.onclick=()=>{
    const absent=$('#absA').value.trim();
    const cover=$('#absC').value.trim();
    ABSENCES[absKey(day,p,classId)]={absent,cover};
    ls.set('v3_abs',ABSENCES);
    if(absent && !TEACHERS.includes(absent)) TEACHERS.push(absent);
    if(cover && !TEACHERS.includes(cover)) TEACHERS.push(cover);
    ls.set('v3_teachers',TEACHERS);
    refreshLists();
    closeModal(); updateTiles();
  };

  const clearBtn=document.createElement('button');
  clearBtn.className='btn danger'; clearBtn.textContent='إلغاء الغياب';
  clearBtn.onclick=()=>{
    delete ABSENCES[absKey(day,p,classId)];
    ls.set('v3_abs',ABSENCES);
    closeModal(); updateTiles();
  };

  openModal(`غياب/تغطية — ${classId}`, body, [clearBtn, saveBtn]);
}

function openEdit(classId){
  const now=new Date();
  const day = $('#manualDay').value || dayName(now);
  const p = $('#manualPeriod').value ? Number($('#manualPeriod').value) : currentPeriodAuto(day,now);
  if(typeof p!=='number'){ return alert('حدد حصة من "عرض يدوي" أو انتظر وقت الحصص.'); }

  const ent = findEntry(day,p,classId) || {subject:'',teacher:''};

  const body = `
  <div class="modalGrid">
    <div>
      <div style="font-weight:1000;margin-bottom:6px;color:var(--muted)">المادة</div>
      <input id="edS" list="subjectsList" value="${ent.subject||''}" placeholder="اسم المادة">
    </div>
    <div>
      <div style="font-weight:1000;margin-bottom:6px;color:var(--muted)">المعلم</div>
      <input id="edT" list="teachersList" value="${ent.teacher||''}" placeholder="اسم المعلم">
    </div>
  </div>
  <div style="margin-top:10px;color:var(--muted2);font-weight:900">
    ${day} • الحصة ${toArabicDigits(p)} • ${classId}
  </div>`;

  const saveBtn=document.createElement('button');
  saveBtn.className='btn primary'; saveBtn.textContent='حفظ';
  saveBtn.onclick=()=>{
    const subject=$('#edS').value.trim();
    const teacher=$('#edT').value.trim();
    const idx = TIMETABLE.findIndex(r=>r.day===day && Number(r.period)===Number(p) && r.classId===classId);
    if(idx>=0){ TIMETABLE[idx].subject=subject; TIMETABLE[idx].teacher=teacher; }
    else{ TIMETABLE.push({day,period:p,classId,subject,teacher}); }
    ls.set('v3_table',TIMETABLE);
    if(subject && !SUBJECTS.includes(subject)) SUBJECTS.push(subject);
    if(teacher && !TEACHERS.includes(teacher)) TEACHERS.push(teacher);
    ls.set('v3_subjects',SUBJECTS);
    ls.set('v3_teachers',TEACHERS);
    refreshLists();
    closeModal(); updateTiles();
  };
  openModal(`تحرير — ${classId}`, body, [saveBtn]);
}

/* ========= Duty ========= */
function ensureDuty(day){
  DUTY[day] ||= {names:Array(7).fill('')};
  while(DUTY[day].names.length<7) DUTY[day].names.push('');
  DUTY[day].names.length=7;
  return DUTY[day];
}
function renderDuty(){
  const day = $('#manualDay').value || dayName(new Date());
  const st = ensureDuty(day);
  $('#dutyList').innerHTML = st.names.map((n,i)=>`
    <div class="dutyRow">
      <input list="teachersList" data-duty="${i}" value="${n||''}" placeholder="اسم المعلّم">
      <button class="x" data-x="${i}">✕</button>
    </div>
  `).join('');
  $$('[data-duty]').forEach(inp=>inp.onchange=()=>{
    st.names[Number(inp.dataset.duty)] = inp.value.trim();
    ls.set('v3_duty',DUTY);
  });
  $$('[data-x]').forEach(b=>b.onclick=()=>{
    st.names[Number(b.dataset.x)]='';
    ls.set('v3_duty',DUTY);
    renderDuty();
  });
}

/* ========= Excel Import ========= */
function readWorkbookSmart(file, cb){
  const ext=(file.name.split('.').pop()||'').toLowerCase();
  const reader=new FileReader();
  reader.onerror=()=>alert('تعذّر قراءة الملف');
  if(ext==='csv'){
    reader.onload=e=>{
      try{
        let text=e.target.result;
        if((text.match(/;/g)||[]).length>(text.match(/,/g)||[]).length) text=text.replace(/;/g,',');
        const wb=XLSX.read(text,{type:'string'}); cb(wb);
      }catch{ alert('CSV غير صالح');}
    };
    reader.readAsText(file,'utf-8');
  }else{
    reader.onload=e=>{
      try{ const data=new Uint8Array(e.target.result); const wb=XLSX.read(data,{type:'array'}); cb(wb); }
      catch{ alert('Excel غير صالح'); }
    };
    reader.readAsArrayBuffer(file);
  }
}
function cell(ws, r, c){ return ws[XLSX.utils.encode_cell({r,c})]?.v ?? ''; }
function sheetSize(ws){ const ref=ws['!ref']; if(!ref) return {R:0,C:0}; const range=XLSX.utils.decode_range(ref); return {R:range.e.r+1, C:range.e.c+1}; }
const DAY_CANON={'الأحد':'الأحد','الاحد':'الأحد','أحد':'الأحد','احد':'الأحد','sun':'الأحد','sunday':'الأحد',
  'الاثنين':'الاثنين','إثنين':'الاثنين','اثنين':'الاثنين','mon':'الاثنين','monday':'الاثنين',
  'الثلاثاء':'الثلاثاء','tue':'الثلاثاء','tuesday':'الثلاثاء',
  'الأربعاء':'الأربعاء','wed':'الأربعاء','wednesday':'الأربعاء',
  'الخميس':'الخميس','thu':'الخميس','thursday':'الخميس'};
function canonDay(v){ const s=String(v||'').trim(); const k=s.toLowerCase(); return DAY_CANON[k] || DAY_CANON[s] || ''; }
function looksPeriod(v){
  const s=String(v||'').trim();
  if(/^[1-7١-٧]$/.test(s)) return parseInt(s.replace(/[١-٧]/g,ch=>'1234567'['١٢٣٤٥٦٧'.indexOf(ch)]));
  const dict={'الأولى':1,'الاولى':1,'الثانية':2,'الثالثة':3,'الرابعة':4,'الخامسة':5,'السادسة':6,'السابعة':7};
  return dict[s.replace(/\s/g,'')]||NaN;
}
function normalizeClassId(v){
  v=String(v||'').trim().replace(/[–—]/g,'-').replace(/\s*-\s*/g,'-').replace(/اول/g,'أول');
  const m=v.match(/(أول|ثاني|ثالث)\s*-\s*([0-9٠-٩]+)/);
  if(!m) return v;
  const map='٠١٢٣٤٥٦٧٨٩';
  const n=parseInt(String(m[2]).replace(/[٠-٩]/g,ch=>String(map.indexOf(ch))),10);
  return `${m[1]}-${n}`;
}
function looksTeacher(s){
  s=String(s||'').trim();
  if(!s) return false;
  if(/\s/.test(s) && !/[0-9]/.test(s) && s.length>=5) return true;
  return false;
}
function orderST(a,b){return (looksTeacher(a)&&!looksTeacher(b))?{subject:b,teacher:a}:{subject:a,teacher:b};}
function splitCell(val){
  let s=String(val||'').trim();
  if(!s) return {subject:'',teacher:''};
  if(s.includes('\n')){
    const p=s.split('\n').map(x=>x.trim()).filter(Boolean);
    if(p.length>=2) return orderST(p[0],p[1]);
    return {subject:p[0],teacher:''};
  }
  const parts=s.split(/[-–—\/|،]/).map(x=>x.trim()).filter(Boolean);
  if(parts.length===2) return orderST(parts[0],parts[1]);
  if(parts.length>2) return orderST(parts[0],parts.slice(1).join(' '));
  return {subject:parts[0],teacher:''};
}
function buildTimetable(ws){
  const {R,C}=sheetSize(ws);
  if(R<3||C<3) throw new Error('الورقة صغيرة');

  const dayByCol=Array(C).fill('');
  let lastDay='';
  for(let c=1;c<C;c++){
    const d0=canonDay(cell(ws,0,c));
    const d1=canonDay(cell(ws,1,c));
    if(d0) lastDay=d0; else if(d1) lastDay=d1;
    dayByCol[c]=lastDay;
  }
  const perByCol=Array(C).fill(null);
  let lastPer=1;
  for(let c=1;c<C;c++){
    if(!dayByCol[c]) continue;
    if(dayByCol[c]!==dayByCol[c-1]) lastPer=1;
    const p=looksPeriod(cell(ws,1,c));
    if(!isNaN(p)){ perByCol[c]=p; lastPer=p; }
    else{ perByCol[c]=lastPer; lastPer=Math.min(7,lastPer+1); }
  }

  const tt=[];
  const tset=new Set(TEACHERS||[]);
  const sset=new Set(SUBJECTS||[]);
  for(let r=2;r<R;r++){
    const classId=normalizeClassId(cell(ws,r,0));
    if(!/^(أول|ثاني|ثالث)\-\d+$/.test(classId)) continue;
    for(let c=1;c<C;c++){
      const day=dayByCol[c], per=perByCol[c];
      if(!day||!per) continue;
      const v=cell(ws,r,c);
      if(String(v||'').trim()==='') continue;
      const {subject,teacher}=splitCell(v);
      tt.push({day,period:per,classId,subject,teacher});
      if(subject) sset.add(subject);
      if(teacher) tset.add(teacher);
    }
  }
  TEACHERS=[...tset]; SUBJECTS=[...sset];
  ls.set('v3_teachers',TEACHERS);
  ls.set('v3_subjects',SUBJECTS);
  return tt;
}

/* ========= Snapshot ========= */
function snapshot(){ return {TIMES,TIMETABLE,TEACHERS,SUBJECTS,PHONEBOOK,ABSENCES,DUTY}; }
function applySnapshot(o){
  if(!o) return;
  TIMES=o.TIMES||TIMES;
  TIMETABLE=o.TIMETABLE||TIMETABLE;
  TEACHERS=o.TEACHERS||TEACHERS;
  SUBJECTS=o.SUBJECTS||SUBJECTS;
  PHONEBOOK=o.PHONEBOOK||PHONEBOOK;
  ABSENCES=o.ABSENCES||ABSENCES;
  DUTY=o.DUTY||DUTY;
  ls.set('v3_times',TIMES);
  ls.set('v3_table',TIMETABLE);
  ls.set('v3_teachers',TEACHERS);
  ls.set('v3_subjects',SUBJECTS);
  ls.set('v3_phonebook',PHONEBOOK);
  ls.set('v3_abs',ABSENCES);
  ls.set('v3_duty',DUTY);
  refreshLists(); renderDuty(); updateTiles();
}

/* ========= Time Editor ========= */
function openTimesEditor(){
  const row=(k,label)=>`
    <div style="display:grid;grid-template-columns:140px 1fr 1fr;gap:10px;align-items:center;padding:8px;border:1px solid var(--line);border-radius:18px;background:var(--glass)">
      <div style="font-weight:1000;color:var(--muted)">${label}</div>
      <input id="${k}_s" value="${TIMES[k+'_s']||''}" placeholder="HH:MM" style="border:1px solid var(--line);border-radius:14px;padding:10px 12px;background:var(--glass2);font-weight:1000;outline:none">
      <input id="${k}_e" value="${TIMES[k+'_e']||''}" placeholder="HH:MM" style="border:1px solid var(--line);border-radius:14px;padding:10px 12px;background:var(--glass2);font-weight:1000;outline:none">
    </div>`;
  const body=`
    <div style="display:grid;gap:10px">
      ${row('p1','الحصة 1')}
      ${row('p2','الحصة 2')}
      ${row('p3','الحصة 3')}
      ${row('p4','الحصة 4')}
      ${row('p5','الحصة 5')}
      ${row('p6','الحصة 6')}
      ${row('p7','الحصة 7')}
      <div style="display:grid;grid-template-columns:140px 1fr 1fr;gap:10px;align-items:center;padding:8px;border:1px solid var(--line);border-radius:18px;background:var(--glass)">
        <div style="font-weight:1000;color:var(--muted)">الفسحة</div>
        <input id="break_s" value="${TIMES.break_s||''}" placeholder="HH:MM" style="border:1px solid var(--line);border-radius:14px;padding:10px 12px;background:var(--glass2);font-weight:1000;outline:none">
        <input id="break_e" value="${TIMES.break_e||''}" placeholder="HH:MM" style="border:1px solid var(--line);border-radius:14px;padding:10px 12px;background:var(--glass2);font-weight:1000;outline:none">
      </div>
      <div style="display:grid;grid-template-columns:140px 1fr 1fr;gap:10px;align-items:center;padding:8px;border:1px solid var(--line);border-radius:18px;background:var(--glass)">
        <div style="font-weight:1000;color:var(--muted)">الصلاة</div>
        <input id="pr_s" value="${TIMES.pr_s||''}" placeholder="HH:MM" style="border:1px solid var(--line);border-radius:14px;padding:10px 12px;background:var(--glass2);font-weight:1000;outline:none">
        <input id="pr_e" value="${TIMES.pr_e||''}" placeholder="HH:MM" style="border:1px solid var(--line);border-radius:14px;padding:10px 12px;background:var(--glass2);font-weight:1000;outline:none">
      </div>
      <div style="color:var(--muted2);font-weight:900">صيغة الوقت: 07:15 — تأكد من التسلسل الصحيح.</div>
    </div>`;
  const save=document.createElement('button');
  save.className='btn primary'; save.textContent='حفظ التوقيت';
  save.onclick=()=>{
    const t={...TIMES};
    const keys=['p1','p2','p3','p4','p5','p6','p7'];
    keys.forEach(k=>{
      t[k+'_s']=$('#'+k+'_s').value.trim();
      t[k+'_e']=$('#'+k+'_e').value.trim();
    });
    t.break_s=$('#break_s').value.trim();
    t.break_e=$('#break_e').value.trim();
    t.pr_s=$('#pr_s').value.trim();
    t.pr_e=$('#pr_e').value.trim();
    TIMES=t;
    ls.set('v3_times',TIMES);
    closeModal(); updateTiles();
  };
  const cancel=document.createElement('button');
  cancel.className='btn'; cancel.textContent='إلغاء';
  cancel.onclick=closeModal;
  openModal('تحرير توقيت الحصص', body, [cancel, save]);
}

/* ========= Buttons ========= */
$('#btnTheme').onclick=toggleTheme;
$('#btnImport').onclick=()=>$('#fileTable').click();
$('#btnTimesEdit').onclick=openTimesEditor;

$('#btnTimesPreset').onclick=()=>{
  const body=`
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <button class="btn primary" id="setWinter">تطبيق شتوي</button>
      <button class="btn ghost" id="setSummer">تطبيق صيفي</button>
    </div>
    <div style="margin-top:10px;color:var(--muted2);font-weight:900;line-height:1.9">
      سيتم تحديث مواقيت الحصص المستخدمة في المؤشرات والعرض التلقائي.
    </div>`;
  const close=document.createElement('button');
  close.className='btn'; close.textContent='إغلاق'; close.onclick=closeModal;
  openModal('اختيار التوقيت', body, [close]);
  setTimeout(()=>{
    $('#setWinter').onclick=()=>{TIMES={...PRESET_WINTER}; ls.set('v3_times',TIMES); closeModal(); updateTiles();};
    $('#setSummer').onclick=()=>{TIMES={...PRESET_SUMMER}; ls.set('v3_times',TIMES); closeModal(); updateTiles();};
  },0);
};

$('#fileTable').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  readWorkbookSmart(f, wb=>{
    const ws=wb.Sheets[wb.SheetNames[0]];
    try{
      TIMETABLE=buildTimetable(ws);
      ls.set('v3_table',TIMETABLE);
      refreshLists();
      updateTiles();
      alert('تم استيراد الجدول ✔');
    }catch(err){
      console.error(err);
      alert('تعذر تحليل الملف. تأكد من ترتيب الصفوف/الأعمدة.');
    }
  });
  e.target.value='';
};

$('#btnPhone').onclick=()=>{
  const body = `
  <div style="display:flex;gap:10px;flex-wrap:wrap">
    <button class="btn primary" id="importPB">استيراد دفتر (Excel/CSV)</button>
    <button class="btn ghost" id="showPB">عرض الأسماء</button>
  </div>
  <div id="pbList" style="margin-top:12px;display:grid;gap:10px"></div>`;
  const close=document.createElement('button');
  close.className='btn'; close.textContent='إغلاق'; close.onclick=closeModal;
  openModal('دفتر المعلمين', body, [close]);
  setTimeout(()=>{
    $('#importPB').onclick=()=>$('#filePhonebook').click();
    $('#showPB').onclick=()=>{
      const names=[...new Set([...(TEACHERS||[]), ...Object.keys(PHONEBOOK||{})])].sort((a,b)=>a.localeCompare(b,'ar'));
      $('#pbList').innerHTML = names.slice(0,250).map(n=>`<div style="padding:12px;border-radius:18px;border:1px solid var(--line);background:var(--glass);font-weight:1000">${n}</div>`).join('')
        + (names.length>250? `<div style="color:var(--muted2);font-weight:900">عرض أول 250 اسم…</div>`:'');
    };
  },0);
};
$('#filePhonebook').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  readWorkbookSmart(f, wb=>{
    const ws=wb.Sheets[wb.SheetNames[0]];
    const {R}=sheetSize(ws);
    const map={};
    for(let r=0;r<R;r++){
      const name=String(cell(ws,r,0)||'').trim();
      const phone=String(cell(ws,r,1)||'').replace(/[^0-9]/g,'');
      if(!name) continue;
      map[name]={...(PHONEBOOK[name]||{}), ...(phone?{phone}:{})};
    }
    PHONEBOOK={...PHONEBOOK,...map};
    Object.keys(map).forEach(n=>{ if(!TEACHERS.includes(n)) TEACHERS.push(n); });
    ls.set('v3_phonebook',PHONEBOOK);
    ls.set('v3_teachers',TEACHERS);
    refreshLists();
    alert('تم تحديث دفتر المعلمين ✔');
  });
  e.target.value='';
};

$('#btnSnapSave').onclick=()=>{
  const blob=new Blob([JSON.stringify(snapshot(),null,2)],{type:'application/json;charset=utf-8'});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download='yaqoobi_v3_snapshot.json';
  a.click();
  URL.revokeObjectURL(a.href);
};
$('#btnSnapLoad').onclick=()=>$('#snapshotIn').click();
$('#snapshotIn').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=ev=>{ try{ applySnapshot(JSON.parse(ev.target.result)); alert('تمت الاستعادة ✔'); }catch{ alert('ملف غير صالح'); } };
  r.readAsText(f,'utf-8');
  e.target.value='';
};

$('#btnProjector').onclick=()=>{PROJECTOR=!PROJECTOR; applyProjector();};
$('#btnFull').onclick=toggleFullscreen;

$('#btnRefreshNow').onclick=()=>updateTiles();

$('#btnExportPNG').onclick=async ()=>{
  try{
    const root=$('#captureRoot');
    const canvas=await html2canvas(root,{scale:2,backgroundColor:null,useCORS:true});
    const a=document.createElement('a');
    a.href=canvas.toDataURL('image/png');
    a.download='الجدول_اللحظي.png';
    a.click();
  }catch(err){ console.error(err); alert('تعذر تصدير الصورة.'); }
};

$('#btnExportPDF').onclick=async ()=>{
  try{
    const root=$('#captureRoot');
    const canvas=await html2canvas(root,{scale:2,backgroundColor:'#ffffff',useCORS:true});
    const img=canvas.toDataURL('image/png');
    const { jsPDF } = window.jspdf;
    const pdf=new jsPDF({orientation:'landscape', unit:'pt', format:'a4'});
    const pageW=pdf.internal.pageSize.getWidth();
    const pageH=pdf.internal.pageSize.getHeight();
    const ratio=Math.min(pageW/canvas.width, pageH/canvas.height);
    const w=canvas.width*ratio, h=canvas.height*ratio;
    const x=(pageW-w)/2, y=(pageH-h)/2;
    pdf.addImage(img,'PNG',x,y,w,h);
    pdf.save('الجدول_اللحظي_A4.pdf');
  }catch(err){ console.error(err); alert('تعذر تصدير PDF.'); }
};

$('#btnResetSafe').onclick=()=>{
  const body=`
    <div style="line-height:1.9;color:var(--muted);font-weight:900">
      سيتم مسح (الثيم/التوقيت/الجدول/الغيابات/المناوبة) من المتصفح.
    </div>`;
  const ok=document.createElement('button');
  ok.className='btn danger'; ok.textContent='تأكيد المسح';
  ok.onclick=()=>{
    [
      'v3_theme','v3_times','v3_table','v3_teachers','v3_subjects','v3_phonebook','v3_abs','v3_duty',
      'v3_compact','v3_projector','v3_tileMin','v3_fp_pos','v3_fp_locked','v3_fp_hidden'
    ].forEach(k=>ls.del(k));
    location.reload();
  };
  const cancel=document.createElement('button');
  cancel.className='btn'; cancel.textContent='إلغاء'; cancel.onclick=closeModal;
  openModal('إعادة ضبط', body, [cancel, ok]);
};

$('#zoomTiles').addEventListener('input',e=>setTileMin(parseInt(e.target.value,10)));
$('#btnCompact').onclick=()=>{COMPACT=!COMPACT; applyCompact(); updateTiles();};

$('#q').addEventListener('input',e=>{FILTER=e.target.value||''; applyFilter();});
$('#btnClearSearch').onclick=()=>{FILTER=''; $('#q').value=''; applyFilter();};

$('#manualDay').onchange=()=>{updateTiles(); renderDuty();};
$('#manualPeriod').onchange=()=>updateTiles();

/* Duty */
$('#dutySuggest').onclick=()=>{
  const day = $('#manualDay').value || dayName(new Date());
  const st=ensureDuty(day);
  const pool=(TEACHERS||[]).filter(Boolean);
  for(let i=0;i<7;i++) st.names[i]=pool[(Math.random()*pool.length)|0]||'';
  ls.set('v3_duty',DUTY);
  renderDuty();
};
$('#dutySave').onclick=()=>{ ls.set('v3_duty',DUTY); alert('تم حفظ المناوبة ✔'); };
$('#dutyClear').onclick=()=>{
  const day = $('#manualDay').value || dayName(new Date());
  ensureDuty(day).names=Array(7).fill('');
  ls.set('v3_duty',DUTY);
  renderDuty();
};

/* ========= Floating Drag + Lock ========= */
(function initFloatingDrag(){
  const fp=$('#floatProg');
  const handle=$('#fpHandle');
  let drag=false, startX=0, startY=0, startLeft=0, startBottom=0;

  function onDown(e){
    if(ls.get('v3_fp_locked', false)) return;
    drag=true;
    fp.setPointerCapture?.(e.pointerId);
    const rect=fp.getBoundingClientRect();
    startX=e.clientX; startY=e.clientY;
    startLeft = rect.left;
    startBottom = (window.innerHeight - rect.bottom);
  }
  function onMove(e){
    if(!drag) return;
    const dx=e.clientX-startX;
    const dy=e.clientY-startY;

    let newLeft = startLeft + dx;
    let newBottom = startBottom - dy;

    const rect=fp.getBoundingClientRect();
    const maxLeft = window.innerWidth - rect.width - 10;
    const maxBottom = window.innerHeight - rect.height - 10;

    newLeft = clamp(newLeft, 10, maxLeft);
    newBottom = clamp(newBottom, 10, maxBottom);

    fp.style.left = newLeft + 'px';
    fp.style.bottom = newBottom + 'px';
  }
  function onUp(){
    if(!drag) return;
    drag=false;
    const rect=fp.getBoundingClientRect();
    const left = rect.left;
    const bottom = window.innerHeight - rect.bottom;
    ls.set('v3_fp_pos', {left:left|0, bottom:bottom|0});
  }

  handle.addEventListener('pointerdown', onDown);
  window.addEventListener('pointermove', onMove);
  window.addEventListener('pointerup', onUp);
})();

$('#fpLock').onclick=()=> setFPLocked(!ls.get('v3_fp_locked', false));
$('#fpHide').onclick=()=> setFPHidden(!ls.get('v3_fp_hidden', false));

/* ========= Init ========= */
function tick(){
  const now=new Date();
  $('#clock').textContent = `${pad2(now.getHours())}:${pad2(now.getMinutes())}:${pad2(now.getSeconds())}`;
  updateTiles();
}

function boot(){
  applyTheme(getTheme());

  renderAllTiles();
  refreshLists();
  renderDuty();

  setTileMin(ls.get('v3_tileMin', 260));
  $('#zoomTiles').value = ls.get('v3_tileMin', 260);

  COMPACT = ls.get('v3_compact', false);
  PROJECTOR = ls.get('v3_projector', false);
  applyCompact();
  applyProjector();

  applyFPPosition();
  setFPLocked(ls.get('v3_fp_locked', false));
  setFPHidden(ls.get('v3_fp_hidden', false));

  tick();
  setInterval(tick, 1000);
}
boot();
</script>
</body>
</html>
