<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>جدول اليعقوبي الثانوية — عرض لحظي</title>

  <!-- الهوية -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Cairo:wght@700&display=swap" rel="stylesheet">
  <!-- قراءة Excel/CSV -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --moe-green:#18a27e; --moe-ink:#0f3d33; --light:#f9fefb; --line:#e7f2ee;
      --first:#0fb3b0; --second:#7bc35b; --third:#4a8fff;
      --danger-bg:#fdecec; --danger-border:#f5c2c2; --danger-ink:#8a1f1f;
      --chip:#f3fbf8; --chip-border:#cfe8e1; --ink:#0b4035;
      --ctl-bg:#ffffff; --ctl-border:#e4efec;
      --duty-accent:#e25353;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:#111;font-family:"Tajawal",system-ui;
      background:
        radial-gradient(1200px 600px at 10% 0%, #ffffff 0%, #f2fffa 100%),
        linear-gradient(180deg,#f9fff9 0%, #f4fffa 100%);
    }

    /* ===== الهيدر ===== */
    header{position:sticky;top:0;z-index:60;background:linear-gradient(90deg,var(--moe-green),#27b394);color:#fff;border-bottom:4px solid #0d5e49}
    .h-wrap{max-width:1500px;margin:0 auto;padding:10px 16px}
    .h-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .title{font-family:"Cairo";font-size:20px;font-weight:800;letter-spacing:.3px}
    .clock{font-family:"Cairo";font-weight:800;font-size:clamp(22px,3.4vw,32px);background:transparent;color:#fff;min-width:128px;text-align:center;letter-spacing:.5px}
    .dateweek{font-size:14px;font-weight:800;color:#eafff7;margin-top:6px}

    main{max-width:1500px;margin:0 auto;padding:10px 14px 80px}

    /* ===== أيقونات عليا ===== */
    .hero{display:flex;flex-direction:column;align-items:center;gap:10px;margin:6px 0 10px;text-align:center}
    .iconbar{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
    .ib{width:38px;height:38px;border-radius:12px;background:#ffffffcc;backdrop-filter:blur(4px);display:inline-flex;align-items:center;justify-content:center;border:1px solid #d8e7e3;box-shadow:0 2px 10px #00000010;cursor:pointer;position:relative;transition:.2s}
    .ib[disabled]{opacity:.5;cursor:not-allowed}
    .ib:hover{transform:translateY(-1px);background:#f6fbf9}
    .ib svg{width:20px;height:20px;color:#0b534a}
    .menu{position:absolute;top:44px;right:0;min-width:460px;background:#fff;border:1px solid #dceae7;border-radius:12px;box-shadow:0 12px 30px #00000014;padding:10px;display:none;z-index:90}
    .menu.open{display:block}
    .menu h4{margin:4px 6px 8px;font-size:13px;color:#0b4035}
    .menu .row{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .menu label{font-size:12px;color:#0b4035}
    .menu input,.menu textarea,.menu button,.menu select{width:100%;padding:6px 8px;border:1px solid #d8e7e3;border-radius:8px;background:#fff;font-family:"Tajawal"}
    .btn-ghost{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--chip-border);background:var(--chip);padding:6px 10px;border-radius:999px;font-size:12px;cursor:pointer}
    .btn-ghost:hover{background:#eefaf5}
    .lock-badge{font-size:11px;background:#fff;border:1px solid #e6efec;color:#0b4035;border-radius:999px;padding:2px 8px;margin-right:6px}

    /* ===== البطاقة الرئيسية ===== */
    .card{
      background:#fff;border:1px solid var(--line);border-radius:18px;padding:12px;
      box-shadow:0 6px 24px #28a48a22, 0 2px 10px #00000010;
    }

    .bigTitle{display:none}

    /* ===== مصفوفة: لوحة الشعب + عمود المناوبين/المشرفين ===== */
    /* رجعنا عرض عمود المناوبة للصيغة السابقة (أضيق) */
    .board{display:grid;grid-template-columns:1fr 480px;gap:10px;align-items:start}
    @media (max-width:1200px){ .board{grid-template-columns:1fr} }

    /* ===== لوحات الشعب ===== */
    .band-wrap{margin-top:6px}
    .bandTitle{font-weight:800;font-size:16px;margin:8px 0 4px;display:flex;align-items:center;gap:6px}
    .bandTitle .dot{width:10px;height:10px;border-radius:999px}
    .band{
      display:grid;gap:12px;padding:8px 4px;overflow:visible;
      grid-template-columns:repeat(5, minmax(220px,1fr));
    }
    @media (max-width:1100px){ .band{grid-template-columns:repeat(4,minmax(200px,1fr))} }
    @media (max-width:900px){ .band{grid-template-columns:repeat(2,minmax(200px,1fr))} }
    @media (max-width:520px){ .band{grid-template-columns:repeat(1,minmax(220px,1fr))} }

    .band.first{--accent:var(--first)}
    .band.second{--accent:var(--second)}
    .band.third{--accent:var(--third)}
    .band .tile{border-top:4px solid var(--accent)}

    .bandTitle.first .dot{background:var(--first)}
    .bandTitle.second .dot{background:var(--second)}
    .bandTitle.third .dot{background:var(--third)}

    .tile{
      position:relative;background:linear-gradient(180deg,#ffffff 0%,#fbfffd 100%);
      border:1px solid #e0ece9;border-radius:16px;padding:12px;min-height:148px;overflow:hidden;
      box-shadow:0 6px 16px #0000000e; transition:.2s;
    }
    .tile:hover{transform:translateY(-1px); box-shadow:0 10px 20px #00000012}
    .badge{position:absolute;top:8px;left:8px;background:#e6fbf5;color:#0b534a;border:1px solid #bde7dc;padding:1px 8px;border-radius:999px;font-size:11px}
    .section{font-weight:800;color:#0b4035;font-size:15px;margin-bottom:8px;text-align:center}
    .subject{font-size:15px;color:#113;text-align:center}
    .teacher{font-size:13px;color:#345;margin-top:6px;text-align:center}
    .room{font-size:12px;color:#5a7;margin-top:2px;text-align:center}
    .state{position:absolute;bottom:8px;left:8px;font-size:11px;color:#0b534a}
    .empty{color:#7b8;font-style:italic}

    /* أزرار الشعبة */
    .abs-btn,.edit-btn,.abs-clear{position:absolute;top:8px;background:#fff;border:1px solid #f3b0b0;color:#b11;padding:2px 8px;border-radius:999px;font-size:11px;cursor:pointer}
    .abs-btn{right:8px}
    .abs-clear{right:8px;top:38px}
    .edit-btn{left:8px;border-color:#cfe8e1;color:#0b534a}
    .abs-btn[disabled],.edit-btn[disabled],.abs-clear[disabled]{opacity:.5;cursor:not-allowed}

    .abs-form,.edit-form{position:absolute;inset:auto 8px 8px 8px;background:#fff;border:1px solid #e9d3d3;border-radius:12px;padding:8px;box-shadow:0 8px 20px #0000001a}
    .abs-form h5,.edit-form h5{margin:0 0 6px;font-size:12px;color:#8a1f1f}
    .abs-form .row,.edit-form .row{display:grid;grid-template-columns:1fr;gap:6px}
    .abs-form input,.abs-form button,.edit-form input,.edit-form button{width:100%;padding:6px 8px;border:1px solid #e6efec;border-radius:8px}
    .abs-form .actions,.edit-form .actions{display:flex;gap:6px;margin-top:6px}

    .tile.absent{background:var(--danger-bg); border-color:var(--danger-border)}
    .tile.absent .badge{background:#fff0f0;color:var(--danger-ink);border-color:var(--danger-border)}
    .chip{display:inline-block;background:#fff;border:1px solid #e6efec;border-radius:999px;padding:2px 8px;font-size:11px;margin-top:4px}

    /* ===== مؤشر البطارية ===== *//* ===== موضع المؤشر بين أول/ثاني: تحت (أول ثالث/رابع/خامس) وفوق صف ثاني ===== */
#band_first .mid-indicator{
  /* شبكة أول ثانوي: ضع المؤشر في الصف الثاني والأعمدة 3–5 */
  grid-column: 3 / span 3;   /* تحت "أول ثالث/رابع/خامس" */
  grid-row: 2;               /* نفس صف "أول-6/7" لكن في الأعمدة الفارغة */
  justify-self: center;      /* يتوسّط أفقيًا ضمن هذا النطاق */
  align-self: center;        /* تمركز رأسي داخل صفّه */
  display:flex; align-items:center; justify-content:center;
  margin: 6px 0 12px;        /* مسافة لطيفة فوق/تحت */
}

/* على الشاشات الصغيرة: يمتد بعرض الشبكة ويتمركز */
@media (max-width:900px){
  #band_first .mid-indicator{
    grid-column: 1 / -1;
    justify-self: center;
  }
}

/* مظهر بطاقة المؤشر (كما هو) */
.mid-card{
  display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;
  background:#fff;border:1px solid #e0ece9;border-top:4px solid var(--first);
  border-radius:14px;padding:10px 12px;box-shadow:0 6px 16px #0000000f;min-width:320px
}
.mid-title{font-weight:800;color:#0b4035}
.mid-sub{font-size:12px;color:#345}
.bat{display:flex;align-items:center;gap:10px}
.bat-shell{position:relative;width:280px;max-width:60vw;height:18px;border:2px solid #0b534a;border-radius:8px;overflow:hidden;background:linear-gradient(90deg,#fefefe,#f5fffb)}
.bat-shell::after{content:"";position:absolute;right:-8px;top:3px;width:6px;height:12px;border:2px solid #0b534a;border-left:none;border-radius:0 6px 6px 0;background:#fff}
.bat-fill{height:100%;width:0%;transition:width .7s ease; background:linear-gradient(90deg,#e65353,#ffd24d,#53c77a)}
.bat-num{font-family:"Cairo";font-weight:900;font-size:18px;letter-spacing:.3px;color:#0b4035;min-width:86px;text-align:center}
.flip{animation:flip .6s ease}
@keyframes flip {0%{transform:rotateX(0)}50%{transform:rotateX(180deg)}100%{transform:rotateX(360deg)}}

    /* ===== عمود المناوبين/المشرفين (أضيق + يمتد رأسيًا) ===== */
    .duty-card{
      position:sticky; top:60px; background:var(--ctl-bg); border:1px solid var(--ctl-border);
      border-top:4px solid var(--duty-accent); border-radius:16px; padding:12px;
      box-shadow:0 6px 22px #ff5a5a14, 0 2px 10px #0000000d;
      width:100%;
    }
    .duty-title{margin:0 0 6px; font-size:15px; color:var(--ink); font-weight:800}
    .phase-pill{display:inline-block;border:1px dashed #dfe9e6;background:#f8fcfb;border-radius:999px;padding:3px 10px;font-size:12px;color:#0b4035}
    .duty-tools{display:flex; gap:6px; flex-wrap:wrap; margin:10px 0 8px}
    .duty-tools .btn-ghost{font-size:12px;padding:6px 10px}

    /* صفوف أوسع ومتباعدة بدون تداخل */
    .duty-row{
      display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center;
      border:1px solid #edf3f2; border-radius:12px; padding:10px 12px; margin-bottom:10px;
      background:linear-gradient(180deg,#ffffff 0%,#f9fffc 100%); font-size:14px; line-height:1.9
    }
    .duty-name input{width:100%; border:1px solid #e6efec; border-radius:10px; padding:8px 10px; font-size:14px}
    .duty-actions{display:flex; gap:8px}
    .mini{display:inline-flex; align-items:center; gap:4px; border:1px solid #e6efec; background:#fff; padding:7px 10px; border-radius:999px; font-size:12px; cursor:pointer}
    .mini:hover{background:#f9fcfb}

    @media (max-width:1200px){
      .duty-card{position:static; min-height:auto; margin-top:12px}
    }

    /* ===== تذييل ===== */
    .ft{position:fixed;bottom:0;left:0;right:0;z-index:70;background:linear-gradient(90deg,#0e9a92,#1a9c77);border-top:3px solid #0d5e49;color:#fff}
    .ft-inner{max-width:1500px;margin:0 auto;padding:8px 10px;display:flex;justify-content:center;align-items:center}
    .ft-brand{font-size:12px;opacity:.95;text-align:center}
  </style>
</head>
<body>
  <header>
    <div class="h-wrap">
      <div class="h-row">
        <div class="title">جدول اليعقوبي الثانوية — عرض لحظي <span id="lockState" class="lock-badge">🔒 محرّر مقفول</span></div>
        <div class="clock" id="clock">--:--:--</div>
      </div>
      <div class="dateweek" id="dateWeek">—</div>
    </div>
  </header>

  <!-- مُدخلات ملفات -->
  <input type="file" id="fileTable" accept=".xlsx,.xls,.xlsb,.csv" hidden>
  <input type="file" id="filePhonebook" accept=".xlsx,.xls,.xlsb,.csv" hidden>
  <input type="file" id="snapshotIn" accept=".json" hidden>

  <main>
    <!-- الأيقونات -->
    <section class="hero">
      <div class="iconbar">
        <!-- قفل/فتح -->
        <div class="ib" id="btnLock" title="أمان التحرير (مدير)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
          <div class="menu" id="menuLock">
            <h4>أمان التحرير (للمدير فقط)</h4>
            <div class="row" style="grid-template-columns:1fr 1fr">
              <button id="setPin" class="btn-ghost">تعيين/تغيير رمز المدير (٦ أرقام)</button>
              <button id="toggleEdit" class="btn-ghost">فتح/إغلاق التحرير</button>
            </div>
            <small style="color:#0b534a">الرمز يجب أن يكون <b>٦ أرقام</b> ويُحفظ مُشفّرًا محليًا. عند الإغلاق تصبح الصفحة للعرض فقط.</small>
          </div>
        </div>

        <!-- استيراد الجدول -->
        <div class="ib" id="btnImport" title="استيراد الجدول العام (Excel/CSV)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
          <div class="menu" id="menuImport">
            <h4>استيراد الجدول العام — مطابقة خوارزمية</h4>
            <div class="row"><button id="pickTable" class="btn-ghost">اختر ملف Excel/CSV</button></div>
            <small style="color:#0b4035">يدعم الجداول العريضة: الصف الأول أيام، الصف الثاني الحصص (١–٧)، العمود الأول الشعبة، وكل خلية (مادة/معلم) أو (مادة\nمعلم). يحاول التقاط أزمنة الحصص إن وُجدت.</small>
          </div>
        </div>

        <!-- مواقيت صيفي/شتوي -->
        <div class="ib" id="btnTimes" title="مواقيت الحصص — صيفي/شتوي">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          <div class="menu" id="menuTimes">
            <h4>مواقيت الحصص (صيفي/شتوي + تحرير يدوي)</h4>
            <div class="row" style="grid-template-columns:1fr 1fr 1fr">
              <label>الوضع
                <select id="seasonMode">
                  <option value="custom">مخصص</option>
                  <option value="summer">صيفي</option>
                  <option value="winter">شتوي</option>
                </select>
              </label>
              <button id="applySeason" class="btn-ghost" style="align-self:end">تطبيق الوضع</button>
              <button id="saveTimes" class="btn-ghost" style="align-self:end">حفظ المواقيت</button>
            </div>
            <div class="row" style="grid-template-columns:repeat(2,1fr);gap:6px">
              <label>الاصطفاف (بدء)<input type="time" id="t_assm_s"></label>
              <label>الاصطفاف (نهاية)<input type="time" id="t_assm_e"></label>
              <label>الحصة 1 (بدء)<input type="time" id="t_p1_s"></label>
              <label>الحصة 1 (نهاية)<input type="time" id="t_p1_e"></label>
              <label>الحصة 2 (بدء)<input type="time" id="t_p2_s"></label>
              <label>الحصة 2 (نهاية)<input type="time" id="t_p2_e"></label>
              <label>الحصة 3 (بدء)<input type="time" id="t_p3_s"></label>
              <label>الحصة 3 (نهاية)<input type="time" id="t_p3_e"></label>
              <label>الفسحة (بدء)<input type="time" id="t_break_s"></label>
              <label>الفسحة (نهاية)<input type="time" id="t_break_e"></label>
              <label>الحصة 4 (بدء)<input type="time" id="t_p4_s"></label>
              <label>الحصة 4 (نهاية)<input type="time" id="t_p4_e"></label>
              <label>الحصة 5 (بدء)<input type="time" id="t_p5_s"></label>
              <label>الحصة 5 (نهاية)<input type="time" id="t_p5_e"></label>
              <label>السادسة (بدء)<input type="time" id="t_p6_s"></label>
              <label>السادسة (نهاية)<input type="time" id="t_p6_e"></label>
              <label>فاصل صلاة (بدء)<input type="time" id="t_pr_s"></label>
              <label>فاصل صلاة (نهاية)<input type="time" id="t_pr_e"></label>
              <label>السابعة (بدء)<input type="time" id="t_p7_s"></label>
              <label>السابعة (نهاية)<input type="time" id="t_p7_e"></label>
            </div>
          </div>
        </div>

        <!-- واتساب: دفتر الهواتف -->
        <div class="ib" id="btnWA" title="واتساب: دفتر الهواتف + إشعار">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.52 3.48A11.94 11.94 0 0 0 12.06 0C5.4 0 0 5.4 0 12.06c0 2.12.56 4.16 1.62 5.96L0 24l6.16-1.6a12.02 12.02 0 0 0 5.9 1.54h.01c6.66 0 12.06-5.4 12.06-12.06 0-3.23-1.26-6.26-3.48-8.48Zm-8.46 18.04h-.01a10.3 10.3 0 0 1-5.24-1.44l-.38-.22-3.66.95.98-3.56-.25-.37a10.31 10.31 0 1 1 8.56 4.64ZM17 14.2c-.28-.14-1.64-.8-1.9-.9-.26-.1-.45-.14-.64.14-.19.28-.73.9-.9 1.08-.17.19-.33.21-.61.07-.28-.14-1.18-.44-2.26-1.4-.84-.75-1.41-1.68-1.57-1.96-.17-.28-.02-.43.12-.57.12-.12.28-.33.42-.49.14-.16.19-.28.28-.47.09-.19.05-.35-.02-.49-.07-.14-.64-1.55-.88-2.12-.23-.56-.47-.48-.64-.49-.16-.01-.35-.01-.54-.01-.19 0-.49.07-.75.35-.26.28-1 1-1 2.43 0 1.43 1.02 2.81 1.16 3 .14.19 2 3.05 4.85 4.28.68.29 1.21.46 1.62.58.68.22 1.3.19 1.79.12.55-.08 1.64-.67 1.87-1.32.23-.65.23-1.21.16-1.32-.07-.11-.26-.18-.54-.32Z"/></svg>
          <div class="menu" id="menuWA">
            <h4>دفتر هواتف المعلّمين (Excel/CSV)</h4>
            <div class="row"><button id="pickPhonebook" class="btn-ghost">استيراد (الاسم/الجوال/الهوية/التخصص)</button></div>
          </div>
        </div>

        <!-- سحابة: حفظ/استعادة JSON -->
        <div class="ib" id="btnCloud" title="حفظ/استعادة البيانات (JSON)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 17.58A5 5 0 0 0 18 8h-1.26A8 8 0 1 0 4 16.25"/><path d="M16 16l-4 4-4-4"/><path d="M12 20V10"/></svg>
          <div class="menu" id="menuCloud">
            <h4>البيانات الداخلية</h4>
            <div style="display:flex;gap:8px">
              <button class="btn-ghost" id="saveSnapshot">حفظ ملف بيانات (JSON)</button>
              <button class="btn-ghost" id="loadSnapshot">استعادة من ملف</button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- اللوحة الرئيسة: لوحة الشعب + عمود المناوبين/المشرفين -->
    <section class="card">
      <div class="board">
        <!-- A) لوحة الشعب -->
        <div id="classesBoard">
          <div id="wrap_first" class="band-wrap">
            <div class="bandTitle first"><span class="dot"></span> أول ثانوي (٧ شعب)</div>
            <div class="band first" id="band_first"></div>
          </div>

          <div id="wrap_second" class="band-wrap">
            <div class="bandTitle second"><span class="dot"></span> ثاني ثانوي (٥ شعب)</div>
            <div class="band second" id="band_second"></div>
          </div>

          <div id="wrap_third" class="band-wrap">
            <div class="bandTitle third"><span class="dot"></span> ثالث ثانوي (٥ شعب)</div>
            <div class="band third" id="band_third"></div>
          </div>
        </div>

        <!-- B) عمود المناوبين/المشرفين (أضيق + يمتد من حدود أول حتى نهاية ثالث) -->
        <aside id="dutyPanel" class="duty-card">
          <div class="duty-title">المناوبون والمشرفون لهذا اليوم</div>
          <div style="margin-bottom:6px"><span id="phaseLabel" class="phase-pill">—</span></div>

          <div class="duty-tools">
            <button class="btn-ghost" id="dutySuggest">اقتراح ٧ أسماء</button>
            <button class="btn-ghost" id="dutySave">حفظ</button>
            <button class="btn-ghost" id="dutyClear">مسح</button>
          </div>

          <div id="dutyList"></div>
          <small style="color:#0b4035">الأسماء ثابتة أسبوعيًا حسب اليوم، وتتبدّل «الصفة» تلقائيًا حسب التوقيت.</small>
        </aside>
      </div>
    </section>
  </main>

  <!-- تذييل -->
  <footer class="ft">
    <div class="ft-inner">
      <div class="ft-brand">مبادرة اليعقوبي الثانوية — تنفيذ فهد حامد الزهراني</div>
    </div>
  </footer>

  <!-- دلائل اختيار -->
  <datalist id="teachersList"></datalist>
  <datalist id="classesList"></datalist>
  <datalist id="subjectsList"></datalist>

<script>
/* ===== أدوات عامة ===== */
const $ = s=>document.querySelector(s), $$ = s=>Array.from(document.querySelectorAll(s));
const ls = { get(k,d=null){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}, set(k,v){localStorage.setItem(k,JSON.stringify(v))}, del(k){localStorage.removeItem(k)} };
function toArabicDigits(str){return String(str).replace(/[0-9]/g,d=>'٠١٢٣٤٥٦٧٨٩'[d]);}
function dayNameArabicFromDate(dt){return ['الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'][dt.getDay()]||'الأحد'}
function fmtDate(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),da=String(d.getDate()).padStart(2,'0');return `${da}/${m}/${y}`}
function fmtHijri(d){try{return new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{day:'2-digit',month:'long',year:'numeric'}).format(d)}catch{return fmtDate(d)}}

/* ===== أمان التحرير ===== */
async function sha256(s){const enc=new TextEncoder().encode(s);const buf=await crypto.subtle.digest('SHA-256',enc);return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');}
let ADMIN_HASH = ls.get('smart_admin_hash','');
let EDIT_ENABLED = ls.get('smart_edit_unlocked',false);
function setLockUI(){
  const locked = !EDIT_ENABLED;
  $('#lockState').textContent = locked ? '🔒 محرّر مقفول' : '🔓 محرّر مفتوح';
  ['btnImport','btnTimes','btnWA','btnCloud'].forEach(id=>{ const el=$('#'+id); if(el) el.toggleAttribute('disabled', locked); });
  $$('.abs-btn, .edit-btn, .abs-clear').forEach(el=>el.toggleAttribute('disabled', locked));
}
async function promptSetPin(){
  if(EDIT_ENABLED) return alert('أغلق التحرير أولاً ثم غيّر الرمز.');
  const p1 = prompt('أدخل رمز مدير جديد (٦ أرقام):'); if(!p1) return;
  if(!/^\d{6}$/.test(p1)) return alert('الرمز يجب أن يكون ٦ أرقام.');
  const p2 = prompt('أعد إدخال الرمز للتأكيد:'); if(p1!==p2) return alert('الرمزان غير متطابقين.');
  ADMIN_HASH = await sha256(p1); ls.set('smart_admin_hash', ADMIN_HASH); alert('تم ضبط رمز المدير ✔');
}
async function promptToggleEdit(){
  if(!ADMIN_HASH){ return alert('لم يتم ضبط رمز مدير بعد. استخدم: تعيين/تغيير رمز المدير (٦ أرقام).'); }
  const pin = prompt(EDIT_ENABLED?'أدخل الرمز لإغلاق التحرير:':'أدخل الرمز لفتح التحرير:'); if(!pin) return;
  if(!/^\d{6}$/.test(pin)) return alert('الرمز يجب أن يكون ٦ أرقام.');
  const h = await sha256(pin);
  if(h!==ADMIN_HASH) return alert('رمز غير صحيح.');
  EDIT_ENABLED = !EDIT_ENABLED; ls.set('smart_edit_unlocked', EDIT_ENABLED); setLockUI();
}

/* ===== المواقيت ===== */
const PRESET_SUMMER={assm_s:'06:45',assm_e:'07:00',p1_s:'07:00',p1_e:'07:50',p2_s:'07:50',p2_e:'08:40',p3_s:'08:40',p3_e:'09:30',break_s:'09:30',break_e:'09:55',p4_s:'09:55',p4_e:'10:45',p5_s:'10:45',p5_e:'11:35',p6_s:'11:35',p6_e:'12:25',pr_s:'12:25',pr_e:'12:40',p7_s:'12:40',p7_e:'13:30'};
const PRESET_WINTER={assm_s:'07:00',assm_e:'07:15',p1_s:'07:15',p1_e:'08:05',p2_s:'08:05',p2_e:'08:55',p3_s:'08:55',p3_e:'09:45',break_s:'09:45',break_e:'10:10',p4_s:'10:10',p4_e:'11:00',p5_s:'11:00',p5_e:'11:50',p6_s:'11:50',p6_e:'12:40',pr_s:'12:40',pr_e:'12:55',p7_s:'12:55',p7_e:'13:45'};
const DEFAULT_TIMES=PRESET_SUMMER;
let TIMES=ls.get('smart_times',DEFAULT_TIMES);
function setTimeInputs(){['assm_s','assm_e','p1_s','p1_e','p2_s','p2_e','p3_s','p3_e','break_s','break_e','p4_s','p4_e','p5_s','p5_e','p6_s','p6_e','pr_s','pr_e','p7_s','p7_e'].forEach(id=>{const el=$(`#t_${id}`); if(el) el.value=TIMES[id]||DEFAULT_TIMES[id];});}
function saveTimesFromInputs(){['assm_s','assm_e','p1_s','p1_e','p2_s','p2_e','p3_s','p3_e','break_s','break_e','p4_s','p4_e','p5_s','p5_e','p6_s','p6_e','pr_s','pr_e','p7_s','p7_e'].forEach(id=>{const el=$(`#t_${id}`); if(el) TIMES[id]=el.value||DEFAULT_TIMES[id];}); ls.set('smart_times',TIMES)}
function parseHM(str){const [h,m]=String(str||'').split(':').map(x=>parseInt(x)); return {h:h||0,m:m||0}}
function inRangeHM(now,s,e){const x=now.getHours()*60+now.getMinutes(), S=s.h*60+s.m, E=e.h*60+e.m; return x>=S && x<E}
function hmToMin(s){const [H,M]=String(s||'0:0').split(':').map(Number); return (H||0)*60+(M||0);}

/* ===== فواصل زمنية / الحصة الحالية ===== */
function periodNameAr(n){return ['الأولى','الثانية','الثالثة','الرابعة','الخامسة','السادسة','السابعة'][n-1]||''}
function timeRangeOfPeriod(n){const map={1:['p1_s','p1_e'],2:['p2_s','p2_e'],3:['p3_s','p3_e'],4:['p4_s','p4_e'],5:['p5_s','p5_e'],6:['p6_s','p6_e'],7:['p7_s','p7_e']}; const k=map[n]; if(!k) return ''; return `${TIMES[k[0]]}–${TIMES[k[1]]}`}
function currentSlot(dayName,now){
  const t=TIMES; const P=n=>({kind:'period',period:n}); const L=txt=>({kind:txt});
  if(inRangeHM(now,parseHM(t.assm_s),parseHM(t.assm_e))) return L('assembly');
  if(inRangeHM(now,parseHM(t.p1_s),parseHM(t.p1_e))) return P(1);
  if(inRangeHM(now,parseHM(t.p2_s),parseHM(t.p2_e))) return P(2);
  if(inRangeHM(now,parseHM(t.p3_s),parseHM(t.p3_e))) return P(3);
  if(inRangeHM(now,parseHM(t.break_s),parseHM(t.break_e))) return L('break');
  if(inRangeHM(now,parseHM(t.p4_s),parseHM(t.p4_e))) return P(4);
  if(inRangeHM(now,parseHM(t.p5_s),parseHM(t.p5_e))) return P(5);
  if(inRangeHM(now,parseHM(t.p6_s),parseHM(t.p6_e))) return P(6);
  if(inRangeHM(now,parseHM(t.pr_s),parseHM(t.pr_e))) return L('prayer');
  const isSunMon=(dayName==='الأحد'||dayName==='الاثنين');
  if(isSunMon && inRangeHM(now,parseHM(t.p7_s),parseHM(t.p7_e))) return P(7);
  return L('dismiss'); }
function minutesUntil(hhmm, now=new Date()){const [H,M]=String(hhmm||'').split(':').map(Number); const end=new Date(now); end.setHours(H||0,M||0,0,0); const diff=Math.ceil((end-now)/60000); return diff<0?0:diff;}

/* ===== لوحات الشعب ===== */
const CLASSES={
  first:Array.from({length:7},(_,i)=>({grade:'أول',section:String(i+1)})).map(x=>({...x,classId:`${x.grade}-${x.section}`})),
  second:Array.from({length:5},(_,i)=>({grade:'ثاني',section:String(i+1)})).map(x=>({...x,classId:`${x.grade}-${x.section}`})),
  third:Array.from({length:5},(_,i)=>({grade:'ثالث',section:String(i+1)})).map(x=>({...x,classId:`${x.grade}-${x.section}`}))
};
let TIMETABLE = ls.get('smart_timetable', []);
let TEACHERS  = ls.get('smart_teachers_list', []);
let SUBJECTS  = ls.get('smart_subjects_list', []);
let PHONEBOOK = ls.get('smart_phonebook', {});
let ABSENCES  = ls.get('smart_absences', {});
let DAYS_LIST = ['الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس'];

function refreshDatalists(){
  $('#teachersList').innerHTML = (TEACHERS||[]).map(n=>`<option value="${n}">`).join('');
  $('#classesList').innerHTML = [].concat(
    CLASSES.first.map(x=>x.classId), CLASSES.second.map(x=>x.classId), CLASSES.third.map(x=>x.classId)
  ).map(v=>`<option value="${v}">`).join('');
  $('#subjectsList').innerHTML = (SUBJECTS||[]).map(n=>`<option value="${n}">`).join('');
}

/* رسم البلاطات + المؤشر */
function renderBands(){
  const mk=cls=>`<div class="tile" id="tile_${cls.classId}">
    <button class="abs-btn" data-class="${cls.classId}">غياب</button>
    <button class="edit-btn" data-class="${cls.classId}">تحرير</button>
    <div class="badge">${cls.grade} — شعبة ${toArabicDigits(cls.section)}</div>
    <div class="section">${cls.grade} ${toArabicDigits(cls.section)}</div>
    <div class="subject empty">—</div>
    <div class="teacher"></div>
    <div class="room"></div>
    <div class="state"></div>
  </div>`;

  const firstTiles = CLASSES.first.map(mk).join('') + `
    <div class="mid-indicator" id="midIndicator">
      <div class="mid-card">
        <div class="mid-left">
          <div class="mid-title" id="mid-phase">—</div>
          <div class="mid-sub" id="mid-range">—</div>
        </div>
        <div class="bat">
          <div class="bat-shell"><div id="batFill" class="bat-fill"></div></div>
          <div class="bat-num"><span id="mid-num">--</span> دقيقة</div>
        </div>
      </div>
    </div>`;
  $('#band_first').innerHTML=firstTiles;

  $('#band_second').innerHTML=CLASSES.second.map(mk).join('');
  $('#band_third').innerHTML=CLASSES.third.map(mk).join('');

  $$('.abs-btn').forEach(b=>b.onclick=()=>EDIT_ENABLED?openAbsForm(b.dataset.class):alert('التحرير مقفول.'));
  $$('.edit-btn').forEach(b=>b.onclick=()=>EDIT_ENABLED?openEditForm(b.dataset.class):alert('التحرير مقفول.'));
}

function findEntry(day,period,classId){return TIMETABLE.find(r=>r.day===day && Number(r.period)===Number(period) && r.classId===classId)}
function absKey(day,period,classId){return `${day}|${period}|${classId}`;}
function clearAbsence(day,period,classId){delete ABSENCES[absKey(day,period,classId)]; ls.set('smart_absences', ABSENCES); updateAll();}

/* اسم مختصر للمعلم */
function shortTeacher(name){return String(name||'').trim().split(/\s+/)[0]||'';}

/* تحديث البلاطات */
function updateTiles(dayName,now){
  const slot=currentSlot(dayName,now);
  const classes=[...CLASSES.first,...CLASSES.second,...CLASSES.third];
  classes.forEach(cls=>{
    const tile=$(`#tile_${cls.classId}`); if(!tile) return;
    const subEl=tile.querySelector('.subject'), tEl=tile.querySelector('.teacher'), rEl=tile.querySelector('.room'), sEl=tile.querySelector('.state');
    tile.classList.remove('absent'); tile.querySelectorAll('.chip,.abs-form,.edit-form,.abs-clear').forEach(n=>n.remove());

    if(slot.kind==='period'){
      const ent=findEntry(dayName, slot.period, cls.classId);
      const ab=ABSENCES[absKey(dayName,slot.period,cls.classId)];
      if(ent){
        subEl.textContent=ent.subject||'—'; subEl.classList.remove('empty');
        if(String(ent.subject||'').includes('انتظار')){ tEl.textContent = shortTeacher(ent.teacher||''); }
        else{ tEl.textContent = ent.teacher ? `${ent.teacher}` : ''; }
        rEl.textContent=ent.room?`قاعة: ${ent.room}`:'';
      } else {
        subEl.textContent='— لا حصة —'; subEl.classList.add('empty'); tEl.textContent=''; rEl.textContent='';
      }
      sEl.textContent=`الحصة ${toArabicDigits(slot.period)} — ${timeRangeOfPeriod(slot.period)}`;

      if(ab){
        tile.classList.add('absent');
        const c1=document.createElement('div'); c1.className='chip'; c1.textContent=`غياب: ${ab.absent||'—'}`;
        const c2=document.createElement('div'); c2.className='chip'; c2.textContent=`التغطية: ${ab.cover||'—'}`;
        sEl.insertAdjacentElement('beforebegin', c1); sEl.insertAdjacentElement('beforebegin', c2);
        tEl.textContent = `غائب: ${ab.absent||'—'} — بديل: ${ab.cover||'—'}`;
        const clr=document.createElement('button'); clr.className='abs-clear'; clr.textContent='إلغاء الغياب';
        clr.onclick=()=>EDIT_ENABLED?clearAbsence(dayName, slot.period, cls.classId):alert('التحرير مقفول.');
        tile.appendChild(clr);
      }
    } else {
      const states={assembly:'👋 الاصطفاف',break:'☕️ فسحة',prayer:'🕌 صلاة',dismiss:'🏁 خارج الدوام'};
      subEl.textContent=states[slot.kind]||'—'; subEl.classList.remove('empty'); tEl.textContent=''; rEl.textContent=''; sEl.textContent='';
    }
  });
}

/* نماذج الغياب/التحرير */
function openAbsForm(classId){
  const now=new Date(); const day=dayNameArabicFromDate(now); const slot=currentSlot(day,now);
  if(slot.kind!=='period'){ return alert('ليست ضمن وقت حصة.'); }
  if(!EDIT_ENABLED){ return alert('التحرير مقفول. افتح القفل من أيقونة القفل.'); }
  const period=slot.period; const tile=$(`#tile_${classId}`); if(!tile) return;
  tile.querySelectorAll('.abs-form').forEach(n=>n.remove());
  const ent=findEntry(day, period, classId) || {};
  const ab=ABSENCES[`${day}|${period}|${classId}`] || {absent:(ent.teacher||''), cover:''};
  const form=document.createElement('div'); form.className='abs-form';
  form.innerHTML=`<h5>غياب/تغطية — ${day} الحصة ${toArabicDigits(period)}</h5>
    <div class="row">
      <input id="af_abs_${classId}" list="teachersList" placeholder="المعلم الغائب" value="${ab.absent||''}">
      <input id="af_cov_${classId}" list="teachersList" placeholder="المعلم المكلّف بالتغطية" value="${ab.cover||''}">
    </div>
    <div class="actions">
      <button class="mini" id="af_save_${classId}">حفظ</button>
      <button class="mini" id="af_cancel_${classId}">إلغاء</button>
    </div>`;
  tile.appendChild(form);
  $('#af_cancel_'+classId).onclick = ()=>form.remove();
  $('#af_save_'+classId).onclick = ()=>{
    const absent=$('#af_abs_'+classId).value.trim();
    const cover=$('#af_cov_'+classId).value.trim();
    ABSENCES[`${day}|${period}|${classId}`]={absent,cover};
    ls.set('smart_absences', ABSENCES);
    if(absent && !TEACHERS.includes(absent)) TEACHERS.push(absent);
    if(cover && !TEACHERS.includes(cover)) TEACHERS.push(cover);
    ls.set('smart_teachers_list', TEACHERS);
    refreshDatalists();
    form.remove(); updateAll();
  };
}
function openEditForm(classId){
  const now=new Date(); const day=dayNameArabicFromDate(now); const slot=currentSlot(day,now);
  if(slot.kind!=='period'){ return alert('ليست ضمن وقت حصة.'); }
  if(!EDIT_ENABLED){ return alert('التحرير مقفول. افتح القفل من أيقونة القفل.'); }
  const period=slot.period; const tile=$(`#tile_${classId}`); if(!tile) return;
  tile.querySelectorAll('.edit-form').forEach(n=>n.remove());
  const ent=findEntry(day, period, classId) || {day,period,classId,subject:'',teacher:'',room:''};
  const form=document.createElement('div'); form.className='edit-form';
  form.innerHTML=`<h5>تحرير المادة/المعلم — ${day} الحصة ${toArabicDigits(period)}</h5>
    <div class="row">
      <input id="ef_sub_${classId}" list="subjectsList" placeholder="المادة" value="${ent.subject||''}">
      <input id="ef_tch_${classId}" list="teachersList" placeholder="المعلم" value="${ent.teacher||''}">
    </div>
    <div class="actions">
      <button class="mini" id="ef_save_${classId}">حفظ</button>
      <button class="mini" id="ef_cancel_${classId}">إلغاء</button>
    </div>`;
  tile.appendChild(form);
  $('#ef_cancel_'+classId).onclick = ()=>form.remove();
  $('#ef_save_'+classId).onclick = ()=>{
    const subject=$('#ef_sub_'+classId).value.trim();
    const teacher=$('#ef_tch_'+classId).value.trim();
    const idx = TIMETABLE.findIndex(r=>r.day===day && r.period===period && r.classId===classId);
    if(idx>=0){ TIMETABLE[idx].subject=subject; TIMETABLE[idx].teacher=teacher; }
    else { TIMETABLE.push({day,period,classId,subject,teacher,room:''}); }
    ls.set('smart_timetable', TIMETABLE);
    if(subject && !SUBJECTS.includes(subject)){ SUBJECTS.push(subject); ls.set('smart_subjects_list', SUBJECTS); }
    if(teacher && !TEACHERS.includes(teacher)){ TEACHERS.push(teacher); ls.set('smart_teachers_list', TEACHERS); }
    refreshDatalists();
    form.remove(); updateAll();
  };
}

/* ===== عمود المناوبة/الإشراف ===== */
let DUTY_FIXED = ls.get('smart_duty_fixed', {}); // { 'الأحد': {names: ['','','',...]} }
function ensureDutyFixed(day){
  DUTY_FIXED[day] ||= {names: Array(7).fill('')};
  const arr = DUTY_FIXED[day].names;
  while(arr.length<7) arr.push('');
  if(arr.length>7) arr.length=7;
  return DUTY_FIXED[day];
}
function currentDutyPhase(now=new Date()){
  const m = now.getHours()*60 + now.getMinutes();
  const sBreak = hmToMin(TIMES.break_s);
  const eBreak = hmToMin(TIMES.break_e);
  const sP6 = hmToMin(TIMES.p6_s);
  const sP7 = hmToMin(TIMES.p7_s);
  const depEnd = 13*60 + 45;
  if(m>=390 && m<420) return {key:'morning', label:'المناوبة الصباحية', start:'06:30', end:'07:00'};
  if(m>=sBreak && m<eBreak) return {key:'break', label:'إشراف الفسحة', start:TIMES.break_s, end:TIMES.break_e};
  if(m>=sP6 && m<sP7) return {key:'prayer', label:'إشراف صلاة الظهر', start:TIMES.p6_s, end:TIMES.p7_s};
  if(m>=sP7 && m<depEnd) return {key:'afternoon', label:'مناوبة الانصراف', start:TIMES.p7_s, end:'13:45'};
  return {key:'other', label:'—', start:'', end:''};
}
function renderDutyPanel(day){
  const state = ensureDutyFixed(day);
  const phase = currentDutyPhase(new Date());
  $('#phaseLabel').textContent = `${phase.label} ${phase.start && phase.end ? `(${phase.start}–${phase.end})` : ''}`;

  const rows = state.names.map((name,idx)=>`
    <div class="duty-row" data-idx="${idx}">
      <div class="duty-name">
        <input ${EDIT_ENABLED?'':'disabled'} list="teachersList" placeholder="اسم المعلّم" value="${name||''}">
      </div>
      <div class="duty-actions">
        <button class="mini" data-wa="${idx}">واتساب</button>
        <button class="mini" data-up="${idx}">▲</button>
        <button class="mini" data-dn="${idx}">▼</button>
        <button class="mini" data-clr="${idx}">✕</button>
      </div>
    </div>
  `).join('');
  $('#dutyList').innerHTML = rows;

  $$('#dutyList .duty-row input').forEach(inp=>{
    inp.onchange = ()=>{
      const idx = parseInt(inp.closest('.duty-row').dataset.idx);
      state.names[idx] = inp.value.trim();
      ls.set('smart_duty_fixed', DUTY_FIXED);
      if(inp.value && !TEACHERS.includes(inp.value)){ TEACHERS.push(inp.value); ls.set('smart_teachers_list', TEACHERS); refreshDatalists(); }
    };
  });
  $$('#dutyList [data-up]').forEach(btn=>btn.onclick=()=>{
    if(!EDIT_ENABLED) return alert('التحرير مقفول.');
    const i=parseInt(btn.dataset.up); if(i<=0) return;
    [state.names[i-1],state.names[i]]=[state.names[i],state.names[i-1]];
    ls.set('smart_duty_fixed', DUTY_FIXED); renderDutyPanel(day);
  });
  $$('#dutyList [data-dn]').forEach(btn=>btn.onclick=()=>{
    if(!EDIT_ENABLED) return alert('التحرير مقفول.');
    const i=parseInt(btn.dataset.dn); if(i>=state.names.length-1) return;
    [state.names[i],state.names[i+1]]=[state.names[i+1],state.names[i]];
    ls.set('smart_duty_fixed', DUTY_FIXED); renderDutyPanel(day);
  });
  $$('#dutyList [data-clr]').forEach(btn=>btn.onclick=()=>{
    if(!EDIT_ENABLED) return alert('التحرير مقفول.');
    state.names[parseInt(btn.dataset.clr)]='';
    ls.set('smart_duty_fixed', DUTY_FIXED); renderDutyPanel(day);
  });

  // واتساب: معالجة عدم وجود رقم — نطلبه ونحفظه
  $$('#dutyList [data-wa]').forEach(btn=>btn.onclick=()=>{
    const i=parseInt(btn.dataset.wa); const name=state.names[i];
    if(!name) return alert('أدخل اسم المعلّم أولاً.');
    let rec = PHONEBOOK[name] || {};
    let phone = String(rec.phone||'').replace(/[^0-9]/g,'');

    if(!phone){
      const inp = prompt('لا يوجد رقم لهذا المعلّم.\nأدخل رقم الجوال بصيغة دولية (مثال 9665XXXXXXXX):');
      if(!inp) return;
      const digits = String(inp).replace(/[^0-9]/g,'');
      if(digits.length<9){ alert('رقم غير صالح.'); return; }
      phone = digits;
      PHONEBOOK[name] = {...rec, phone};
      ls.set('smart_phonebook', PHONEBOOK);
    }

    const now=new Date(); const dayName=dayNameArabicFromDate(now);
    const ph=currentDutyPhase(now);
    const msg=`السلام عليكم
تذكير تكليف «${ph.label}»
اليوم: ${dayName} — ${fmtHijri(now)}
الفترة: ${ph.start || '-'} ${ph.end? 'إلى '+ph.end : ''}
جزاكم الله خيرًا على تعاونكم.`;
    const url=`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
    window.open(url,'_blank');
  });

  $('#dutySave').onclick = ()=>{ ls.set('smart_duty_fixed', DUTY_FIXED); alert('تم حفظ قائمة المناوبين/المشرفين لليوم ✔'); };
  $('#dutyClear').onclick = ()=>{
    if(!EDIT_ENABLED) return alert('التحرير مقفول.');
    DUTY_FIXED[day]={names:Array(7).fill('')}; ls.set('smart_duty_fixed', DUTY_FIXED); renderDutyPanel(day);
  };
  $('#dutySuggest').onclick = ()=>{
    if(!EDIT_ENABLED) return alert('التحرير مقفول.');
    const unique = Array.from(new Set(TEACHERS||[]));
    unique.sort((a,b)=> (TIMETABLE.filter(r=>r.day===day && r.teacher===a).length - TIMETABLE.filter(r=>r.day===day && r.teacher===b).length) || a.localeCompare(b,'ar'));
    DUTY_FIXED[day]={names: unique.slice(0,7)};
    ls.set('smart_duty_fixed', DUTY_FIXED);
    renderDutyPanel(day);
  };

  // محاذاة رأسياً: من أعلى "أول" إلى نهاية "ثالث"
  alignDutyPanelToBands();
}

/* ===== مؤشر البطارية (حُدِّث موضعه) ===== */
let _lastRem=null;
function updateMidIndicator(dayName, now){
  const elPhase=$('#mid-phase'), elRange=$('#mid-range'), elFill=$('#batFill'), elNum=$('#mid-num');
  if(!(elPhase&&elRange&&elFill&&elNum)) return;
  const slot=currentSlot(dayName, now);
  if(slot.kind==='period'){
    const sKey=`p${slot.period}_s`, eKey=`p${slot.period}_e`;
    const startMin = hmToMin(TIMES[sKey]), endMin=hmToMin(TIMES[eKey]);
    const total = Math.max(1, endMin-startMin);
    const rem = minutesUntil(TIMES[eKey], now);
    const gone = total - rem; const pct = Math.max(0, Math.min(100, Math.round(gone*100/total)));
    elPhase.textContent = `الحصة ${periodNameAr(slot.period)}`;
    elRange.textContent = `${TIMES[sKey]}–${TIMES[eKey]}`;
    elFill.style.width = pct + '%';
    const hue = Math.max(0, Math.min(120, Math.round(120 * (rem/total))));
    elFill.style.background = `linear-gradient(90deg,hsl(${Math.max(hue-20,0)},75%,60%),hsl(${hue},70%,48%))`;
    if(_lastRem===null || _lastRem!==rem){ elNum.classList.remove('flip'); void elNum.offsetWidth; elNum.classList.add('flip'); _lastRem=rem; }
    elNum.textContent = String(rem);
  }else{
    const map={assembly:'👋 الاصطفاف',break:'☕️ فسحة',prayer:'🕌 صلاة',dismiss:'🏁 خارج الدوام'};
    elPhase.textContent = map[slot.kind]||'—';
    elRange.textContent = '—';
    elFill.style.width = '0%';
    elNum.textContent='--';
    _lastRem=null;
  }
}

/* ===== محاذاة عمود المناوبة مع لوحات الشعب رأسياً ===== */
function alignDutyPanelToBands(){
  const board=$('.board'), first=$('#wrap_first'), third=$('#wrap_third'), panel=$('#dutyPanel');
  if(!(board && first && third && panel)) return;
  const br = board.getBoundingClientRect();
  const r1 = first.getBoundingClientRect();
  const r3 = third.getBoundingClientRect();
  const topOffset = r1.top - br.top;
  const minH = (r3.top + r3.height) - r1.top;
  panel.style.alignSelf='start';
  panel.style.marginTop = `${Math.max(0, topOffset)}px`;
  panel.style.minHeight = `${Math.max(320, Math.round(minH))}px`;
}

/* ===== Excel: استيراد الجدول ===== */
function readWorkbookSmart(file, cb){
  const ext=(file.name.split('.').pop()||'').toLowerCase();
  const reader=new FileReader();
  reader.onerror=()=>alert('تعذّر قراءة الملف.');
  if(ext==='csv'){
    reader.onload=e=>{ try{
      let text=e.target.result;
      if((text.match(/;/g)||[]).length>(text.match(/,/g)||[]).length){ text=text.replace(/;/g,','); }
      const wb=XLSX.read(text,{type:'string'}); cb(wb);
    }catch(err){ console.error(err); alert('CSV غير صالح.'); } };
    reader.readAsText(file,'utf-8');
  } else {
    reader.onload=e=>{ try{ const data=new Uint8Array(e.target.result); const wb=XLSX.read(data,{type:'array'}); cb(wb); }catch(err){ console.error(err); alert('ملف Excel غير صالح.'); } };
    reader.readAsArrayBuffer(file);
  }
}
function cell(ws, r, c){ return ws[XLSX.utils.encode_cell({r,c})]?.v ?? ''; }
function sheetSize(ws){ const ref=ws['!ref']; if(!ref) return {R:0,C:0,range:null}; const range=XLSX.utils.decode_range(ref); return {R:range.e.r+1, C:range.e.c+1, range}; }

const DAY_CANON={'الأحد':'الأحد','الاحد':'الأحد','أحد':'الأحد','احد':'الأحد','sun':'الأحد','sunday':'الأحد',
  'الاثنين':'الاثنين','إثنين':'الاثنين','اثنين':'الاثنين','mon':'الاثنين','monday':'الاثنين',
  'الثلاثاء':'الثلاثاء','ثلاثاء':'الثلاثاء','tue':'الثلاثاء','tuesday':'الثلاثاء',
  'الأربعاء':'الأربعاء','اربعاء':'الأربعاء','wed':'الأربعاء','wednesday':'الأربعاء',
  'الخميس':'الخميس','thu':'الخميس','thursday':'الخميس'};
function canonDay(v){ const s=String(v||'').trim(); const k=s.toLowerCase(); return DAY_CANON[k] || DAY_CANON[s] || ''; }
function looksPeriod(v){
  const s=String(v||'').trim();
  if(/^[1-7١-٧]$/.test(s)) return parseInt(s.replace(/[١-٧]/g,ch=>'1234567'['١٢٣٤٥٦٧'.indexOf(ch)]));
  const w=s.replace(/\s/g,'');
  const dict={'الأولى':1,'الاولى':1,'اولى':1,'الثانية':2,'الثالثة':3,'الرابعة':4,'الخامسة':5,'السادسة':6,'السابعة':7};
  return dict[w]||NaN;
}
function looksTimeRange(v){ const s=String(v||''); const m=s.match(/(\d{1,2}:\d{2}).*?(\d{1,2}:\d{2})/); return m? {start:m[1], end:m[2]} : null; }
function normalizeClassId(v){
  v=String(v||'').trim().replace(/[–—]/g,'-').replace(/\s*-\s*/g,'-').replace(/اول/g,'أول');
  const m=v.match(/(أول|ثاني|ثالث)\s*-\s*([0-9٠-٩]+)/);
  if(m){ const map='٠١٢٣٤٥٦٧٨٩', n=parseInt(String(m[2]).replace(/[٠-٩]/g,ch=>String(map.indexOf(ch))),10); return `${m[1]}-${n}`; }
  const m2=v.match(/(أول|ثاني|ثالث)\s*(?:-|\s)?\s*(الأول|الاول|اولى|الأولى|الثانية|الثالثة|الرابعة|الخامسة|السادسة|السابعة)/);
  const word2num={'الأول':1,'الاول':1,'اولى':1,'الأولى':1,'الثانية':2,'الثالثة':3,'الرابعة':4,'الخامسة':5,'السادسة':6,'السابعة':7};
  if(m2){ return `${m2[1]}-${word2num[m2[2]]||''}`; }
  return v;
}
function looksTeacher(s){
  s=String(s||'').trim();
  if(!s) return false;
  if(/^أ(\.|\/|\s)|^(أستاذ|معلم)/.test(s)) return true;
  if(/\s/.test(s) && !/[0-9]/.test(s) && s.length>=5) return true;
  return false;
}
function orderSubjectTeacher(a,b){ return (looksTeacher(a) && !looksTeacher(b)) ? {subject:b, teacher:a} : {subject:a, teacher:b}; }
function splitCellToSubjectTeacher(val){
  let s=String(val||'').trim();
  if(!s) return {subject:'', teacher:''};
  if(s.includes('\n')){
    const parts=s.split('\n').map(x=>x.trim()).filter(Boolean);
    if(parts.length>=2) return orderSubjectTeacher(parts[0], parts[1]);
    return {subject:parts[0], teacher:''};
  }
  const parts = s.split(/[-–—\/|،]/).map(x=>x.trim()).filter(Boolean);
  if(parts.length===2) return orderSubjectTeacher(parts[0], parts[1]);
  if(parts.length>2) return orderSubjectTeacher(parts[0], parts.slice(1).join(' '));
  return {subject:parts[0], teacher:''};
}
function buildTimetableFromSheet(ws){
  const {R,C}=sheetSize(ws);
  if(R<3 || C<3) throw new Error('ورقة صغيرة جدًا');

  // تعرّف الأيام لكل عمود
  const dayByCol = Array(C).fill(''); let lastDay='';
  for(let c=1;c<C;c++){
    const d0 = canonDay(cell(ws,0,c)), d1 = canonDay(cell(ws,1,c));
    if(d0) lastDay = d0;
    else if(d1) lastDay = d1;
    dayByCol[c]=lastDay;
  }

  // تعرّف الحصص والمدى الزمني
  const perByCol = Array(C).fill(null); const timeByCol = Array(C).fill(null); let lastPer=1;
  for(let c=1;c<C;c++){
    const v1 = cell(ws,1,c), p=looksPeriod(v1), tr=looksTimeRange(v1);
    if(!dayByCol[c]){ perByCol[c]=null; continue; }
    if(!dayByCol[c-1] || dayByCol[c]!==dayByCol[c-1]) lastPer=1;
    if(!isNaN(p)){ perByCol[c]=p; lastPer=p; } else { perByCol[c]=lastPer; lastPer = Math.min(7,lastPer+1); }
    if(tr) timeByCol[c]=tr;
  }

  // تحديث المواقيت إذا وُجدت
  const trMap = {};
  for(let c=1;c<C;c++){ const p=perByCol[c], tr=timeByCol[c]; if(tr && p>=1 && p<=7) trMap[p]=tr; }
  if(Object.keys(trMap).length>=4){
    for(const k in trMap){ const n=parseInt(k,10); TIMES[`p${n}_s`]=trMap[k].start; TIMES[`p${n}_e`]=trMap[k].end; }
    ls.set('smart_times', TIMES);
    setTimeInputs();
  }

  // بناء الجدول
  const tt=[]; const foundTeachers = new Set(TEACHERS||[]); const foundSubjects = new Set(SUBJECTS||[]);
  for(let r=2;r<R;r++){
    const clsRaw = cell(ws,r,0); const classId = normalizeClassId(clsRaw);
    if(!classId || !/^(أول|ثاني|ثالث)\-\d+$/.test(classId)) continue;
    for(let c=1;c<C;c++){
      const day = dayByCol[c]; const period = perByCol[c]; if(!day || !period) continue;
      const val = cell(ws,r,c); if(!String(val||'').trim()) continue;
      const {subject, teacher} = splitCellToSubjectTeacher(val);
      if(subject || teacher){
        tt.push({day,period:parseInt(period,10),classId,subject,teacher,room:''});
        if(subject) foundSubjects.add(subject);
        if(teacher) foundTeachers.add(teacher);
      }
    }
  }
  if(tt.length===0) throw new Error('تعذّر التعرّف على الجدول.');
  TIMETABLE = tt;
  TEACHERS=Array.from(foundTeachers); SUBJECTS=Array.from(foundSubjects);
  ls.set('smart_timetable', TIMETABLE); ls.set('smart_teachers_list', TEACHERS); ls.set('smart_subjects_list', SUBJECTS);
  refreshDatalists();
}

/* ===== دفتر الهواتف ===== */
function importPhonebookFromSheet(ws){
  const {R,C}=sheetSize(ws);
  const headers=[]; for(let c=0;c<C;c++) headers.push(String(cell(ws,0,c)||'').trim().toLowerCase());
  const idxOf = (names)=> headers.findIndex(h=>names.some(n=>h.includes(n)));
  const iName = idxOf(['الاسم','name']);
  const iPhone= idxOf(['جوال','هاتف','phone','mobile']);
  const iId   = idxOf(['هوية','سجل','id']);
  const iSpec = idxOf(['تخصص','spec','subject']);
  const book={...PHONEBOOK};
  for(let r=1;r<R;r++){
    const name = iName>=0? String(cell(ws,r,iName)||'').trim() : '';
    if(!name) continue;
    const rawPhone = iPhone>=0? String(cell(ws,r,iPhone)||'') : '';
    const phone = rawPhone.replace(/[^\d]/g,'');
    const natId = iId>=0? String(cell(ws,r,iId)||'').trim() : '';
    const spec  = iSpec>=0? String(cell(ws,r,iSpec)||'').trim() : '';
    book[name]={phone, natId, spec};
  }
  PHONEBOOK = book; ls.set('smart_phonebook', PHONEBOOK);
  Object.keys(book).forEach(n=>{ if(n && !TEACHERS.includes(n)) TEACHERS.push(n); });
  ls.set('smart_teachers_list', TEACHERS);
  refreshDatalists();
}

/* ===== تحديث عام ===== */
let _lastPhaseKey='init';
function updateAll(){
  const now=new Date();
  const day=dayNameArabicFromDate(now);
  updateTiles(day, now);
  updateMidIndicator(day, now);
  const ph=currentDutyPhase(now).key;
  if(ph!==_lastPhaseKey){ _lastPhaseKey=ph; renderDutyPanel(day); }
  alignDutyPanelToBands();
}

/* ===== الساعة + التاريخ ===== */
function pad2(n){return String(n).padStart(2,'0')}
function updateClock(){
  const now=new Date();
  $('#clock').textContent = `${pad2(now.getHours())}:${pad2(now.getMinutes())}:${pad2(now.getSeconds())}`;
  const day=dayNameArabicFromDate(now);
  $('#dateWeek').textContent = `${day} — ${fmtHijri(now)}`;
  updateMidIndicator(day, now);
}

/* ===== قوائم الأيقونات ===== */
function wireMenus(){
  const pairs=[['btnLock','menuLock'],['btnImport','menuImport'],['btnTimes','menuTimes'],['btnWA','menuWA'],['btnCloud','menuCloud']];
  pairs.forEach(([b,m])=>{
    const btn=$('#'+b), menu=$('#'+m);
    if(!btn||!menu) return;
    btn.onclick=(e)=>{ e.stopPropagation(); if(btn.hasAttribute('disabled')) return; closeAll(menu); menu.classList.toggle('open'); };
  });
  document.addEventListener('click', ()=>closeAll());
  function closeAll(except){
    ['menuLock','menuImport','menuTimes','menuWA','menuCloud'].forEach(id=>{
      if(except && except.id===id) return;
      const el=$('#'+id); if(el) el.classList.remove('open');
    });
  }
}

/* ===== ربط الواجهة ===== */
function wireUI(){
  // قفل/فتح
  $('#setPin').onclick = ()=>promptSetPin();
  $('#toggleEdit').onclick = ()=>promptToggleEdit();

  // مواقيت
  setTimeInputs();
  $('#applySeason').onclick = ()=>{
    const mode = $('#seasonMode').value;
    if(mode==='summer') TIMES={...PRESET_SUMMER};
    else if(mode==='winter') TIMES={...PRESET_WINTER};
    ls.set('smart_times', TIMES); setTimeInputs(); alert('تم تطبيق المواقيت المسبقة ✔');
    updateAll();
  };
  $('#saveTimes').onclick = ()=>{ saveTimesFromInputs(); alert('تم حفظ المواقيت ✔'); updateAll(); };

  // استيراد الجدول
  $('#pickTable').onclick = ()=>$('#fileTable').click();
  $('#fileTable').addEventListener('change', (ev)=>{
    const f=ev.target.files && ev.target.files[0]; if(!f) return;
    readWorkbookSmart(f, (wb)=>{
      try{
        const ws = wb.Sheets[wb.SheetNames[0]];
        buildTimetableFromSheet(ws);
        updateAll();
        alert('✅ تم استيراد الجدول وبناؤه: '+TIMETABLE.length+' سجل.');
      }catch(err){
        console.error(err);
        alert('تعذّر التعرّف على الجدول. يرجى التأكد من وجود صف للأيام وصف للحصص والعمود الأول للشُعب.');
      }
    });
    ev.target.value='';
  });

  // واتساب: دفتر الهواتف
  $('#pickPhonebook').onclick = ()=>$('#filePhonebook').click();
  $('#filePhonebook').addEventListener('change', (ev)=>{
    const f=ev.target.files && ev.target.files[0]; if(!f) return;
    readWorkbookSmart(f, (wb)=>{
      try{
        const ws = wb.Sheets[wb.SheetNames[0]];
        importPhonebookFromSheet(ws);
        alert('✅ تم استيراد دفتر الهواتف.');
      }catch(err){
        console.error(err);
        alert('تعذّر استيراد دفتر الهواتف.');
      }
    });
    ev.target.value='';
  });

  // سحابة JSON (حفظ/استعادة)
  $('#saveSnapshot').onclick = ()=>{
    const payload = { TIMES, TIMETABLE, TEACHERS, SUBJECTS, PHONEBOOK, ABSENCES, DUTY_FIXED, EDIT_ENABLED, ADMIN_HASH };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob);
    a.download='smart_board_snapshot.json'; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href), 500);
  };
  $('#loadSnapshot').onclick = ()=>$('#snapshotIn').click();
  $('#snapshotIn').addEventListener('change', (ev)=>{
    const f=ev.target.files && ev.target.files[0]; if(!f) return;
    const reader=new FileReader();
    reader.onload=e=>{
      try{
        const data=JSON.parse(e.target.result);
        if(data.TIMES){ TIMES=data.TIMES; ls.set('smart_times',TIMES); setTimeInputs(); }
        if(data.TIMETABLE){ TIMETABLE=data.TIMETABLE; ls.set('smart_timetable',TIMETABLE); }
        if(data.TEACHERS){ TEACHERS=data.TEACHERS; ls.set('smart_teachers_list',TEACHERS); }
        if(data.SUBJECTS){ SUBJECTS=data.SUBJECTS; ls.set('smart_subjects_list',SUBJECTS); }
        if(data.PHONEBOOK){ PHONEBOOK=data.PHONEBOOK; ls.set('smart_phonebook',PHONEBOOK); }
        if(data.ABSENCES){ ABSENCES=data.ABSENCES; ls.set('smart_absences',ABSENCES); }
        if(data.DUTY_FIXED){ DUTY_FIXED=data.DUTY_FIXED; ls.set('smart_duty_fixed',DUTY_FIXED); }
        if(typeof data.EDIT_ENABLED==='boolean'){ EDIT_ENABLED=data.EDIT_ENABLED; ls.set('smart_edit_unlocked',EDIT_ENABLED); }
        if(data.ADMIN_HASH){ ADMIN_HASH=data.ADMIN_HASH; ls.set('smart_admin_hash',ADMIN_HASH); }
        refreshDatalists(); setLockUI(); updateAll();
        alert('✅ تم استعادة البيانات.');
      }catch(err){ console.error(err); alert('تعذّر قراءة الملف.'); }
    };
    reader.readAsText(f,'utf-8');
    ev.target.value='';
  });
}

/* ===== تشغيل أولي ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  renderBands();
  refreshDatalists();
  setLockUI();
  wireMenus();
  wireUI();
  updateAll();
  updateClock();
  window.addEventListener('resize', alignDutyPanelToBands);
  setInterval(updateClock, 1000);
  setInterval(updateAll, 15000);
});
</script>
</body>
</html>
