<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© â€” Ø¹Ø±Ø¶ Ù„Ø­Ø¸ÙŠ</title>

  <!-- Ø§Ù„Ù‡ÙˆÙŠØ© -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&family=Cairo:wght@700&display=swap" rel="stylesheet">
  <!-- Ù‚Ø±Ø§Ø¡Ø© Excel/CSV -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --moe-green:#18a27e; --moe-ink:#0f3d33; --light:#f9fefb; --line:#e7f2ee;
      --first:#0fb3b0; --second:#7bc35b; --third:#4a8fff;
      --danger-bg:#fdecec; --danger-border:#f5c2c2; --danger-ink:#8a1f1f;
      --chip:#f3fbf8;
 --chip-border:#cfe8e1; --ink:#0b4035;
      --ctl-bg:#ffffff; --ctl-border:#e4efec;
      --duty-accent:#e25353;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;color:#111;font-family:"Tajawal",system-ui;
      background:
        radial-gradient(1200px 600px at 10% 0%, #ffffff 0%, #f2fffa 100%),
        linear-gradient(180deg,#f9fff9 0%, #f4fffa 100%);
    }

    /* ===== Ø§Ù„Ù‡ÙŠØ¯Ø± ===== */
    header{position:sticky;top:0;z-index:60;background:linear-gradient(90deg,var(--moe-green),#27b394);color:#fff;border-bottom:4px solid #0d5e49}
    .h-wrap{max-width:1500px;margin:0 auto;padding:10px 16px}
    .h-row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .title{font-family:"Cairo";font-size:20px;font-weight:800;letter-spacing:.3px}
    .clock{font-family:"Cairo";font-weight:800;font-size:clamp(22px,3.4vw,32px);background:transparent;color:#fff;min-width:128px;text-align:center;letter-spacing:.5px}
    .dateweek{font-size:14px;font-weight:800;color:#eafff7;margin-top:6px}

    main{max-width:1500px;margin:0 auto;padding:10px 14px 80px}

    /* ===== Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ===== */
    .hero{display:flex;flex-direction:column;align-items:center;gap:10px;margin:6px 0 10px;text-align:center}
    .iconbar{display:flex;gap:8px;align-items:center;justify-content:center;flex-wrap:wrap}
    .ib{width:38px;height:38px;border-radius:12px;background:#ffffffcc;backdrop-filter:blur(4px);display:inline-flex;align-items:center;justify-content:center;border:1px solid #d8e7e3;box-shadow:0 2px 10px #00000010;cursor:pointer;position:relative;transition:.2s}
    .ib:hover{transform:translateY(-1px);background:#f6fbf9}
    .ib svg{width:20px;height:20px;color:#0b534a}

    /* ===== Ø±ÙÙ‘ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø£Ø³ÙÙ„ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª ===== */
    .menus-shelf{display:none; width:100%; margin-top:8px}
    .hero.menu-open .menus-shelf{display:block}
    .menus-shelf-inner{position:relative; width:100%}
    .menu{
      display:none;
      background:#fff;border:1px solid #dceae7;border-radius:12px;
      box-shadow:0 12px 30px #00000014;padding:10px;z-index:1;
      width:max-content;min-width:320px;max-width:min(92vw,820px);max-height:min(70vh,560px);overflow:auto;
      margin-inline-start:var(--menu-offset,0px);
    }
    .menu.open{display:inline-block}
    .menu h4{margin:4px 6px 8px;font-size:13px;color:#0b4035}
    .menu .row{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
    .menu input,.menu button,.menu select{width:100%;padding:6px 8px;border:1px solid #d8e7e3;border-radius:8px;background:#fff;font-family:"Tajawal";font-size:12px}
    .btn-ghost{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--chip-border);background:var(--chip);padding:6px 10px;border-radius:999px;font-size:12px;cursor:pointer}
    .btn-ghost:hover{background:#eefaf5}

    /* ===== Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ===== */
    .card{
      background:#fff;border:1px solid var(--line);border-radius:18px;padding:12px;
      box-shadow:0 6px 24px #28a48a22, 0 2px 10px #00000010;
    }

    /* ===== Ù„ÙˆØ­Ø© Ø§Ù„Ø´Ø¹Ø¨ + Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© ===== */
    .board{display:grid;grid-template-columns:1fr minmax(360px,480px);gap:10px;align-items:start}
    @media (max-width:1200px){ .board{grid-template-columns:1fr} }

    /* ===== Ù„ÙˆØ­Ø§Øª Ø§Ù„Ø´Ø¹Ø¨ ===== */
    .band-wrap{margin-top:6px}
    .bandTitle{font-weight:800;font-size:16px;margin:8px 0 4px;display:flex;align-items:center;gap:6px}
    .bandTitle .dot{width:10px;height:10px;border-radius:999px}
    .band{
      display:grid;gap:12px;padding:8px 4px;overflow:visible;
      grid-template-columns:repeat(5, minmax(220px,1fr));
    }
    @media (max-width:1100px){ .band{grid-template-columns:repeat(4,minmax(200px,1fr))} }
    @media (max-width:900px){ .band{grid-template-columns:repeat(2,minmax(200px,1fr))} }
    @media (max-width:520px){ .band{grid-template-columns:repeat(1,minmax(220px,1fr))} }

    .band.first{--accent:var(--first)}
    .band.second{--accent:var(--second)}
    .band.third{--accent:var(--third)}
    .band .tile{border-top:4px solid var(--accent)}

    .tile{
      position:relative;background:linear-gradient(180deg,#ffffff 0%,#fbfffd 100%);
      border:1px solid #dfeeea;border-radius:16px;padding:12px;min-height:168px;overflow:hidden;
      box-shadow:0 6px 18px #0a3e330e; transition:.2s;
      display:flex; flex-direction:column; justify-content:center;
    }
    .tile:hover{transform:translateY(-1px); box-shadow:0 10px 22px #0a3e3312}
    .tile.now{outline:2px solid var(--accent); box-shadow:0 8px 24px #0a3e331a}
    .badge{position:absolute;top:8px;left:8px;background:#e6fbf5;color:#0b534a;border:1px solid #bde7dc;padding:1px 8px;border-radius:999px;font-size:11px}

    .vstack{display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px; text-align:center; min-height:110px}
    .section{font-weight:800;color:#0b4035;font-size:15px}
    .subject{font-size:17px;font-weight:800;color:#0b2d28}
    .teacher{font-size:14px;color:#2d5a54}
    .room{display:none}

    .state{position:absolute;bottom:8px;left:8px;font-size:11px;color:#0b534a}
    .empty{color:#7b8;font-style:italic}

    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø´Ø¹Ø¨Ø© */
    .abs-btn,.edit-btn,.abs-clear{position:absolute;top:8px;background:#fff;border:1px solid #cfe8e1;color:#0b534a;padding:2px 8px;border-radius:999px;font-size:11px;cursor:pointer}
    .abs-btn{right:8px}
    .abs-clear{right:8px;top:38px;border-color:#f3b0b0;color:#b11}
    .edit-btn{left:8px}

    .abs-form,.edit-form{position:absolute;inset:auto 8px 8px 8px;background:#fff;border:1px solid #e9d3d3;border-radius:12px;padding:8px;box-shadow:0 8px 20px #0000001a;z-index:2}
    .abs-form h5,.edit-form h5{margin:0 0 6px;font-size:12px;color:#8a1f1f}
    .abs-form .row,.edit-form .row{display:grid;grid-template-columns:1fr;gap:6px}
    .abs-form input,.abs-form button,.abs-form select,.edit-form input,.edit-form button{width:100%;padding:6px 8px;border:1px solid #e6efec;border-radius:8px}
    .abs-form .actions,.edit-form .actions{display:flex;gap:6px;margin-top:6px;flex-wrap:wrap}

    .tile.absent{background:var(--danger-bg); border-color:var(--danger-border)}
    .tile.absent .badge{background:#fff0f0;color:var(--danger-ink);border-color:var(--danger-border)}
    .chip{display:inline-block;background:#fff;border:1px solid #e6efec;border-radius:999px;padding:2px 8px;font-size:11px;margin-top:4px}

    /* ===== Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ù…ØªÙˆØ³Ø· ===== */
    .mid-indicator{grid-column:3 / 6; grid-row:2; justify-self:center; display:flex; align-items:center; justify-content:center; margin-top:2px}
    @media (max-width:900px){ .mid-indicator{grid-column:1 / -1; grid-row:auto; justify-self:center} }
    .mid-card{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;background:#fff;border:1px solid #e0ece9;border-top:4px solid var(--first);border-radius:14px;padding:10px 12px;box-shadow:0 6px 16px #0000000f;min-width:320px}
    .mid-title{font-weight:800;color:#0b4035}
    .mid-sub{font-size:12px;color:#345}
    .bat{display:flex;align-items:center;gap:10px}
    .bat-shell{position:relative;width:280px;max-width:60vw;height:18px;border:2px solid #0b534a;border-radius:8px;overflow:hidden;background:linear-gradient(90deg,#fefefe,#f5fffb)}
    .bat-shell::after{content:"";position:absolute;right:-8px;top:3px;width:6px;height:12px;border:2px solid #0b534a;border-left:none;border-radius:0 6px 6px 0;background:#fff}
    .bat-fill{height:100%;width:0%;transition:width .7s ease; background:linear-gradient(90deg,#e65353,#ffd24d,#53c77a)}
    .bat-num{font-family:"Cairo";font-weight:900;font-size:18px;letter-spacing:.3px;color:#0b4035;min-width:86px;text-align:center}
    .flip{animation:flip .6s ease}
    @keyframes flip {0%{transform:rotateX(0)}50%{transform:rotateX(180deg)}100%{transform:rotateX(360deg)}}

    /* ===== Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©/Ø§Ù„Ø¥Ø´Ø±Ø§Ù ===== */
    .duty-card{
      position:sticky; top:60px;
      background:var(--ctl-bg);
      border:1px solid var(--danger-border);          /* Ø¥Ø·Ø§Ø± Ø£Ø­Ù…Ø± ÙˆØ§Ø¶Ø­ */
      border-top:4px solid var(--duty-accent);        /* Ø´Ø±ÙŠØ· Ø¹Ù„ÙˆÙŠ Ø£Ø­Ù…Ø± */
      border-radius:16px; padding:12px;
      box-shadow:0 6px 22px #ff5a5a14, 0 2px 10px #0000000d;
      width:100%;
    }
    .duty-title{margin:0 0 6px; font-size:15px; color:#0b4035; font-weight:800}
    .phase-pill{display:inline-block;border:1px dashed #dfe9e6;background:#f8fcfb;border-radius:999px;padding:3px 10px;font-size:12px;color:#0b4035}
    .duty-tools{display:flex; gap:6px; flex-wrap:wrap; margin:10px 0 8px}
    .duty-tools .btn-ghost{font-size:12px;padding:6px 10px}

    .duty-row{
      display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:center;
      border:1px solid #edf3f2; border-radius:12px; padding:8px 10px; margin-bottom:8px;
      background:linear-gradient(180deg,#ffffff 0%,#f9fffc 100%); font-size:14px; line-height:1.7
    }
    .drag-handle{cursor:grab; user-select:none; opacity:.6; padding:0 6px}
    .duty-row.dragging{opacity:.7}
    .duty-name input{width:100%; border:1px solid #e6efec; border-radius:10px; padding:8px 10px; font-size:14px}
    .duty-actions{display:flex; gap:6px}
    .mini{display:inline-flex; align-items:center; gap:4px; border:1px solid #e6efec; background:#fff; padding:6px 9px; border-radius:999px; font-size:12px; cursor:pointer}
    .mini:hover{background:#f9fcfb}

    /* Ø§Ù„Ø¹Ø¨Ø§Ø±Ø§Øª Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ÙŠØ© â€” Ø£ÙƒØ¨Ø± ÙˆØ¨Ø¯ÙˆÙ† Ù†Ø²ÙˆÙ„ Ø³Ø·Ø± */
    .duty-guide{margin-top:10px; border-top:1px dashed #e6efec; padding-top:8px}
    .duty-guide li{
      list-style:none;
      white-space:nowrap; overflow:hidden; text-overflow:ellipsis;   /* Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· */
      font-size:14.5px; line-height:2; color:#0b4035; opacity:.96;
      padding:2px 4px;
    }

    /* ===== Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø¯Ø§Ø®Ù„ Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§ØªØ³Ø§Ø¨ ===== */
    .tlist{margin-top:8px; display:grid; grid-template-columns:1fr; gap:6px}
    .trow{display:grid; grid-template-columns:1fr auto; gap:8px; align-items:center; border:1px solid #edf3f2; border-radius:10px; padding:8px 10px; background:#fff}
    .tname{font-weight:700; color:#0b4035}
    .tmeta{font-size:12px; color:#2d5a54; opacity:.9}
    .wa-btn{border:1px solid #cfe8e1; background:#f3fbf8; border-radius:999px; padding:6px 10px; font-size:12px; cursor:pointer}

    @media (max-width:1200px){
      .duty-card{position:static; min-height:auto; margin-top:12px}
    }

    /* ===== ØªØ°ÙŠÙŠÙ„ ===== */
    .ft{position:fixed;bottom:0;left:0;right:0;z-index:70;background:linear-gradient(90deg,#0e9a92,#1a9c77);border-top:3px solid #0d5e49;color:#fff}
    .ft-inner{max-width:1500px;margin:0 auto;padding:8px 10px;display:flex;justify-content:center;align-items:center}
    .ft-brand{font-size:12px;opacity:.95;text-align:center}

    /* ÙˆÙ…Ø¶Ø© ØªÙ†Ø¨ÙŠÙ‡ Ù„Ù„Ø­Ù‚Ù„ Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ù†ØªØ¸Ø± */
    @keyframes blinkBorder { 0%{box-shadow:0 0 0 0 rgba(24,162,126,.0)} 50%{box-shadow:0 0 0 3px rgba(24,162,126,.25)} 100%{box-shadow:0 0 0 0 rgba(24,162,126,.0)} }
    .pulse-once{animation:blinkBorder .9s ease}
  </style>
</head>
<body>
  <header>
    <div class="h-wrap">
      <div class="h-row">
        <div class="title">Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© â€” Ø¹Ø±Ø¶ Ù„Ø­Ø¸ÙŠ</div>
        <div class="clock" id="clock">--:--:--</div>
      </div>
      <div class="dateweek" id="dateWeek">â€”</div>
    </div>
  </header>

  <!-- Ù…ÙØ¯Ø®Ù„Ø§Øª Ù…Ù„ÙØ§Øª -->
  <input type="file" id="fileTable" accept=".xlsx,.xls,.xlsb,.csv" hidden>
  <input type="file" id="filePhonebook" accept=".xlsx,.xls,.xlsb,.csv" hidden>
  <input type="file" id="snapshotIn" accept=".json" hidden>

  <main>
    <!-- Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª -->
    <section class="hero" id="hero">
      <div class="iconbar">
        <!-- Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ -->
        <div class="ib" id="btnImport" title="Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù… (Excel/CSV)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></svg>
          <div class="menu" id="menuImport">
            <h4>Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¹Ø§Ù… â€” Ù…Ø·Ø§Ø¨Ù‚Ø© Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ©</h4>
            <div class="row"><button id="pickTable" class="btn-ghost">Ø§Ø®ØªØ± Ù…Ù„Ù Excel/CSV</button></div>
            <small style="color:#0b4035">Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ Ø£ÙŠØ§Ù…ØŒ Ø§Ù„ØµÙ Ø§Ù„Ø«Ø§Ù†ÙŠ Ø§Ù„Ø­ØµØµ (Ù¡â€“Ù§)ØŒ Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆÙ„ Ø§Ù„Ø´Ø¹Ø¨Ø©ØŒ ÙˆÙƒÙ„ Ø®Ù„ÙŠØ© (Ù…Ø§Ø¯Ø©/Ù…Ø¹Ù„Ù…) Ø£Ùˆ (Ù…Ø§Ø¯Ø©\nÙ…Ø¹Ù„Ù…).</small>
          </div>
        </div>

        <!-- Ù…ÙˆØ§Ù‚ÙŠØª ØµÙŠÙÙŠ/Ø´ØªÙˆÙŠ -->
        <div class="ib" id="btnTimes" title="Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„Ø­ØµØµ â€” ØµÙŠÙÙŠ/Ø´ØªÙˆÙŠ">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          <div class="menu" id="menuTimes">
            <h4>Ù…ÙˆØ§Ù‚ÙŠØª Ø§Ù„Ø­ØµØµ (ØµÙŠÙÙŠ/Ø´ØªÙˆÙŠ + ØªØ­Ø±ÙŠØ± ÙŠØ¯ÙˆÙŠ)</h4>
            <div class="row controls" style="grid-template-columns:1fr 1fr 1fr">
              <label>Ø§Ù„ÙˆØ¶Ø¹
               <select id="seasonMode">
  <option value="custom">Ù…Ø®ØµØµ</option>
  <option value="summer">ØµÙŠÙÙŠ</option>
  <option value="winter">Ø´ØªÙˆÙŠ</option>
  <option value="ramadan">Ø±Ù…Ø¶Ø§Ù†</option>
</select>
              </label>
              <button id="applySeason" class="btn-ghost" style="align-self:end">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙˆØ¶Ø¹</button>
              <button id="saveTimes" class="btn-ghost" style="align-self:end">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª</button>
            </div>
            <div class="row times-grid" style="grid-template-columns:repeat(2,minmax(140px,1fr));gap:6px">
              <label>Ø§Ù„Ø§ØµØ·ÙØ§Ù (Ø¨Ø¯Ø¡)<input type="time" id="t_assm_s"></label>
              <label>Ø§Ù„Ø§ØµØ·ÙØ§Ù (Ù†Ù‡Ø§ÙŠØ©)<input type="time" id="t_assm_e"></label>
              <label>Ø§Ù„Ø­ØµØ© 1 (Ø¨Ø¯Ø¡)<input type="time" id="t_p1_s"></label>
              <label>Ø§Ù„Ø­ØµØ© 1 (Ù†Ù‡Ø§ÙŠØ©)<input type="time" id="t_p1_e"></label>
              <label>Ø§Ù„Ø­ØµØ© 2 (Ø¨Ø¯Ø¡)<input type="time" id="t_p2_s"></label>
              <label>Ø§Ù„Ø­ØµØ© 2 (Ù†Ù‡Ø§ÙŠØ©)<input type="time" id="t_p2_e"></label>
              <label>Ø§Ù„Ø­ØµØ© 3 (Ø¨Ø¯Ø¡)<input type="time" id="t_p3_s"></label>
              <label>Ø§Ù„Ø­ØµØ© 3 (Ù†Ù‡Ø§ÙŠØ©)<input type="time" id="t_p3_e"></label>
              <label>Ø§Ù„ÙØ³Ø­Ø© (Ø¨Ø¯Ø¡)<input type="time" id="t_break_s"></label>
              <label>Ø§Ù„ÙØ³Ø­Ø© (Ù†Ù‡Ø§ÙŠØ©)<input type="time" id="t_break_e"></label>
              <label>Ø§Ù„Ø­ØµØ© 4 (Ø¨Ø¯Ø¡)<input type="time" id="t_p4_s"></label>
              <label>Ø§Ù„Ø­ØµØ© 4 (Ù†Ù‡Ø§ÙŠØ©)<input type="time" id="t_p4_e"></label>
              <label>Ø§Ù„Ø­ØµØ© 5 (Ø¨Ø¯Ø¡)<input type="time" id="t_p5_s"></label>
              <label>Ø§Ù„Ø­ØµØ© 5 (Ù†Ù‡Ø§ÙŠØ©)<input type="time" id="t_p5_e"></label>
              <label>Ø§Ù„Ø³Ø§Ø¯Ø³Ø© (Ø¨Ø¯Ø¡)<input type="time" id="t_p6_s"></label>
              <label>Ø§Ù„Ø³Ø§Ø¯Ø³Ø© (Ù†Ù‡Ø§ÙŠØ©)<input type="time" id="t_p6_e"></label>
              <label>ÙØ§ØµÙ„ ØµÙ„Ø§Ø© (Ø¨Ø¯Ø¡)<input type="time" id="t_pr_s"></label>
              <label>ÙØ§ØµÙ„ ØµÙ„Ø§Ø© (Ù†Ù‡Ø§ÙŠØ©)<input type="time" id="t_pr_e"></label>
              <label>Ø§Ù„Ø³Ø§Ø¨Ø¹Ø© (Ø¨Ø¯Ø¡)<input type="time" id="t_p7_s"></label>
              <label>Ø§Ù„Ø³Ø§Ø¨Ø¹Ø© (Ù†Ù‡Ø§ÙŠØ©)<input type="time" id="t_p7_e"></label>
            </div>
          </div>
        </div>

        <!-- ÙˆØ§ØªØ³Ø§Ø¨ + Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† -->
        <div class="ib" id="btnWA" title="ÙˆØ§ØªØ³Ø§Ø¨: Ø¯ÙØªØ± Ø§Ù„Ù‡ÙˆØ§ØªÙ + Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…ÙŠÙ†">
          <svg viewBox="0 0 24 24" fill="currentColor"><path d="M20.52 3.48A11.94 11.94 0 0 0 12.06 0C5.4 0 0 5.4 0 12.06c0 2.12.56 4.16 1.62 5.96L0 24l6.16-1.6a12.02 12.02 0 0 0 5.9 1.54h.01c6.66 0 12.06-5.4 12.06-12.06 0-3.23-1.26-6.26-3.48-8.48Zm-8.46 18.04h-.01a10.3 10.3 0 0 1-5.24-1.44l-.38-.22-3.66.95.98-3.56-.25-.37a10.31 10.31 0 1 1 8.56 4.64ZM17 14.2c-.28-.14-1.64-.8-1.9-.9-.26-.1-.45-.14-.64.14-.19.28-.73.9-.9 1.08-.17.19-.33.21-.61.07-.28-.14-1.18-.44-2.26-1.4-.84-.75-1.41-1.68-1.57-1.96-.17-.28-.02-.43.12-.57.12-.12.28-.33.42-.49.14-.16.19-.28.28-.47.09-.19.05-.35-.02-.49-.07-.14-.64-1.55-.88-2.12-.23-.56-.47-.48-.64-.49-.16-.01-.35-.01-.54-.01-.19 0-.49.07-.75.35-.26.28-1 1-1 2.43 0 1.43 1.02 2.81 1.16 3 .14.19 2 3.05 4.85 4.28.68.29 1.21.46 1.62.58.68.22 1.3.19 1.79.12.55-.08 1.64-.67 1.87-1.32.23-.65.23-1.21.16-1.32-.07-.11-.26-.18-.54-.32Z"/></svg>
          <div class="menu" id="menuWA">
            <h4>Ø¯ÙØªØ± Ù‡ÙˆØ§ØªÙ Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…ÙŠÙ† + Ø§Ø³ØªØ¹Ø±Ø§Ø¶ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡</h4>
            <div class="row" style="grid-template-columns:1fr auto">
              <button id="pickPhonebook" class="btn-ghost">Ø§Ø³ØªÙŠØ±Ø§Ø¯ (Ø§Ù„Ø§Ø³Ù…/Ø§Ù„Ø¬ÙˆØ§Ù„/Ø§Ù„Ù‡ÙˆÙŠØ©/Ø§Ù„ØªØ®ØµØµ)</button>
              <button id="waShowAll" class="btn-ghost">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</button>
            </div>
            <div class="row" style="grid-template-columns:1fr auto">
              <input id="waSearch" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ØªØ®ØµØµ Ø£Ùˆ Ø§Ù„Ø±Ù‚Ù…">
              <span id="waCount" class="btn-ghost" style="pointer-events:none">0 Ù…Ø¹Ù„Ù‘Ù…</span>
            </div>
            <div id="waList" class="tlist"></div>
          </div>
        </div>

        <!-- Ø³Ø­Ø§Ø¨Ø© -->
        <div class="ib" id="btnCloud" title="Ø­ÙØ¸/Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (JSON)">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 17.58A5 5 0 0 0 18 8h-1.26A8 8 0 1 0 4 16.25"/><path d="M16 16l-4 4-4-4"/><path d="M12 20V10"/></svg>
          <div class="menu" id="menuCloud">
            <h4>Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©</h4>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="btn-ghost" id="saveSnapshot">Ø­ÙØ¸ Ù…Ù„Ù Ø¨ÙŠØ§Ù†Ø§Øª (JSON)</button>
              <button class="btn-ghost" id="loadSnapshot">Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ù…Ù† Ù…Ù„Ù</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Ø±ÙÙ‘ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… -->
      <div class="menus-shelf">
        <div class="menus-shelf-inner" id="menusShelf"></div>
      </div>
    </section>

    <!-- Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³Ø© -->
    <section class="card">
      <div class="board">
        <!-- Ù„ÙˆØ­Ø§Øª Ø§Ù„Ø´Ø¹Ø¨ -->
        <div id="classesBoard">
          <div id="wrap_first" class="band-wrap">
            <div class="bandTitle first"><span class="dot"></span> Ø£ÙˆÙ„ Ø«Ø§Ù†ÙˆÙŠ (Ù§ Ø´Ø¹Ø¨)</div>
            <div class="band first" id="band_first"></div>
          </div>

          <div id="wrap_second" class="band-wrap">
            <div class="bandTitle second"><span class="dot"></span> Ø«Ø§Ù†ÙŠ Ø«Ø§Ù†ÙˆÙŠ (Ù¥ Ø´Ø¹Ø¨)</div>
            <div class="band second" id="band_second"></div>
          </div>

          <div id="wrap_third" class="band-wrap">
            <div class="bandTitle third"><span class="dot"></span> Ø«Ø§Ù„Ø« Ø«Ø§Ù†ÙˆÙŠ (Ù¥ Ø´Ø¹Ø¨)</div>
            <div class="band third" id="band_third"></div>
          </div>
        </div>

        <!-- Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©/Ø§Ù„Ø¥Ø´Ø±Ø§Ù -->
        <aside id="dutyPanel" class="duty-card">
          <div class="duty-title">Ø§Ù„Ù…Ù†Ø§ÙˆØ¨ÙˆÙ† ÙˆØ§Ù„Ù…Ø´Ø±ÙÙˆÙ† Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ…</div>
          <div style="margin-bottom:6px"><span id="phaseLabel" class="phase-pill">â€”</span></div>

          <div class="duty-tools">
            <button class="btn-ghost" id="dutySuggest">Ø§Ù‚ØªØ±Ø§Ø­ Ù§ Ø£Ø³Ù…Ø§Ø¡</button>
            <button class="btn-ghost" id="dutySave">Ø­ÙØ¸</button>
            <button class="btn-ghost" id="dutyClear">Ù…Ø³Ø­</button>
          </div>

          <div id="dutyList"></div>

          <ul class="duty-guide" id="dutyGuide">
            <li>Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø§Ø¨ÙˆØ±: Ø¨ÙˆØ§Ø¨Ø§Øª â†’ Ø·Ø§Ø¨ÙˆØ± â†’ ØªØ£Ø®Ø±.</li>
            <li>Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø­ØµØµ: ØªÙØ±ÙŠØº Ø§Ù„Ø³Ø§Ø­Ø© â†’ Ù…Ù†Ø¹ ØªØ¬Ù…Ø¹.</li>
            <li>Ø¨ÙŠÙ† Ø§Ù„Ø­ØµØµ: Ø¬ÙˆÙ„Ø§Øª Ø§Ù„Ù…Ù…Ø±Ø§Øª â†’ Ù…Ù†Ø¹ Ø®Ø±ÙˆØ¬.</li>
            <li>Ø§Ù„ÙØ³Ø­Ø©: ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø­Ø±ÙƒØ© â†’ Ù…Ù†Ø¹ Ù…Ø®Ø§Ù„ÙØ©.</li>
            <li>Ø§Ù„ØµÙ„Ø§Ø©: Ø§ØµØ·ÙØ§Ù Ù‡Ø§Ø¯Ø¦ â†’ Ø§Ù†Ø¶Ø¨Ø§Ø·.</li>
            <li>Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ§Ù…: ØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ù…Ø®Ø§Ø±Ø¬ â†’ Ù…Ù†Ø¹ Ø±Ø¬ÙˆØ¹.</li>
          </ul>
        </aside>
      </div>
    </section>
  </main>

  <!-- ØªØ°ÙŠÙŠÙ„ -->
  <footer class="ft">
    <div class="ft-inner">
      <div class="ft-brand">Ù…Ø¨Ø§Ø¯Ø±Ø© Ø§Ù„ÙŠØ¹Ù‚ÙˆØ¨ÙŠ Ø§Ù„Ø«Ø§Ù†ÙˆÙŠØ© â€” ØªÙ†ÙÙŠØ° ÙÙ‡Ø¯ Ø­Ø§Ù…Ø¯ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</div>
    </div>
  </footer>

  <!-- Ø¯Ù„Ø§Ø¦Ù„ Ø§Ø®ØªÙŠØ§Ø± -->
  <datalist id="teachersList"></datalist>
  <datalist id="classesList"></datalist>
  <datalist id="subjectsList"></datalist>

<script>
/* ===== Ø£Ø¯ÙˆØ§Øª Ø¹Ø§Ù…Ø© ===== */
const $ = s=>document.querySelector(s), $$ = s=>Array.from(document.querySelectorAll(s));
const ls = { get(k,d=null){try{return JSON.parse(localStorage.getItem(k))??d}catch{return d}}, set(k,v){localStorage.setItem(k,JSON.stringify(v))}, del(k){localStorage.removeItem(k)} };
function toArabicDigits(str){return String(str).replace(/[0-9]/g,d=>'Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©'[d]);}
function dayNameArabicFromDate(dt){return ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'][dt.getDay()]||'Ø§Ù„Ø£Ø­Ø¯'}
function fmtDate(d){const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),da=String(d.getDate()).padStart(2,'0');return `${da}/${m}/${y}`}
function normalizeSaudiPhone(raw){
  let p = String(raw||'').replace(/\D/g,'');
  if(!p) return '';
  if(p.startsWith('00966')) p = p.slice(2);       // 00966xxxxxxxxx -> 966xxxxxxxxx
  if(p.startsWith('05') && p.length === 10) p = '966' + p.slice(1);
  if(p.startsWith('5') && p.length === 9) p = '966' + p;
  return p;
}
function fmtHijri(d){try{return new Intl.DateTimeFormat('ar-SA-u-ca-islamic',{day:'2-digit',month:'long',year:'numeric'}).format(d)}catch{return fmtDate(d)}}

/* ===== Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª ===== */
const PRESET_SUMMER={
  assm_s:'06:45',assm_e:'07:00',
  p1_s:'07:00',p1_e:'07:50',
  p2_s:'07:50',p2_e:'08:40',
  p3_s:'08:40',p3_e:'09:30',
  break_s:'09:30',break_e:'09:55',
  p4_s:'09:55',p4_e:'10:45',
  p5_s:'10:45',p5_e:'11:35',
  p6_s:'11:35',p6_e:'12:25',
  pr_s:'12:25',pr_e:'12:40',
  p7_s:'12:40',p7_e:'13:30'
};

const PRESET_WINTER={
  assm_s:'07:00',assm_e:'07:15',
  p1_s:'07:15',p1_e:'08:05',
  p2_s:'08:05',p2_e:'08:55',
  p3_s:'08:55',p3_e:'09:45',
  break_s:'09:45',break_e:'10:10',
  p4_s:'10:10',p4_e:'11:00',
  p5_s:'11:00',p5_e:'11:50',
  p6_s:'11:50',p6_e:'12:40',
  pr_s:'12:40',pr_e:'12:55',
  p7_s:'12:55',p7_e:'13:45'
};

const PRESET_RAMADAN={
  // Ù„Ø§ Ø·Ø§Ø¨ÙˆØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ): Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­ØµØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ 09:30 Ø¨Ø§Ù„Ø¶Ø¨Ø·
  assm_s:'09:30',assm_e:'09:30',

  // Ø§Ù„Ø­ØµØµ (35 Ø¯Ù‚ÙŠÙ‚Ø©)
  p1_s:'09:30',p1_e:'10:05',
  p2_s:'10:05',p2_e:'10:40',
  p3_s:'10:40',p3_e:'11:15',
  p4_s:'11:15',p4_e:'11:50',

  // Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙØ³Ø­Ø©
  break_s:'00:00',break_e:'00:00',

  // ØµÙ„Ø§Ø© (30 Ø¯Ù‚ÙŠÙ‚Ø©) Ù‚Ø¨Ù„ Ø§Ù„Ø®Ø§Ù…Ø³Ø©
  pr_s:'11:50',pr_e:'12:20',

  // Ø¨Ø¹Ø¯ Ø§Ù„ØµÙ„Ø§Ø©: Ø®Ø§Ù…Ø³Ø©/Ø³Ø§Ø¯Ø³Ø©/Ø³Ø§Ø¨Ø¹Ø© (35 Ø¯Ù‚ÙŠÙ‚Ø©)
  p5_s:'12:20',p5_e:'12:55',
  p6_s:'12:55',p6_e:'13:30',
  p7_s:'13:30',p7_e:'14:05'
};

let TIMES = ls.get('smart_times', PRESET_SUMMER);

function setTimeInputs(){['assm_s','assm_e','p1_s','p1_e','p2_s','p2_e','p3_s','p3_e','break_s','break_e','p4_s','p4_e','p5_s','p5_e','p6_s','p6_e','pr_s','pr_e','p7_s','p7_e'].forEach(id=>{const el=$(`#t_${id}`); if(el) el.value=TIMES[id]||PRESET_SUMMER[id];});}
function saveTimesFromInputs(){['assm_s','assm_e','p1_s','p1_e','p2_s','p2_e','p3_s','p3_e','break_s','break_e','p4_s','p4_e','p5_s','p5_e','p6_s','p6_e','pr_s','pr_e','p7_s','p7_e'].forEach(id=>{const el=$(`#t_${id}`); if(el) TIMES[id]=el.value||PRESET_SUMMER[id];}); ls.set('smart_times',TIMES)}
function parseHM(str){const [h,m]=String(str||'').split(':').map(x=>parseInt(x)); return {h:h||0,m:m||0}}
function inRangeHM(now,s,e){const x=now.getHours()*60+now.getMinutes(), S=s.h*60+s.m, E=e.h*60+e.m; return x>=S && x<E}
function hmToMin(s){const [H,M]=String(s||'0:0').split(':').map(Number); return (H||0)*60+(M||0);}
function minToHM(min){
  min = Math.max(0, Math.round(min));
  const h = String(Math.floor(min/60)%24).padStart(2,'0');
  const m = String(min%60).padStart(2,'0');
  return `${h}:${m}`;
}

function minutesUntil(hm, now=new Date()){
  const [H,M] = String(hm||'0:0').split(':').map(Number);
  const target = new Date(now);
  target.setHours(H||0, M||0, 0, 0);
  return Math.max(0, Math.ceil((target - now)/60000));
}


/* ===== Ø§Ù„ÙÙˆØ§ØµÙ„ / Ø§Ù„Ø­ØµØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ===== */
function periodNameAr(n){return ['Ø§Ù„Ø£ÙˆÙ„Ù‰','Ø§Ù„Ø«Ø§Ù†ÙŠØ©','Ø§Ù„Ø«Ø§Ù„Ø«Ø©','Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©','Ø§Ù„Ø®Ø§Ù…Ø³Ø©','Ø§Ù„Ø³Ø§Ø¯Ø³Ø©','Ø§Ù„Ø³Ø§Ø¨Ø¹Ø©'][n-1]||''}
function timeRangeOfPeriod(n){const map={1:['p1_s','p1_e'],2:['p2_s','p2_e'],3:['p3_s','p3_e'],4:['p4_s','p4_e'],5:['p5_s','p5_e'],6:['p6_s','p6_e'],7:['p7_s','p7_e']}; const k=map[n]; if(!k) return ''; return `${TIMES[k[0]]}â€“${TIMES[k[1]]}`}
function currentSlot(dayName,now){
  const t=TIMES; 
  const P=n=>({kind:'period',period:n}); 
  const L=txt=>({kind:txt});

  const hasBreak  = hmToMin(t.break_e) > hmToMin(t.break_s);
  const hasPrayer = hmToMin(t.pr_e) > hmToMin(t.pr_s);
  const prayerBeforeP5 = hasPrayer && hmToMin(t.pr_s) < hmToMin(t.p5_s);

  // (Ø¥Ù† ÙƒØ§Ù† Ø§Ù„Ø§ØµØ·ÙØ§Ù = Ù†ÙØ³ Ø§Ù„ÙˆÙ‚ØªØŒ Ù„Ù† ÙŠØ¸Ù‡Ø±)
  if(inRangeHM(now,parseHM(t.assm_s),parseHM(t.assm_e))) return L('assembly');

  if(inRangeHM(now,parseHM(t.p1_s),parseHM(t.p1_e))) return P(1);
  if(inRangeHM(now,parseHM(t.p2_s),parseHM(t.p2_e))) return P(2);
  if(inRangeHM(now,parseHM(t.p3_s),parseHM(t.p3_e))) return P(3);

  if(hasBreak && inRangeHM(now,parseHM(t.break_s),parseHM(t.break_e))) return L('break');

  if(inRangeHM(now,parseHM(t.p4_s),parseHM(t.p4_e))) return P(4);

  // âœ… ØµÙ„Ø§Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø®Ø§Ù…Ø³Ø© (Ø±Ù…Ø¶Ø§Ù†)
  if(prayerBeforeP5 && inRangeHM(now,parseHM(t.pr_s),parseHM(t.pr_e))) return L('prayer');

  if(inRangeHM(now,parseHM(t.p5_s),parseHM(t.p5_e))) return P(5);
  if(inRangeHM(now,parseHM(t.p6_s),parseHM(t.p6_e))) return P(6);

  // âœ… ØµÙ„Ø§Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø³Ø§Ø¯Ø³Ø© (ØµÙŠÙÙŠ/Ø´ØªÙˆÙŠ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©)
  if(!prayerBeforeP5 && hasPrayer && inRangeHM(now,parseHM(t.pr_s),parseHM(t.pr_e))) return L('prayer');

  const isSunMon=(dayName==='Ø§Ù„Ø£Ø­Ø¯'||dayName==='Ø§Ù„Ø§Ø«Ù†ÙŠÙ†');
  if(isSunMon && inRangeHM(now,parseHM(t.p7_s),parseHM(t.p7_e))) return P(7);

  return L('dismiss');
}


/* ===== Ù„ÙˆØ­Ø§Øª Ø§Ù„Ø´Ø¹Ø¨ ===== */
const CLASSES={
  first:Array.from({length:7},(_,i)=>({grade:'Ø£ÙˆÙ„',section:String(i+1)})).map(x=>({...x,classId:`${x.grade}-${x.section}`})),
  second:Array.from({length:5},(_,i)=>({grade:'Ø«Ø§Ù†ÙŠ',section:String(i+1)})).map(x=>({...x,classId:`${x.grade}-${x.section}`})),
  third:Array.from({length:5},(_,i)=>({grade:'Ø«Ø§Ù„Ø«',section:String(i+1)})).map(x=>({...x,classId:`${x.grade}-${x.section}`}))
};
let TIMETABLE = ls.get('smart_timetable', []);
let TEACHERS  = ls.get('smart_teachers_list', []);
let SUBJECTS  = ls.get('smart_subjects_list', []);
let PHONEBOOK = ls.get('smart_phonebook', {}); // { name: {phone, id, spec} }
let ABSENCES  = ls.get('smart_absences', {});
let DAYS_LIST = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³'];

/* ÙŠØºÙ„Ù‚ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ù„Ø§Ø·Ø© Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ */
let LOCKED_TILE_ID = null;

function refreshDatalists(){
  const names = new Set([...(TEACHERS||[]), ...Object.keys(PHONEBOOK||{})]);
  $('#teachersList').innerHTML = [...names].sort().map(n=>`<option value="${n}">`).join('');
  $('#classesList').innerHTML = [].concat(
    CLASSES.first.map(x=>x.classId), CLASSES.second.map(x=>x.classId), CLASSES.third.map(x=>x.classId)
  ).map(v=>`<option value="${v}">`).join('');
  $('#subjectsList').innerHTML = (SUBJECTS||[]).map(n=>`<option value="${n}">`).join('');
}

/* Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ù…Ù†ØªØ¸Ø±ÙŠÙ† Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ (ÙŠØ¯Ø¹Ù…: Ø§Ù†ØªØ¸Ø§Ø±/Ø§Ø­ØªÙŠØ§Ø·) */
function currentWaiters(day, period){
  const rx=/Ø§Ù†ØªØ¸Ø§Ø±|Ø§Ø­ØªÙŠØ§Ø·/i;
  const W = TIMETABLE
    .filter(r=>r.day===day && Number(r.period)===Number(period) && rx.test(String(r.subject||'')) && r.teacher)
    .map(r=>({teacher:r.teacher, classId:r.classId}));
  const seen=new Set(); return W.filter(w=>{ if(seen.has(w.teacher)) return false; seen.add(w.teacher); return true; });
}

/* Ø±Ø³Ù… Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª + Ø§Ù„Ù…Ø¤Ø´Ø± */
function renderBands(){
  const mk=cls=>`<div class="tile" id="tile_${cls.classId}">
    <button class="abs-btn" data-class="${cls.classId}">ØºÙŠØ§Ø¨</button>
    <button class="edit-btn" data-class="${cls.classId}">ØªØ­Ø±ÙŠØ±</button>
    <div class="badge">${cls.grade} â€” Ø´Ø¹Ø¨Ø© ${toArabicDigits(cls.section)}</div>
    <div class="vstack">
      <div class="section">${cls.grade} ${toArabicDigits(cls.section)}</div>
      <div class="subject empty">â€”</div>
      <div class="teacher"></div>
      <div class="room"></div>
    </div>
    <div class="state"></div>
  </div>`;

  const firstTiles = CLASSES.first.map(mk).join('') + `
    <div class="mid-indicator" id="midIndicator">
      <div class="mid-card">
        <div class="mid-left">
          <div class="mid-title" id="mid-phase">â€”</div>
          <div class="mid-sub" id="mid-range">â€”</div>
        </div>
        <div class="bat">
          <div class="bat-shell"><div id="batFill" class="bat-fill"></div></div>
          <div class="bat-num"><span id="mid-num">--</span> Ø¯Ù‚ÙŠÙ‚Ø©</div>
        </div>
      </div>
    </div>`;
  $('#band_first').innerHTML=firstTiles;

  $('#band_second').innerHTML=CLASSES.second.map(mk).join('');
  $('#band_third').innerHTML=CLASSES.third.map(mk).join('');

  $$('.abs-btn').forEach(b=>b.onclick=()=>openAbsForm(b.dataset.class));
  $$('.edit-btn').forEach(b=>b.onclick=()=>openEditForm(b.dataset.class));
}

function findEntry(day,period,classId){return TIMETABLE.find(r=>r.day===day && Number(r.period)===Number(period) && r.classId===classId)}
function absKey(day,period,classId){return `${day}|${period}|${classId}`;}
function clearAbsence(day,period,classId){delete ABSENCES[absKey(day,period,classId)]; ls.set('smart_absences', ABSENCES); updateAll();}

/* ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ù„Ø§Ø·Ø§Øª */
function updateTiles(dayName,now){
  const slot=currentSlot(dayName,now);
  const classes=[...CLASSES.first,...CLASSES.second,...CLASSES.third];
  classes.forEach(cls=>{
    const tile=$(`#tile_${cls.classId}`); if(!tile) return;

    if(LOCKED_TILE_ID===cls.classId && (tile.querySelector('.abs-form') || tile.querySelector('.edit-form'))){
      if(slot.kind==='period') tile.classList.add('now'); else tile.classList.remove('now');
      return;
    }

    const subEl=tile.querySelector('.subject'), tEl=tile.querySelector('.teacher'), rEl=tile.querySelector('.room'), sEl=tile.querySelector('.state');
    tile.classList.remove('absent','now'); tile.querySelectorAll('.chip,.abs-form,.edit-form,.abs-clear').forEach(n=>n.remove());

    if(slot.kind==='period'){
      tile.classList.add('now');
      const ent=findEntry(dayName, slot.period, cls.classId);
      const ab=ABSENCES[absKey(dayName,slot.period,cls.classId)];
      if(ent){
        subEl.textContent=ent.subject||'â€”'; subEl.classList.remove('empty');
        tEl.textContent = ent.teacher ? `${ent.teacher}` : '';
      } else {
        subEl.textContent='â€” Ù„Ø§ Ø­ØµØ© â€”'; subEl.classList.add('empty'); tEl.textContent='';
      }
      sEl.textContent=`Ø§Ù„Ø­ØµØ© ${toArabicDigits(slot.period)} â€” ${timeRangeOfPeriod(slot.period)}`;

      if(ab){
        tile.classList.add('absent');
        const c1=document.createElement('div'); c1.className='chip'; c1.textContent=`ØºÙŠØ§Ø¨: ${ab.absent||'â€”'}`;
        const c2=document.createElement('div'); c2.className='chip'; c2.textContent=`Ø§Ù„ØªØºØ·ÙŠØ©: ${ab.cover||'â€”'}`;
        sEl.insertAdjacentElement('beforebegin', c1); sEl.insertAdjacentElement('beforebegin', c2);
        tEl.textContent = `ØºØ§Ø¦Ø¨: ${ab.absent||'â€”'} â€” Ø¨Ø¯ÙŠÙ„: ${ab.cover||'â€”'}`;
        const clr=document.createElement('button'); clr.className='abs-clear'; clr.textContent='Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØºÙŠØ§Ø¨';
        clr.onclick=()=>clearAbsence(dayName, slot.period, cls.classId);
        tile.appendChild(clr);
      }
    } else {
      const states={assembly:'ğŸ‘‹ Ø§Ù„Ø§ØµØ·ÙØ§Ù',break:'â˜•ï¸ ÙØ³Ø­Ø©',prayer:'ğŸ•Œ ØµÙ„Ø§Ø©',dismiss:'ğŸ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¯ÙˆØ§Ù…'};
      subEl.textContent=states[slot.kind]||'â€”'; subEl.classList.remove('empty'); tEl.textContent=''; sEl.textContent='';
    }
  });
}

/* ===== Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„ØºÙŠØ§Ø¨ Ù…Ø¹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¸Ø±ÙŠÙ† + ÙˆØ§ØªØ³Ø§Ø¨ ØªØ±Ø¨ÙˆÙŠ ===== */
function openAbsForm(classId){
  const now=new Date(); const day=dayNameArabicFromDate(now); const slot=currentSlot(day,now);
  if(slot.kind!=='period'){ return alert('Ù„ÙŠØ³Øª Ø¶Ù…Ù† ÙˆÙ‚Øª Ø­ØµØ©.'); }
  const period=slot.period; const tile=$(`#tile_${classId}`); if(!tile) return;
  tile.querySelectorAll('.abs-form').forEach(n=>n.remove());
  const ent=findEntry(day, period, classId) || {};
  const ab=ABSENCES[`${day}|${period}|${classId}`] || {absent:(ent.teacher||''), cover:''};

  const waitNow = currentWaiters(day, period);
  const allTeachers = (TEACHERS||[]).filter(Boolean).sort((a,b)=>a.localeCompare(b,'ar'));

  // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª: Ø§Ù„Ù…Ù†ØªØ¸Ø±ÙˆÙ† Ø§Ù„Ø¢Ù† + ÙƒÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† (Ø¨Ø¯ÙŠÙ„)
  let waitOpts = `<option value="">â€” Ø§Ø®ØªØ± Ù…Ù† Ø§Ù„Ù…Ù†ØªØ¸Ø±ÙŠÙ† â€”</option>`;
  if(waitNow.length){
    waitOpts += `<optgroup label="Ø§Ù„Ù…Ù†ØªØ¸Ø±ÙˆÙ† Ø§Ù„Ø¢Ù†">` +
      waitNow.map(w=>`<option value="${w.teacher}">${w.teacher} â€” ${w.classId}</option>`).join('') +
      `</optgroup>`;
  }
  waitOpts += `<optgroup label="ÙƒÙ„ Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…ÙŠÙ†">` +
    allTeachers.map(n=>`<option value="${n}">${n}</option>`).join('') +
    `</optgroup>`;

  const form=document.createElement('div'); form.className='abs-form';
  form.innerHTML=`<h5>ØºÙŠØ§Ø¨/ØªØºØ·ÙŠØ© â€” ${day} Ø§Ù„Ø­ØµØ© ${toArabicDigits(period)}</h5>
    <div class="row">
      <input id="af_abs_${classId}" list="teachersList" placeholder="Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„ØºØ§Ø¦Ø¨" value="${ab.absent||''}">
      <input id="af_cov_${classId}" list="teachersList" placeholder="Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…ÙƒÙ„Ù‘Ù Ø¨Ø§Ù„ØªØºØ·ÙŠØ©" value="${ab.cover||''}">
      <select id="af_wait_${classId}">${waitOpts}</select>
    </div>
    <div class="actions">
      <button class="mini" id="af_save_${classId}">Ø­ÙØ¸</button>
      <button class="mini" id="af_wa_${classId}">Ø¥Ø±Ø³Ø§Ù„ ÙˆØ§ØªØ³Ø§Ø¨</button>
      <button class="mini" id="af_cancel_${classId}">Ø¥Ù„ØºØ§Ø¡</button>
    </div>`;
  tile.appendChild(form);

  LOCKED_TILE_ID = classId;
  const closeForm=()=>{ form.remove(); LOCKED_TILE_ID=null; updateAll(); };

  const $abs = ()=>$('#af_abs_'+classId);
  const $cov = ()=>$('#af_cov_'+classId);
  const $sel = ()=>$('#af_wait_'+classId);

  $('#af_cancel_'+classId).onclick = closeForm;

  // Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†ØªØ¸Ø± (ØªØ¹Ù…Ù„ Ø¹Ù„Ù‰ change Ùˆ input Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¬ÙˆØ§Ù„)
  const applyWaiter=()=>{
    const v=$sel().value;
    if(v){
      $cov().value=v;
      $cov().classList.remove('pulse-once'); void $cov().offsetWidth; $cov().classList.add('pulse-once');
    }
  };
  $sel().addEventListener('change', applyWaiter);
  $sel().addEventListener('input', applyWaiter);

  $('#af_save_'+classId).onclick = ()=>{
    const absent=$abs().value.trim();
    const cover=$cov().value.trim();
    ABSENCES[`${day}|${period}|${classId}`]={absent,cover};
    ls.set('smart_absences', ABSENCES);
    if(absent && !TEACHERS.includes(absent)) TEACHERS.push(absent);
    if(cover && !TEACHERS.includes(cover)) TEACHERS.push(cover);
    ls.set('smart_teachers_list', TEACHERS);
    refreshDatalists();
    closeForm();
  };

  // ÙˆØ§ØªØ³Ø§Ø¨ ØªØ±Ø¨ÙˆÙŠ Ù„Ù„Ù…Ù†ØªØ¸Ø±/Ø§Ù„Ù…ÙƒÙ„Ù‘Ù
  $('#af_wa_'+classId).onclick = ()=>{
    const cover = $cov().value.trim();
    const absent = $abs().value.trim() || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
    if(!cover) return alert('Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ù„Ù… Ø§Ù„Ù…ÙƒÙ„Ù‘Ù Ø¨Ø§Ù„ØªØºØ·ÙŠØ© Ø£ÙˆÙ„Ù‹Ø§.');
    let phone = normalizeSaudiPhone((PHONEBOOK[cover]||{}).phone||'');
    if(!phone){
      const inp = prompt('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ù„Ù‘Ù….\nØ£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¨ØµÙŠØºØ© Ø¯ÙˆÙ„ÙŠØ© (Ù…Ø«Ø§Ù„ 9665XXXXXXXX):');
      if(!inp) return;
      phone = String(inp).replace(/[^0-9]/g,'');
      if(phone.length<9) return alert('Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­.');
      PHONEBOOK[cover] = {...(PHONEBOOK[cover]||{}), phone};
      ls.set('smart_phonebook', PHONEBOOK);
    }
    const tr = timeRangeOfPeriod(period);
    const msg=`Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… Ø£/ ${cover}
Ù†Ø°ÙƒÙ‘Ø±ÙƒÙ… Ø¨ØªÙƒÙ„ÙŠÙ ØªØºØ·ÙŠØ© Ø­ØµØ© ${periodNameAr(period)} (${tr})
Ù„ÙØµÙ„: ${classId}
Ø¨Ø¯Ù„Ø§Ù‹ Ø¹Ù† Ø§Ù„Ø²Ù…ÙŠÙ„: ${absent}.
Ù†Ø£Ù…Ù„ ØªÙØ¹ÙŠÙ„ Ø²Ù…Ù† Ø§Ù„Ø­ØµØ© ÙˆÙÙ‚ Ø®Ø·Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù…Ø¹ Ø¶Ø¨Ø· Ø§Ù„Ø§Ù†Ø¶Ø¨Ø§Ø· ÙˆØ§Ù„Ø³Ù„ÙˆÙƒ.
Ø´ÙƒØ±Ù‹Ø§ Ù„ØªØ¹Ø§ÙˆÙ†ÙƒÙ… ÙˆØ¬Ø²Ø§ÙƒÙ… Ø§Ù„Ù„Ù‡ Ø®ÙŠØ±Ù‹Ø§.`;
    const url=`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
    window.open(url,'_blank');
  };
}

function openEditForm(classId){
  const now=new Date(); const day=dayNameArabicFromDate(now); const slot=currentSlot(day,now);
  if(slot.kind!=='period'){ return alert('Ù„ÙŠØ³Øª Ø¶Ù…Ù† ÙˆÙ‚Øª Ø­ØµØ©.'); }
  const period=slot.period; const tile=$(`#tile_${classId}`); if(!tile) return;
  tile.querySelectorAll('.edit-form').forEach(n=>n.remove());
  const ent=findEntry(day, period, classId) || {day,period,classId,subject:'',teacher:'',room:''};
  const form=document.createElement('div'); form.className='edit-form';
  form.innerHTML=`<h5>ØªØ­Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ø¯Ø©/Ø§Ù„Ù…Ø¹Ù„Ù… â€” ${day} Ø§Ù„Ø­ØµØ© ${toArabicDigits(period)}</h5>
    <div class="row">
      <input id="ef_sub_${classId}" list="subjectsList" placeholder="Ø§Ù„Ù…Ø§Ø¯Ø©" value="${ent.subject||''}">
      <input id="ef_tch_${classId}" list="teachersList" placeholder="Ø§Ù„Ù…Ø¹Ù„Ù…" value="${ent.teacher||''}">
    </div>
    <div class="actions">
      <button class="mini" id="ef_save_${classId}">Ø­ÙØ¸</button>
      <button class="mini" id="ef_cancel_${classId}">Ø¥Ù„ØºØ§Ø¡</button>
    </div>`;
  tile.appendChild(form);

  LOCKED_TILE_ID = classId;
  const closeForm=()=>{ form.remove(); LOCKED_TILE_ID=null; updateAll(); };
  $('#ef_cancel_'+classId).onclick = closeForm;
  $('#ef_save_'+classId).onclick = ()=>{
    const subject=$('#ef_sub_'+classId).value.trim();
    const teacher=$('#ef_tch_'+classId).value.trim();
    const idx = TIMETABLE.findIndex(r=>r.day===day && r.period===period && r.classId===classId);
    if(idx>=0){ TIMETABLE[idx].subject=subject; TIMETABLE[idx].teacher=teacher; }
    else { TIMETABLE.push({day,period,classId,subject,teacher,room:''}); }
    ls.set('smart_timetable', TIMETABLE);
    if(subject && !SUBJECTS.includes(subject)){ SUBJECTS.push(subject); ls.set('smart_subjects_list', SUBJECTS); }
    if(teacher && !TEACHERS.includes(teacher)){ TEACHERS.push(teacher); ls.set('smart_teachers_list', TEACHERS); }
    refreshDatalists();
    closeForm();
  };
}

/* ===== Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©/Ø§Ù„Ø¥Ø´Ø±Ø§Ù ===== */
let DUTY_FIXED = ls.get('smart_duty_fixed', {});
function ensureDutyFixed(day){
  DUTY_FIXED[day] ||= {names: Array(7).fill('')};
  const arr = DUTY_FIXED[day].names;
  while(arr.length<7) arr.push('');
  if(arr.length>7) arr.length=7;
  return DUTY_FIXED[day];
}
function currentDutyPhase(now=new Date()){
  const m = now.getHours()*60 + now.getMinutes();

  const dayName = dayNameArabicFromDate(now);
  const isSunMon = (dayName==='Ø§Ù„Ø£Ø­Ø¯'||dayName==='Ø§Ù„Ø§Ø«Ù†ÙŠÙ†');

  const p1s = hmToMin(TIMES.p1_s);
  const assmS = hmToMin(TIMES.assm_s);

  // Ù…Ù†Ø§ÙˆØ¨Ø© ØµØ¨Ø§Ø­ÙŠØ©: 30 Ø¯Ù‚ÙŠÙ‚Ø© Ù‚Ø¨Ù„ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø­ØµØ© Ø§Ù„Ø£ÙˆÙ„Ù‰ (ÙŠØ¯Ø¹Ù… Ø±Ù…Ø¶Ø§Ù† ØªÙ„Ù‚Ø§Ø¦ÙŠÙ‹Ø§)
  const morningStart = Math.max(0, assmS - 30);
  const morningEnd   = p1s;

  const sBreak = hmToMin(TIMES.break_s), eBreak = hmToMin(TIMES.break_e);
  const hasBreak = eBreak > sBreak;

  const sPr = hmToMin(TIMES.pr_s), ePr = hmToMin(TIMES.pr_e);
  const hasPrayer = ePr > sPr;

  const lastEnd = isSunMon ? hmToMin(TIMES.p7_e) : hmToMin(TIMES.p6_e);
  const depEnd  = lastEnd + 15;

  if(m>=morningStart && m<morningEnd) 
    return {key:'morning', label:'Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© Ø§Ù„ØµØ¨Ø§Ø­ÙŠØ©', start:minToHM(morningStart), end:TIMES.p1_s};

  if(hasBreak && m>=sBreak && m<eBreak) 
    return {key:'break', label:'Ø¥Ø´Ø±Ø§Ù Ø§Ù„ÙØ³Ø­Ø©', start:TIMES.break_s, end:TIMES.break_e};

  if(hasPrayer && m>=sPr && m<ePr) 
    return {key:'prayer', label:'Ø¥Ø´Ø±Ø§Ù ØµÙ„Ø§Ø© Ø§Ù„Ø¸Ù‡Ø±', start:TIMES.pr_s, end:TIMES.pr_e};

  if(m>=lastEnd && m<depEnd) 
    return {key:'afternoon', label:'Ù…Ù†Ø§ÙˆØ¨Ø© Ø§Ù„Ø§Ù†ØµØ±Ø§Ù', start:isSunMon?TIMES.p7_e:TIMES.p6_e, end:minToHM(depEnd)};

  return {key:'other', label:'â€”', start:'', end:''};
}

function setDutyPhaseLabel(){
  const ph = currentDutyPhase(new Date());
  $('#phaseLabel').textContent = `${ph.label} ${ph.start && ph.end ? `(${ph.start}â€“${ph.end})` : ''}`;
}
function renderDutyPanel(day){
  const state = ensureDutyFixed(day);
  setDutyPhaseLabel();

  const rows = state.names.map((name,idx)=>`
    <div class="duty-row" data-idx="${idx}" draggable="true">
      <div class="drag-handle">â ¿</div>
      <div class="duty-name">
        <input list="teachersList" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…" value="${name||''}">
      </div>
      <div class="duty-actions">
        <button class="mini" data-wa="${idx}">ÙˆØ§ØªØ³Ø§Ø¨</button>
        <button class="mini" data-clr="${idx}">âœ•</button>
      </div>
    </div>
  `).join('');
  $('#dutyList').innerHTML = rows;

  $$('#dutyList .duty-row input').forEach(inp=>{
    inp.onchange = ()=>{
      const idx = parseInt(inp.closest('.duty-row').dataset.idx);
      state.names[idx] = inp.value.trim();
      ls.set('smart_duty_fixed', DUTY_FIXED);
      if(inp.value && !TEACHERS.includes(inp.value)){ TEACHERS.push(inp.value); ls.set('smart_teachers_list', TEACHERS); refreshDatalists(); }
    };
  });

  let dragIndex=null;
  $$('#dutyList .duty-row').forEach(row=>{
    row.addEventListener('dragstart', e=>{ dragIndex=parseInt(row.dataset.idx); row.classList.add('dragging'); });
    row.addEventListener('dragend',   e=>{ dragIndex=null; row.classList.remove('dragging'); });
    row.addEventListener('dragover',  e=>e.preventDefault());
    row.addEventListener('drop',      e=>{
      e.preventDefault();
      const toIdx=parseInt(row.dataset.idx);
      if(dragIndex===null || dragIndex===toIdx) return;
      const st = ensureDutyFixed(day);
      const [moved]=st.names.splice(dragIndex,1);
      st.names.splice(toIdx,0,moved);
      ls.set('smart_duty_fixed', DUTY_FIXED);
      renderDutyPanel(day);
    });
  });

  $$('#dutyList [data-clr]').forEach(btn=>btn.onclick=()=>{
    state.names[parseInt(btn.dataset.clr)]='';
    ls.set('smart_duty_fixed', DUTY_FIXED); renderDutyPanel(day);
  });

  $$('#dutyList [data-wa]').forEach(btn=>btn.onclick=()=>{
    const i=parseInt(btn.dataset.wa); const name=state.names[i];
    if(!name) return alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù‘Ù… Ø£ÙˆÙ„Ø§Ù‹.');
    let rec = PHONEBOOK[name] || {};
    let phone = normalizeSaudiPhone(rec.phone||'');
    if(!phone){
      const inp = prompt('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ù„Ù‘Ù….\nØ£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¨ØµÙŠØºØ© Ø¯ÙˆÙ„ÙŠØ© (Ù…Ø«Ø§Ù„ 9665XXXXXXXX):');
      if(!inp) return;
      const digits = String(inp).replace(/[^0-9]/g,'');
      if(digits.length<9){ alert('Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­.'); return; }
      phone = digits;
      PHONEBOOK[name] = {...rec, phone};
      ls.set('smart_phonebook', PHONEBOOK);
    }
    const now=new Date(); const dayName=dayNameArabicFromDate(now);
    const ph=currentDutyPhase(now);
    const msg=`Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ…
ØªØ°ÙƒÙŠØ± ØªÙƒÙ„ÙŠÙ Â«${ph.label}Â»
Ø§Ù„ÙŠÙˆÙ…: ${dayName} â€” ${fmtHijri(now)}
Ø§Ù„ÙØªØ±Ø©: ${ph.start || '-'} ${ph.end? 'Ø¥Ù„Ù‰ '+ph.end : ''}
Ø¬Ø²Ø§ÙƒÙ… Ø§Ù„Ù„Ù‡ Ø®ÙŠØ±Ù‹Ø§ Ø¹Ù„Ù‰ ØªØ¹Ø§ÙˆÙ†ÙƒÙ….`;
    const url=`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
    window.open(url,'_blank');
  });
}

/* ===== Ø§Ù„Ù…Ø¤Ø´Ø± Ø§Ù„Ù…ØªÙˆØ³Ø· ===== */
let _lastRem=null;
let _lastDutyDay = '';
let _lastDutyPhaseSig = '';

function updateDutyPanelSmart(now){
  const day = dayNameArabicFromDate(now);
  const ph = currentDutyPhase(now);
  const sig = `${ph.key}|${ph.start}|${ph.end}`;

  // Ø¥Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠÙƒØªØ¨ Ø¯Ø§Ø®Ù„ Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©: Ù„Ø§ Ù†Ø¹ÙŠØ¯ Ø§Ù„Ø±Ø³Ù…
  if (document.querySelector('#dutyPanel input:focus')) {
    setDutyPhaseLabel();
    return;
  }

  // Ø£ÙˆÙ„ Ù…Ø±Ø© Ø£Ùˆ ØªØºÙŠÙ‘Ø± Ø§Ù„ÙŠÙˆÙ… = Ø¥Ø¹Ø§Ø¯Ø© Ø±Ø³Ù… ÙƒØ§Ù…Ù„Ø©
  if (day !== _lastDutyDay) {
    renderDutyPanel(day);
    _lastDutyDay = day;
    _lastDutyPhaseSig = sig;
    return;
  }

  // ØªØºÙŠÙ‘Ø± Ø§Ù„Ù…Ø±Ø­Ù„Ø© ÙÙ‚Ø· = ÙŠÙƒÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
  if (sig !== _lastDutyPhaseSig) {
    setDutyPhaseLabel();
    _lastDutyPhaseSig = sig;
  }
}
function updateMidIndicator(dayName, now){
  const elPhase=$('#mid-phase'), elRange=$('#mid-range'), elFill=$('#batFill'), elNum=$('#mid-num');
  if(!(elPhase&&elRange&&elFill&&elNum)) return;
  const slot=currentSlot(dayName, now);
  if(slot.kind==='period'){
    const sKey=`p${slot.period}_s`, eKey=`p${slot.period}_e`;
    const startMin = hmToMin(TIMES[sKey]), endMin=hmToMin(TIMES[eKey]);
    const total = Math.max(1, endMin-startMin);
    const rem = minutesUntil(TIMES[eKey], now);
    const gone = total - rem; const pct = Math.max(0, Math.min(100, Math.round(gone*100/total)));
    elPhase.textContent = `Ø§Ù„Ø­ØµØ© ${periodNameAr(slot.period)}`;
    elRange.textContent = `${TIMES[sKey]}â€“${TIMES[eKey]}`;
    elFill.style.width = pct + '%';
    const hue = Math.max(0, Math.min(120, Math.round(120 * (rem/total))));
    elFill.style.background = `linear-gradient(90deg,hsl(${Math.max(hue-20,0)},75%,60%),hsl(${hue},70%,48%))`;
    if(_lastRem===null || _lastRem!==rem){ elNum.classList.remove('flip'); void elNum.offsetWidth; elNum.classList.add('flip'); _lastRem=rem; }
    elNum.textContent = String(rem);
  }else{
    const map={assembly:'ğŸ‘‹ Ø§Ù„Ø§ØµØ·ÙØ§Ù',break:'â˜•ï¸ ÙØ³Ø­Ø©',prayer:'ğŸ•Œ ØµÙ„Ø§Ø©',dismiss:'ğŸ Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¯ÙˆØ§Ù…'};
    elPhase.textContent = map[slot.kind]||'â€”';
    elRange.textContent = 'â€”';
    elFill.style.width = '0%';
    elNum.textContent='--';
    _lastRem=null;
  }
}

/* ===== Ù…Ø­Ø§Ø°Ø§Ø© Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© ===== */
function alignDutyPanelToBands(){
  const board=$('.board'), first=$('#wrap_first'), third=$('#wrap_third'), panel=$('#dutyPanel');
  if(!(board && first && third && panel)) return;
  const br = board.getBoundingClientRect();
  const rStartTile = $('#tile_Ø£ÙˆÙ„-5')?.getBoundingClientRect() || first.getBoundingClientRect();
  const r3 = third.getBoundingClientRect();
  const topOffset = rStartTile.top - br.top;
  const minH = (r3.top + r3.height) - rStartTile.top;
  panel.style.alignSelf='start';
  panel.style.marginTop = `${Math.max(0, Math.round(topOffset))}px`;
  panel.style.minHeight = `${Math.max(360, Math.round(minH))}px`;
}

/* ===== Excel: Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ ===== */
function readWorkbookSmart(file, cb){
  const ext=(file.name.split('.').pop()||'').toLowerCase();
  const reader=new FileReader();
  reader.onerror=()=>alert('ØªØ¹Ø°Ù‘Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„Ù.');
  if(ext==='csv'){
    reader.onload=e=>{ try{
      let text=e.target.result;
      if((text.match(/;/g)||[]).length>(text.match(/,/g)||[]).length){ text=text.replace(/;/g,','); }
      const wb=XLSX.read(text,{type:'string'}); cb(wb);
    }catch(err){ console.error(err); alert('CSV ØºÙŠØ± ØµØ§Ù„Ø­.'); } };
    reader.readAsText(file,'utf-8');
  } else {
    reader.onload=e=>{ try{ const data=new Uint8Array(e.target.result); const wb=XLSX.read(data,{type:'array'}); cb(wb); }catch(err){ console.error(err); alert('Ù…Ù„Ù Excel ØºÙŠØ± ØµØ§Ù„Ø­.'); } };
    reader.readAsArrayBuffer(file);
  }
}
function cell(ws, r, c){ return ws[XLSX.utils.encode_cell({r,c})]?.v ?? ''; }
function sheetSize(ws){ const ref=ws['!ref']; if(!ref) return {R:0,C:0,range:null}; const range=XLSX.utils.decode_range(ref); return {R:range.e.r+1, C:range.e.c+1, range}; }

const DAY_CANON={'Ø§Ù„Ø£Ø­Ø¯':'Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø­Ø¯':'Ø§Ù„Ø£Ø­Ø¯','Ø£Ø­Ø¯':'Ø§Ù„Ø£Ø­Ø¯','Ø§Ø­Ø¯':'Ø§Ù„Ø£Ø­Ø¯','sun':'Ø§Ù„Ø£Ø­Ø¯','sunday':'Ø§Ù„Ø£Ø­Ø¯',
  'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†':'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø¥Ø«Ù†ÙŠÙ†':'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ø«Ù†ÙŠÙ†':'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','mon':'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','monday':'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†',
  'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡':'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø«Ù„Ø§Ø«Ø§Ø¡':'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','tue':'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','tuesday':'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡',
  'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡':'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','wed':'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','wednesday':'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡',
  'Ø§Ù„Ø®Ù…ÙŠØ³':'Ø§Ù„Ø®Ù…ÙŠØ³','thu':'Ø§Ù„Ø®Ù…ÙŠØ³','thursday':'Ø§Ù„Ø®Ù…ÙŠØ³'};
function canonDay(v){ const s=String(v||'').trim(); const k=s.toLowerCase(); return DAY_CANON[k] || DAY_CANON[s] || ''; }
function looksPeriod(v){
  const s=String(v||'').trim();
  if(/^[1-7Ù¡-Ù§]$/.test(s)) return parseInt(s.replace(/[Ù¡-Ù§]/g,ch=>'1234567'['Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§'.indexOf(ch)]));
  const w=s.replace(/\s/g,'');
  const dict={'Ø§Ù„Ø£ÙˆÙ„Ù‰':1,'Ø§Ù„Ø§ÙˆÙ„Ù‰':1,'Ø§ÙˆÙ„Ù‰':1,'Ø§Ù„Ø«Ø§Ù†ÙŠØ©':2,'Ø§Ù„Ø«Ø§Ù„Ø«Ø©':3,'Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©':4,'Ø§Ù„Ø®Ø§Ù…Ø³Ø©':5,'Ø§Ù„Ø³Ø§Ø¯Ø³Ø©':6,'Ø§Ù„Ø³Ø§Ø¨Ø¹Ø©':7};
  return dict[w]||NaN;
}
function looksTimeRange(v){ const s=String(v||''); const m=s.match(/(\d{1,2}:\d{2}).*?(\d{1,2}:\d{2})/); return m? {start:m[1], end:m[2]} : null; }
function normalizeClassId(v){
  v=String(v||'').trim().replace(/[â€“â€”]/g,'-').replace(/\s*-\s*/g,'-').replace(/Ø§ÙˆÙ„/g,'Ø£ÙˆÙ„');
  const m=v.match(/(Ø£ÙˆÙ„|Ø«Ø§Ù†ÙŠ|Ø«Ø§Ù„Ø«)\s*-\s*([0-9Ù -Ù©]+)/);
  if(m){ const map='Ù Ù¡Ù¢Ù£Ù¤Ù¥Ù¦Ù§Ù¨Ù©', n=parseInt(String(m[2]).replace(/[Ù -Ù©]/g,ch=>String(map.indexOf(ch))),10); return `${m[1]}-${n}`; }
  const m2=v.match(/(Ø£ÙˆÙ„|Ø«Ø§Ù†ÙŠ|Ø«Ø§Ù„Ø«)\s*(?:-|\s)?\s*(Ø§Ù„Ø£ÙˆÙ„|Ø§Ù„Ø§ÙˆÙ„|Ø§ÙˆÙ„Ù‰|Ø§Ù„Ø£ÙˆÙ„Ù‰|Ø§Ù„Ø«Ø§Ù†ÙŠØ©|Ø§Ù„Ø«Ø§Ù„Ø«Ø©|Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©|Ø§Ù„Ø®Ø§Ù…Ø³Ø©|Ø§Ù„Ø³Ø§Ø¯Ø³Ø©|Ø§Ù„Ø³Ø§Ø¨Ø¹Ø©)/);
  const word2num={'Ø§Ù„Ø£ÙˆÙ„':1,'Ø§Ù„Ø§ÙˆÙ„':1,'Ø§ÙˆÙ„Ù‰':1,'Ø§Ù„Ø£ÙˆÙ„Ù‰':1,'Ø§Ù„Ø«Ø§Ù†ÙŠØ©':2,'Ø§Ù„Ø«Ø§Ù„Ø«Ø©':3,'Ø§Ù„Ø±Ø§Ø¨Ø¹Ø©':4,'Ø§Ù„Ø®Ø§Ù…Ø³Ø©':5,'Ø§Ù„Ø³Ø§Ø¯Ø³Ø©':6,'Ø§Ù„Ø³Ø§Ø¨Ø¹Ø©':7};
  if(m2){ return `${m2[1]}-${word2num[m2[2]]||''}`; }
  return v;
}
function looksTeacher(s){
  s=String(s||'').trim();
  if(!s) return false;
  if(/^(?:Ø£\.|Ø£\/|Ø£Ø³ØªØ§Ø°|Ù…Ø¹Ù„Ù…)/.test(s)) return true;
  if(/\s/.test(s) && !/[0-9]/.test(s) && s.length>=5) return true;
  return false;
}
function orderSubjectTeacher(a,b){ return (looksTeacher(a) && !looksTeacher(b)) ? {subject:b, teacher:a} : {subject:a, teacher:b}; }
function splitCellToSubjectTeacher(val){
  let s=String(val||'').trim();
  if(!s) return {subject:'', teacher:''};
  if(s.includes('\n')){
    const parts=s.split('\n').map(x=>x.trim()).filter(Boolean);
    if(parts.length>=2) return orderSubjectTeacher(parts[0], parts[1]);
    return {subject:parts[0], teacher:''};
  }
  const parts = s.split(/[-â€“â€”\/|ØŒ]/).map(x=>x.trim()).filter(Boolean);
  if(parts.length===2) return orderSubjectTeacher(parts[0], parts[1]);
  if(parts.length>2) return orderSubjectTeacher(parts[0], parts.slice(1).join(' '));
  return {subject:parts[0], teacher:''};
}
function buildTimetableFromSheet(ws){
  const {R,C}=sheetSize(ws);
  if(R<3 || C<3) throw new Error('ÙˆØ±Ù‚Ø© ØµØºÙŠØ±Ø© Ø¬Ø¯Ù‹Ø§');

  const dayByCol = Array(C).fill(''); let lastDay='';
  for(let c=1;c<C;c++){
    const d0 = canonDay(cell(ws,0,c)), d1 = canonDay(cell(ws,1,c));
    if(d0) lastDay = d0; else if(d1) lastDay = d1;
    dayByCol[c]=lastDay;
  }

  const perByCol = Array(C).fill(null); const timeByCol = Array(C).fill(null); let lastPer=1;
  for(let c=1;c<C;c++){
    const v1 = cell(ws,1,c), p=looksPeriod(v1), tr=looksTimeRange(v1);
    if(!dayByCol[c]){ perByCol[c]=null; continue; }
    if(!dayByCol[c-1] || dayByCol[c]!==dayByCol[c-1]) lastPer=1;
    if(!isNaN(p)){ perByCol[c]=p; lastPer=p; } else { perByCol[c]=lastPer; lastPer = Math.min(7,lastPer+1); }
    if(tr) timeByCol[c]=tr;
  }

  const trMap = {};
  for(let c=1;c<C;c++){ const p=perByCol[c], tr=timeByCol[c]; if(tr && p>=1 && p<=7) trMap[p]=tr; }
  if(Object.keys(trMap).length>=4){
    for(const k in trMap){ const n=parseInt(k,10); TIMES[`p${n}_s`]=trMap[k].start; TIMES[`p${n}_e`]=trMap[k].end; }
    ls.set('smart_times', TIMES); setTimeInputs();
  }

  const tt=[]; const foundTeachers = new Set(TEACHERS||[]); const foundSubjects = new Set(SUBJECTS||[]);
  for(let r=2;r<R;r++){
    const clsRaw = cell(ws,r,0); const classId = normalizeClassId(clsRaw);
    if(!classId || !/^(Ø£ÙˆÙ„|Ø«Ø§Ù†ÙŠ|Ø«Ø§Ù„Ø«)\-\d+$/.test(classId)) continue;
    for(let c=1;c<C;c++){
      const day = dayByCol[c]; const per = perByCol[c]; if(!day || !per) continue;
      const v = cell(ws,r,c);
      if(String(v||'').trim()==='') continue;
      const {subject,teacher} = splitCellToSubjectTeacher(v);
      tt.push({day, period:per, classId, subject, teacher, room:''});
      if(subject) foundSubjects.add(subject);
      if(teacher) foundTeachers.add(teacher);
    }
  }
  TEACHERS=[...foundTeachers]; SUBJECTS=[...foundSubjects];
  ls.set('smart_teachers_list', TEACHERS); ls.set('smart_subjects_list', SUBJECTS);
  return tt;
}

/* ===== Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ù‡Ø§ØªÙ/ÙˆØ§ØªØ³Ø§Ø¨ + Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† ===== */
function parsePhonebookSheet(ws){
  const {R,C}=sheetSize(ws);
  let headerMap = {name:0, phone:1, id:null, spec:null};
  const headerRow = Array.from({length:C},(_,c)=>String(cell(ws,0,c)||'').toLowerCase());
  const hasHeader = headerRow.some(x=>/Ø§Ù„Ø§Ø³Ù…|name/.test(x));
  if(hasHeader){
    headerMap = {name:null, phone:null, id:null, spec:null};
    headerRow.forEach((h,idx)=>{
  // Ø§Ù„Ù‡ÙˆÙŠØ© Ø£ÙˆÙ„Ø§Ù‹ (Ø­ØªÙ‰ Ù„Ø§ ØªÙÙ„ØªÙ‚Ø· Ø¶Ù…Ù† "Ø±Ù‚Ù…")
  if(headerMap.id===null && /(Ø±Ù‚Ù…\s*Ø§Ù„Ù‡ÙˆÙŠØ©|Ø§Ù„Ù‡ÙˆÙŠØ©|^id$)/.test(h)) headerMap.id=idx;

  // Ø§Ù„Ø¬ÙˆØ§Ù„/Ø§Ù„Ù‡Ø§ØªÙ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø§Ù„ØªÙ‚Ø§Ø· Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù‡ÙˆÙŠØ©)
  if(
    headerMap.phone===null &&
    /(Ø±Ù‚Ù…\s*Ø§Ù„Ø¬ÙˆØ§Ù„|Ø§Ù„Ø¬ÙˆØ§Ù„|Ø§Ù„Ù‡Ø§ØªÙ|phone|mobile)/.test(h) &&
    !/Ù‡ÙˆÙŠØ©/.test(h)
  ) headerMap.phone=idx;

  if(headerMap.name===null && /(Ø§Ù„Ø§Ø³Ù…|name)/.test(h)) headerMap.name=idx;
  if(headerMap.spec===null && /(Ø§Ù„ØªØ®ØµØµ|subject|Ø§Ù„Ù…Ø§Ø¯Ø©)/.test(h)) headerMap.spec=idx;
});
  }
  const startRow = hasHeader?1:0;
  const map={};
  for(let r=startRow;r<R;r++){
    const name = String(cell(ws,r,headerMap.name??0)||'').trim();
    let phone = String(cell(ws,r,headerMap.phone??1)||'').replace(/[^0-9]/g,'');
    const id    = headerMap.id!=null ? String(cell(ws,r,headerMap.id)||'').trim() : '';
    const spec  = headerMap.spec!=null ? String(cell(ws,r,headerMap.spec)||'').trim() : '';
    if(!name) continue;
    const rec = map[name] || {};
    if(phone) rec.phone = phone;
    if(id) rec.id = id;
    if(spec) rec.spec = spec;
    map[name]=rec;
  }
  return map;
}

/* ===== Ø­ÙØ¸/ØªØ­Ù…ÙŠÙ„ Ù„Ù‚Ø·Ø© ===== */
function makeSnapshot(){
  return {times:TIMES, timetable:TIMETABLE, teachers:TEACHERS, subjects:SUBJECTS, phonebook:PHONEBOOK, absences:ABSENCES, duty:DUTY_FIXED};
}
function applySnapshot(o){
  if(!o) return;
  TIMES=o.times||TIMES, TIMETABLE=o.timetable||TIMETABLE, TEACHERS=o.teachers||TEACHERS;
  SUBJECTS=o.subjects||SUBJECTS, PHONEBOOK=o.phonebook||PHONEBOOK, ABSENCES=o.absences||ABSENCES, DUTY_FIXED=o.duty||DUTY_FIXED;
  ls.set('smart_times',TIMES); ls.set('smart_timetable',TIMETABLE); ls.set('smart_teachers_list',TEACHERS);
  ls.set('smart_subjects_list',SUBJECTS); ls.set('smart_phonebook',PHONEBOOK); ls.set('smart_absences',ABSENCES); ls.set('smart_duty_fixed',DUTY_FIXED);
  refreshDatalists(); updateAll();
}

/* ===== Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… ØªØ­Øª Ø§Ù„Ø£Ø²Ø±Ø§Ø± (Ø±ÙÙ‘) ===== */
const MENU_MAP = {btnImport:'menuImport', btnTimes:'menuTimes', btnWA:'menuWA', btnCloud:'menuCloud'};
let OPEN_MENU_ID = null;

function closeAllMenus(){
  const shelf = $('#menusShelf');
  $$('.menu.open').forEach(m=>{
    m.classList.remove('open');
    m.style.removeProperty('--menu-offset');
    const home = m.dataset.homeId && $('#'+m.dataset.homeId);
    if(home) home.appendChild(m);
  });
  OPEN_MENU_ID = null;
  $('#hero').classList.remove('menu-open');
}
function toggleMenu(btnId){
  const menuId = MENU_MAP[btnId]; if(!menuId) return;
  const btn = $('#'+btnId); const menu = $('#'+menuId); const shelf=$('#menusShelf'); const hero=document.getElementById('hero');
  const isOpen = OPEN_MENU_ID===menuId;
  closeAllMenus();
  if(isOpen) return;

  if(!menu.dataset.homeId){ menu.dataset.homeId = menu.parentElement.id; }
  hero.classList.add('menu-open');
  shelf.appendChild(menu);
  menu.style.visibility='hidden';
  menu.classList.add('open');

  const heroRect = hero.getBoundingClientRect();
  const btnRect  = btn.getBoundingClientRect();
  const menuW    = menu.offsetWidth;
  let left = (btnRect.left + btnRect.width/2) - (menuW/2) - heroRect.left;
  left = Math.max(8, Math.min(heroRect.width - menuW - 8, left));
  menu.style.setProperty('--menu-offset', left+'px');
  menu.style.visibility='visible';

  OPEN_MENU_ID = menuId;

  if(menuId==='menuWA') renderTeacherDirectory($('#waSearch')?.value||'');
}
document.addEventListener('click', (e)=>{
  if(e.target.closest('.menu') || e.target.closest('.ib')) return;
  closeAllMenus();
});
window.addEventListener('resize', ()=>{ if(OPEN_MENU_ID){ const id = Object.keys(MENU_MAP).find(k=>MENU_MAP[k]===OPEN_MENU_ID); if(id) toggleMenu(id); }}, {passive:true});
let _alignTimer;
window.addEventListener('resize', ()=>{
  clearTimeout(_alignTimer);
  _alignTimer = setTimeout(()=>alignDutyPanelToBands(), 120);
}, {passive:true});/* ===== Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù‘Ù…ÙŠÙ† (Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§ØªØ³Ø§Ø¨) ===== */
function renderTeacherDirectory(filter=''){
  const list = $('#waList'); const ctn = $('#waCount'); if(!list||!ctn) return;
  const q = String(filter||'').trim().toLowerCase();
  const entries = Object.entries(PHONEBOOK||{}).map(([name,rec])=>({name, ...rec}));
  (TEACHERS||[]).forEach(n=>{ if(!entries.find(e=>e.name===n)) entries.push({name:n, phone:(PHONEBOOK[n]||{}).phone||'', id:(PHONEBOOK[n]||{}).id||'', spec:(PHONEBOOK[n]||{}).spec||''}); });
  const filtered = entries
    .filter(e=>{
      if(!q) return true;
      const hay = `${e.name} ${e.spec||''} ${e.id||''} ${e.phone||''}`.toLowerCase();
      return hay.includes(q);
    })
    .sort((a,b)=>a.name.localeCompare(b.name,'ar'));
  ctn.textContent = `${filtered.length} Ù…Ø¹Ù„Ù‘Ù…`;
  list.innerHTML = filtered.map(e=>{
    const phoneClean = String(e.phone||'').replace(/[^0-9]/g,'');
    const spec = e.spec? ` â€” ${e.spec}` : '';
    const sub = e.id? ` â€¢ ${e.id}` : '';
    return `<div class="trow">
      <div>
        <div class="tname">${e.name}</div>
        <div class="tmeta">${phoneClean || 'â€”'}${spec}${sub}</div>
      </div>
      <div><button class="wa-btn" data-wa-person="${e.name}">ÙˆØ§ØªØ³Ø§Ø¨</button></div>
    </div>`;
  }).join('');

  $$('#waList [data-wa-person]').forEach(btn=>{
    btn.onclick = ()=>{
      const name = btn.dataset.waPerson;
      const rec = PHONEBOOK[name]||{};
      let phone = normalizeSaudiPhone(rec.phone||'');
      if(!phone){
        const inp = prompt(`Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù„Ù€ "${name}".\nØ£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø¨ØµÙŠØºØ© Ø¯ÙˆÙ„ÙŠØ© (Ù…Ø«Ø§Ù„ 9665XXXXXXXX):`);
        if(!inp) return;
        phone = String(inp).replace(/[^0-9]/g,'');
        if(phone.length<9) return alert('Ø±Ù‚Ù… ØºÙŠØ± ØµØ§Ù„Ø­.');
        PHONEBOOK[name] = {...rec, phone};
        ls.set('smart_phonebook', PHONEBOOK);
        renderTeacherDirectory($('#waSearch').value||'');
      }
      const msg = `Ø§Ù„Ø³Ù„Ø§Ù… Ø¹Ù„ÙŠÙƒÙ… ${name}
ØªÙˆØ§ØµÙ„ Ù…Ù† Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©. Ø´ÙƒØ±Ù‹Ø§ Ù„ØªØ¹Ø§ÙˆÙ†ÙƒÙ… Ø§Ù„Ø¯Ø§Ø¦Ù….`;
      const url=`https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
      window.open(url,'_blank');
    };
  });
}

/* ===== Ø³Ø§Ø¹Ø© + ØªØ­Ø¯ÙŠØ«Ø§Øª ===== */
function updateClock(){
  const now=new Date();
  const hh=String(now.getHours()).padStart(2,'0');
  const mm=String(now.getMinutes()).padStart(2,'0');
  const ss=String(now.getSeconds()).padStart(2,'0');
  $('#clock').textContent = `${hh}:${mm}:${ss}`;
  const day=dayNameArabicFromDate(now);
  $('#dateWeek').textContent = `${day} â€¢ ${fmtHijri(now)} â€¢ ${fmtDate(now)}`;
  updateTiles(day, now);
  updateMidIndicator(day, now);

updateDutyPanelSmart(now);
}
function updateAll(){
  const now=new Date(); const day=dayNameArabicFromDate(now);
  _lastDutyDay = '';
  _lastDutyPhaseSig = '';
  renderBands();
  refreshDatalists();
  updateTiles(day, now);
  updateMidIndicator(day, now);
  renderDutyPanel(day);
  alignDutyPanelToBands();
}

/* ===== Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« ===== */
function bindUI(){
  Object.keys(MENU_MAP).forEach(btnId=>{
    const btn = $('#'+btnId); if(btn) btn.addEventListener('click', e=>{ e.stopPropagation(); toggleMenu(btnId); });
  });

  // Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„
  $('#pickTable').onclick = ()=>$('#fileTable').click();
  $('#fileTable').onchange = e=>{
    const f=e.target.files[0]; if(!f) return;
    readWorkbookSmart(f, wb=>{
      const ws = wb.Sheets[wb.SheetNames[0]];
      try{
        TIMETABLE = buildTimetableFromSheet(ws);
        ls.set('smart_timetable', TIMETABLE);
        refreshDatalists(); updateAll(); alert('ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ âœ”');
      }catch(err){ console.error(err); alert('ØªØ¹Ø°Ù‘Ø± ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙˆÙ„.'); }
    });
    e.target.value='';
  };

  // Ù…ÙˆØ§Ù‚ÙŠØª
  setTimeInputs();
 function updateTimesUIByMode(mode){
  const isRamadan = (mode==='ramadan');
  const bs = $('#t_break_s'), be = $('#t_break_e');
  if(bs && be){
    bs.disabled = isRamadan;
    be.disabled = isRamadan;
    bs.parentElement.style.opacity = isRamadan ? 0.55 : 1;
    be.parentElement.style.opacity = isRamadan ? 0.55 : 1;
  }
}

const savedMode = ls.get('smart_season_mode','custom');
if($('#seasonMode')) $('#seasonMode').value = savedMode;
updateTimesUIByMode(savedMode);

$('#seasonMode').addEventListener('change', e=>{
  updateTimesUIByMode(e.target.value);
});

$('#applySeason').onclick = ()=>{
  const m = $('#seasonMode').value;

  TIMES =
    (m==='summer')  ? {...PRESET_SUMMER}  :
    (m==='winter')  ? {...PRESET_WINTER}  :
    (m==='ramadan') ? {...PRESET_RAMADAN} :
    TIMES;

  ls.set('smart_season_mode', m);
  ls.set('smart_times', TIMES);
  setTimeInputs();
  updateTimesUIByMode(m);
  updateAll();
};

  $('#saveTimes').onclick = ()=>{ saveTimesFromInputs(); updateAll(); alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ§Ù‚ÙŠØª âœ”'); };

  // Ø¯Ù„ÙŠÙ„ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† â€” Ø§Ø³ØªÙŠØ±Ø§Ø¯ + Ø¨Ø­Ø« + Ø¹Ø±Ø¶
  $('#pickPhonebook').onclick = ()=>$('#filePhonebook').click();
  $('#filePhonebook').onchange = e=>{
    const f=e.target.files[0]; if(!f) return;
    readWorkbookSmart(f, wb=>{
      const ws = wb.Sheets[wb.SheetNames[0]];
      const add = parsePhonebookSheet(ws);
      PHONEBOOK = {...PHONEBOOK, ...add};
      const merged = new Set(TEACHERS||[]);
      Object.keys(add).forEach(n=>merged.add(n));
      TEACHERS = [...merged];
      ls.set('smart_phonebook', PHONEBOOK);
      ls.set('smart_teachers_list', TEACHERS);
      refreshDatalists();
      alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† âœ”');
      renderTeacherDirectory($('#waSearch')?.value||'');
    });
    e.target.value='';
  };
  $('#waSearch').addEventListener('input', e=>renderTeacherDirectory(e.target.value||''));
  $('#waShowAll').onclick = ()=>{ $('#waSearch').value=''; renderTeacherDirectory(''); };

  // Ø³Ø­Ø§Ø¨Ø©
  $('#saveSnapshot').onclick = ()=>{
    const blob = new Blob([JSON.stringify(makeSnapshot(),null,2)], {type:'application/json;charset=utf-8'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='yaqoobi_snapshot.json'; a.click(); URL.revokeObjectURL(a.href);
  };
  $('#loadSnapshot').onclick = ()=>$('#snapshotIn').click();
  $('#snapshotIn').onchange = e=>{
    const f=e.target.files[0]; if(!f) return;
    const r=new FileReader(); r.onload=ev=>{ try{ const o=JSON.parse(ev.target.result); applySnapshot(o); alert('ØªÙ… Ø§Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© âœ”'); }catch{ alert('Ù…Ù„Ù ØºÙŠØ± ØµØ§Ù„Ø­'); } };
    r.readAsText(f,'utf-8'); e.target.value='';
  };

  // Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø©
$('#dutySuggest').onclick = ()=>{
  const day = dayNameArabicFromDate(new Date());
  const state = ensureDutyFixed(day);

  const pool = [...new Set(TEACHERS.filter(Boolean))];
  if(!pool.length){
    alert('Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ø§Ø¦Ù…Ø© Ù…Ø¹Ù„Ù…ÙŠÙ†. Ø§Ø³ØªÙˆØ±Ø¯ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£Ùˆ Ø¯ÙØªØ± Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ† Ø£ÙˆÙ„Ù‹Ø§.');
    return;
  }

  // Ø®Ù„Ø· Fisher-Yates
  for(let i=pool.length-1; i>0; i--){
    const j = Math.floor(Math.random() * (i+1));
    [pool[i], pool[j]] = [pool[j], pool[i]];
  }

  state.names = Array.from({length:7}, (_,i)=> pool[i] || '');
  ls.set('smart_duty_fixed', DUTY_FIXED);
  renderDutyPanel(day);
};
  $('#dutySave').onclick=()=>{ ls.set('smart_duty_fixed', DUTY_FIXED); alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†Ø§ÙˆØ¨Ø© âœ”'); };
  $('#dutyClear').onclick=()=>{ const day=dayNameArabicFromDate(new Date()); ensureDutyFixed(day).names=Array(7).fill(''); ls.set('smart_duty_fixed', DUTY_FIXED); renderDutyPanel(day); };
}

/* ===== ØªØ´ØºÙŠÙ„ ===== */
bindUI();
renderBands();
refreshDatalists();
updateAll();
setInterval(updateClock, 1000);
</script>
</body>
</html>
